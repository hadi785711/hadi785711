<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="HK AI LAB - Professional AI-Powered Healthcare &amp; Research Platform">
    <meta name="author" content="HK AI LAB">
    <meta name="robots" content="index, follow">
    
    <!-- PWA Support -->
    <meta name="theme-color" content="#1890ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="HK AI LAB Pro">
    
    <!-- Favicon -->
    <link rel="icon" href="https://pfst.cf2.poecdn.net/base/image/deb2a5a6c79ba96963663d5a78a60900e1d410245600d0db6916bb6bc0efac79?w=1024&amp;h=768">
    
    <title>HK AI LAB Pro - AI-Powered Healthcare Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#e6f7ff',
                            100: '#bae7ff',
                            500: '#1890ff',
                            600: '#096dd9',
                            700: '#0050b3'
                        },
                        secondary: {
                            50: '#f6ffed',
                            100: '#d9f7be',
                            500: '#52c41a',
                            600: '#389e0d',
                            700: '#237804'
                        }
                    },
                    animation: {
                        'pulse-glow': 'pulse-glow 2s infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'matrix-rain': 'matrix-rain 3s infinite',
                    }
                }
            }
        }
    </script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1890ff 0%, #52c41a 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(93, 92, 222, 0.3);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 30px rgba(93, 92, 222, 0.6);
                transform: scale(1.05);
            }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        @keyframes matrix-rain {
            0% { opacity: 0; transform: translateY(-20px); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: translateY(20px); }
        }
        .typing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #999;
            animation: typing 1.4s infinite;
        }
        .typing-indicator:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        .ai-thinking {
            background: linear-gradient(45deg, #10b981, #3b82f6, #8b5cf6);
            background-size: 200% 200%;
            animation: ai-glow 2s infinite;
        }
        @keyframes ai-glow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .modal-overlay {
            backdrop-filter: blur(5px);
        }
    </style>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.bd4eeeb8e8e02052ee92.js"></script></head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">

    <!-- Dark mode detection -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <!-- AI Status Indicator -->
    <div id="aiStatus" class="fixed top-4 right-4 z-50 bg-green-500 text-white px-3 py-1 rounded-full text-xs flex items-center space-x-2 shadow-lg">
        <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
        <span>AI Ready</span>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4 relative overflow-hidden">
        <!-- Background Medical AI Image -->
        <div class="absolute inset-0 opacity-15 pointer-events-none">
            <div class="absolute inset-0 bg-gradient-to-br from-blue-900/20 to-green-900/20"></div>
            <img src="https://pfst.cf2.poecdn.net/base/image/deb2a5a6c79ba96963663d5a78a60900e1d410245600d0db6916bb6bc0efac79?w=1024&amp;h=768" alt="Medical AI Background" class="w-full h-full object-cover opacity-30 blur-sm scale-110 transform">
        </div>
        
        <!-- Additional shadow overlay for better contrast -->
        <div class="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-black/20 pointer-events-none"></div>
        
        <div class="bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8 w-full max-w-md relative overflow-hidden border border-white/20 dark:border-gray-600/30">
            <!-- Floating Elements -->
            <div class="absolute top-3 right-3 w-1.5 h-1.5 bg-blue-400 rounded-full animate-ping"></div>
            <div class="absolute bottom-3 left-3 w-1 h-1 bg-purple-400 rounded-full animate-bounce"></div>
            
            <div class="text-center mb-8 relative z-10">
                <!-- Logo -->
                <div class="w-20 h-20 mx-auto mb-4 rounded-xl overflow-hidden shadow-lg border-2 border-white dark:border-gray-600">
                    <img src="https://pfst.cf2.poecdn.net/base/image/deb2a5a6c79ba96963663d5a78a60900e1d410245600d0db6916bb6bc0efac79?w=1024&amp;h=768" alt="HK AI LAB Pro" class="w-full h-full object-cover">
                </div>
                
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">
                    HK AI LAB Pro
                </h1>
                <div class="h-1 w-20 bg-gradient-to-r from-blue-500 to-green-500 mx-auto rounded-full mb-3"></div>
                <p class="text-gray-600 dark:text-gray-300 mb-4">
                    Professional AI-Powered Healthcare Platform
                </p>
                
                <!-- Status Indicators -->
                <div class="flex items-center justify-center space-x-4 text-sm text-gray-500 dark:text-gray-400 mb-6">
                    <span class="flex items-center">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                        AI Systems Online
                    </span>
                    <span class="flex items-center">
                        <span class="w-2 h-2 bg-blue-500 rounded-full mr-2 animate-pulse"></span>
                        Secure Cloud
                    </span>
                </div>
                

            </div>
            
            <form id="loginForm" class="space-y-6 relative z-10">
                <div>
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                        <i class="fas fa-user mr-2 text-blue-500"></i>Username
                    </label>
                    <input type="text" id="username" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition-all" placeholder="Enter username" autocomplete="username" required="">
                </div>
                
                <div>
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                        <i class="fas fa-lock mr-2 text-blue-500"></i>Password
                    </label>
                    <div class="relative">
                        <input type="password" id="password" class="w-full px-4 py-3 pr-12 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition-all" placeholder="Enter password" autocomplete="current-password" required="">
                        <button type="button" id="togglePassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors focus:outline-none" onclick="togglePasswordVisibility()" tabindex="-1">
                            <i id="passwordIcon" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-all duration-200 hover:scale-105 shadow-lg">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    Access AI Platform
                </button>
                
                <div class="text-center">
                    <p class="text-xs text-gray-500 dark:text-gray-400">
                        <i class="fas fa-shield-alt mr-1 text-green-500"></i>
                        Secured by AI-Enhanced Authentication
                    </p>
                </div>
                
                <!-- Contact Support & Free Trial -->
                <div class="flex justify-center space-x-4 mt-4">
                    <button type="button" onclick="showContactModal()" class="inline-flex items-center text-xs text-gray-400 dark:text-gray-500 hover:text-blue-500 dark:hover:text-blue-400 transition-colors group">
                        <i class="fas fa-headset mr-2 text-blue-500 group-hover:animate-bounce"></i>
                        <span>Technical Support</span>
                    </button>
                    
                    <button type="button" onclick="showFreeTrialModal()" class="inline-flex items-center text-xs text-purple-400 dark:text-purple-500 hover:text-purple-600 dark:hover:text-purple-400 transition-colors group">
                        <i class="fas fa-rocket mr-2 text-purple-500 group-hover:animate-bounce"></i>
                        <span>Free Trial Request</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden min-h-screen">
        <!-- Header -->
        <header class="gradient-bg text-white p-4 shadow-lg sticky top-0 z-40">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg overflow-hidden border border-white border-opacity-30">
                        <img src="https://pfst.cf2.poecdn.net/base/image/deb2a5a6c79ba96963663d5a78a60900e1d410245600d0db6916bb6bc0efac79?w=1024&amp;h=768" alt="HK AI LAB Pro" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">HK AI LAB Pro</h1>
                        <p class="text-xs opacity-75">AI-Powered Healthcare Platform</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <div id="userProfilePhoto" class="w-12 h-12 rounded-xl border-2 border-white bg-white bg-opacity-20 flex items-center justify-center overflow-hidden cursor-pointer shadow-lg hover:shadow-xl transition-all hover:scale-105" onclick="showProfileSettings()" title="Professional Profile">
                            <span id="userInitials" class="text-white font-bold"></span>
                        </div>
                        <div class="text-right">
                            <div id="currentUser" class="font-semibold"></div>
                            <div id="userRole" class="text-xs opacity-75"></div>
                        </div>
                    </div>
                    <button onclick="showChangePassword()" class="bg-white bg-opacity-20 px-3 py-2 rounded-lg hover:bg-opacity-30 transition-all" title="Change Password">
                        <i class="fas fa-key mr-1"></i>Password
                    </button>
                    <button onclick="logout()" class="bg-white bg-opacity-20 px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white dark:bg-gray-800 shadow-md sticky top-16 z-30">
            <div class="container mx-auto">
                <div class="flex space-x-0 overflow-x-auto">
                    <button onclick="showModule('dashboard')" class="nav-btn px-6 py-4 text-sm font-medium border-b-2 border-primary-500 text-primary-600 whitespace-nowrap">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </button>
                    <button onclick="showModule('medical')" class="nav-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent hover:border-primary-500 whitespace-nowrap text-gray-600 dark:text-gray-300">
                        <i class="fas fa-heartbeat mr-2"></i>Medical AI
                    </button>
                    <button onclick="showModule('research')" class="nav-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent hover:border-primary-500 whitespace-nowrap text-gray-600 dark:text-gray-300">
                        <i class="fas fa-brain mr-2"></i>Research AI
                    </button>
                    <button onclick="showModule('finance')" class="nav-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent hover:border-primary-500 whitespace-nowrap text-gray-600 dark:text-gray-300">
                        <i class="fas fa-chart-line mr-2"></i>Finance AI
                    </button>
                    <button onclick="showModule('calculator')" class="nav-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent hover:border-primary-500 whitespace-nowrap text-gray-600 dark:text-gray-300">
                        <i class="fas fa-calculator mr-2"></i>Smart Calculator
                    </button>
                    <button id="adminTab" onclick="showModule('admin')" class="nav-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent hover:border-primary-500 whitespace-nowrap text-gray-600 dark:text-gray-300 hidden">
                        <i class="fas fa-users-cog mr-2"></i>Admin
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto p-4 min-h-screen">
            
            <!-- Dashboard Module -->
            <div id="dashboardModule" class="module">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Welcome Section -->
                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Welcome to HK AI LAB Pro</h2>
                                <p class="text-gray-600 dark:text-gray-300">Professional AI-Powered Healthcare &amp; Research Platform</p>
                                <div class="mt-4 flex items-center space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                    <span class="flex items-center">
                                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                                        AI Systems: Online
                                    </span>
                                    <span class="flex items-center">
                                        <span class="w-2 h-2 bg-blue-500 rounded-full mr-2 animate-pulse"></span>
                                        Cloud: Connected
                                    </span>
                                    <span class="flex items-center">
                                        <span class="w-2 h-2 bg-purple-500 rounded-full mr-2 animate-pulse"></span>
                                        Security: Active
                                    </span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500 dark:text-gray-400">Platform Status</div>
                                <div class="flex items-center space-x-2">
                                    <span class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></span>
                                    <span class="text-green-600 dark:text-green-400 text-sm font-medium">Fully Operational</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI Capabilities Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg text-center cursor-pointer hover:bg-red-100 dark:hover:bg-red-800 transition-colors" onclick="showModule('medical')">
                                <i class="fas fa-heartbeat text-3xl text-red-600 dark:text-red-400 mb-3"></i>
                                <h3 class="font-semibold text-red-800 dark:text-red-300">Medical AI</h3>
                                <p class="text-xs text-red-600 dark:text-red-400">Lab analysis &amp; diagnosis</p>
                            </div>
                            <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg text-center cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-800 transition-colors" onclick="showModule('research')">
                                <i class="fas fa-brain text-3xl text-blue-600 dark:text-blue-400 mb-3"></i>
                                <h3 class="font-semibold text-blue-800 dark:text-blue-300">Research AI</h3>
                                <p class="text-xs text-blue-600 dark:text-blue-400">Multi-language research</p>
                            </div>
                            <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg text-center cursor-pointer hover:bg-green-100 dark:hover:bg-green-800 transition-colors" onclick="showModule('finance')">
                                <i class="fas fa-chart-line text-3xl text-green-600 dark:text-green-400 mb-3"></i>
                                <h3 class="font-semibold text-green-800 dark:text-green-300">Finance AI</h3>
                                <p class="text-xs text-green-600 dark:text-green-400">Financial analysis</p>
                            </div>
                            <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg text-center cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-800 transition-colors" onclick="showModule('calculator')">
                                <i class="fas fa-calculator text-3xl text-purple-600 dark:text-purple-400 mb-3"></i>
                                <h3 class="font-semibold text-purple-800 dark:text-purple-300">Smart Calculator</h3>
                                <p class="text-xs text-purple-600 dark:text-purple-400">AI-powered calculations</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">
                            <i class="fas fa-rocket mr-2 text-primary-500"></i>Quick Actions
                        </h3>
                        <div class="space-y-3">
                            <button onclick="showModule('medical')" class="w-full text-left px-4 py-3 bg-red-50 dark:bg-red-900 text-red-700 dark:text-red-300 rounded-lg hover:bg-red-100 dark:hover:bg-red-800 transition-colors">
                                <i class="fas fa-upload mr-2"></i>Upload Medical Files
                            </button>
                            <button onclick="showModule('research')" class="w-full text-left px-4 py-3 bg-blue-50 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-800 transition-colors">
                                <i class="fas fa-search mr-2"></i>Start AI Research
                            </button>
                            <button onclick="showModule('finance')" class="w-full text-left px-4 py-3 bg-green-50 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-lg hover:bg-green-100 dark:hover:bg-green-800 transition-colors">
                                <i class="fas fa-chart-bar mr-2"></i>Analyze Finance Data
                            </button>
                            <button id="quickAdmin" onclick="showModule('admin')" class="w-full text-left px-4 py-3 bg-purple-50 dark:bg-purple-900 text-purple-700 dark:text-purple-300 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-800 transition-colors hidden">
                                <i class="fas fa-users-cog mr-2"></i>Manage Platform
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Platform Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 dark:text-gray-400 text-sm">AI Analyses Today</p>
                                <p class="text-2xl font-bold text-gray-800 dark:text-white" id="dailyAnalyses">247</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                                <i class="fas fa-brain text-blue-600 dark:text-blue-400 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 dark:text-gray-400 text-sm">Active Users</p>
                                <p class="text-2xl font-bold text-gray-800 dark:text-white" id="activeUsers">1,247</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                                <i class="fas fa-users text-green-600 dark:text-green-400 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 dark:text-gray-400 text-sm">Success Rate</p>
                                <p class="text-2xl font-bold text-gray-800 dark:text-white">99.2%</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                                <i class="fas fa-check-circle text-purple-600 dark:text-purple-400 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 dark:text-gray-400 text-sm">Response Time</p>
                                <p class="text-2xl font-bold text-gray-800 dark:text-white">1.2s</p>
                            </div>
                            <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900 rounded-lg flex items-center justify-center">
                                <i class="fas fa-bolt text-orange-600 dark:text-orange-400 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medical AI Module -->
            <div id="medicalModule" class="module hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-red-500 to-pink-600 text-white p-6">
                        <h2 class="text-3xl font-bold mb-2">
                            <i class="fas fa-heartbeat mr-3"></i>Medical AI Analysis
                        </h2>
                        <p class="opacity-90">Advanced AI-powered medical file analysis and diagnosis assistance</p>
                    </div>
                    
                    <div class="p-6">
                        <!-- Upload Area -->
                        <div class="mb-8">
                            <div class="border-2 border-dashed border-red-300 dark:border-red-600 rounded-xl p-8 text-center bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors">
                                <div class="mb-4">
                                    <i class="fas fa-cloud-upload-alt text-6xl text-red-500 mb-4"></i>
                                </div>
                                
                                <h3 class="text-2xl font-semibold text-gray-800 dark:text-white mb-2">
                                    Upload Medical Files
                                </h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-6">
                                    Support for lab results, X-rays, MRI, CT scans, blood tests, and more
                                </p>
                                
                                <input type="file" id="medicalFileInput" accept="*/*" class="hidden" onchange="handleMedicalFileUpload(event)">
                                
                                <button onclick="document.getElementById('medicalFileInput').click()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-4 rounded-xl font-semibold transition-colors inline-flex items-center text-lg">
                                    <i class="fas fa-upload mr-3"></i>
                                    Select Medical File
                                </button>
                                
                                <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600 dark:text-gray-400">
                                    <div>
                                        <strong>Lab Results:</strong><br>
                                        Blood tests, Urine analysis, Chemistry panels
                                    </div>
                                    <div>
                                        <strong>Medical Imaging:</strong><br>
                                        X-rays, CT/MRI scans, Ultrasound
                                    </div>
                                    <div>
                                        <strong>Reports:</strong><br>
                                        Pathology, Radiology, Cardiac reports
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analysis Progress -->
                        <div id="medicalAnalysisProgress" class="hidden mb-8">
                            <div class="bg-blue-50 dark:bg-blue-900 p-6 rounded-xl border border-blue-200 dark:border-blue-700">
                                <div class="flex items-center mb-4">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-4"></div>
                                    <h4 class="font-bold text-blue-800 dark:text-blue-300 text-lg">AI Medical Analysis in Progress</h4>
                                </div>
                                <div class="mb-4">
                                    <div class="w-full bg-blue-200 dark:bg-blue-800 rounded-full h-3">
                                        <div class="bg-blue-600 h-3 rounded-full transition-all duration-1000" id="medicalProgressBar" style="width: 0%"></div>
                                    </div>
                                    <div class="text-sm text-blue-700 dark:text-blue-400 mt-2" id="medicalProgressText">
                                        Initializing AI analysis...
                                    </div>
                                </div>
                                <div class="text-sm text-blue-600 dark:text-blue-400 space-y-1" id="medicalAnalysisSteps">
                                    <!-- Analysis steps will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analysis Results -->
                        <div id="medicalAnalysisResults" class="hidden">
                            <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden shadow-lg">
                                <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-4">
                                    <div class="flex justify-between items-center">
                                        <h3 class="font-bold text-lg">
                                            <i class="fas fa-check-circle mr-2"></i>Medical Analysis Complete
                                        </h3>
                                        <div class="flex space-x-2">
                                            <div class="relative">
                                                <button onclick="toggleMedicalExportMenu()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm transition-all flex items-center">
                                                    <i class="fas fa-download mr-1"></i>Export <i class="fas fa-chevron-down ml-1"></i>
                                                </button>
                                                <div id="medicalExportMenu" class="hidden absolute right-0 top-full mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg z-10 min-w-48">
                                                    <div class="py-2">
                                                        <button onclick="exportMedicalResults('pdf')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                            <i class="fas fa-file-pdf text-red-500 mr-3"></i>Export as PDF
                                                        </button>
                                                        <button onclick="exportMedicalResults('word')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                            <i class="fas fa-file-word text-blue-500 mr-3"></i>Export as Word
                                                        </button>
                                                        <button onclick="exportMedicalResults('excel')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                            <i class="fas fa-file-excel text-green-500 mr-3"></i>Export as Excel
                                                        </button>
                                                        <button onclick="exportMedicalResults('powerpoint')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                            <i class="fas fa-file-powerpoint text-orange-500 mr-3"></i>Export as PowerPoint
                                                        </button>
                                                        <button onclick="exportMedicalResults('txt')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                            <i class="fas fa-file-alt text-gray-500 mr-3"></i>Export as Text
                                                        </button>
                                                        <button onclick="exportMedicalResults('json')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                            <i class="fas fa-file-code text-purple-500 mr-3"></i>Export as JSON
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <button onclick="shareWithDoctor()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm transition-all">
                                                <i class="fas fa-share mr-1"></i>Share
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-6">
                                    <div id="medicalAnalysisContent">
                                        <!-- AI analysis results will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI Chat for Medical Questions -->
                        <div class="mt-8 bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">
                                <i class="fas fa-robot mr-2 text-red-500"></i>Medical AI Assistant
                            </h3>
                            <div id="medicalChatMessages" class="bg-white dark:bg-gray-800 rounded-lg p-4 h-64 overflow-y-auto mb-4 border">
                                <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                                    <i class="fas fa-user-md text-4xl mb-3"></i>
                                    <p>Hi! I'm your AI Medical Assistant. Upload a medical file or ask me any health-related questions.</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <input type="text" id="medicalQuestionInput" class="flex-1 px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Ask your medical question..." onkeypress="if(event.key==='Enter') askMedicalQuestion()">
                                <button onclick="askMedicalQuestion()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-semibold">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            
                            <!-- Quick Questions -->
                            <div class="mt-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Quick questions:</p>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="askQuickMedicalQuestion('Explain my blood test results')" class="text-xs bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 px-3 py-1 rounded-full hover:bg-red-200 dark:hover:bg-red-800">
                                        Blood test analysis
                                    </button>
                                    <button onclick="askQuickMedicalQuestion('What do these symptoms mean?')" class="text-xs bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 px-3 py-1 rounded-full hover:bg-red-200 dark:hover:bg-red-800">
                                        Symptom analysis
                                    </button>
                                    <button onclick="askQuickMedicalQuestion('Analyze my X-ray')" class="text-xs bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 px-3 py-1 rounded-full hover:bg-red-200 dark:hover:bg-red-800">
                                        X-ray analysis
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Research AI Module -->
            <div id="researchModule" class="module hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6">
                        <h2 class="text-3xl font-bold mb-2">
                            <i class="fas fa-brain mr-3"></i>Research AI Assistant
                        </h2>
                        <p class="opacity-90">Advanced multi-language research platform with real-time AI analysis</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Research Input -->
                            <div class="space-y-6">
                                <!-- Research Type Selection -->
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">
                                        <i class="fas fa-microscope mr-2 text-blue-500"></i>Research Category
                                    </h3>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <button onclick="selectResearchType('medical')" class="research-type-btn p-4 rounded-lg border-2 border-red-500 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30 transition-all">
                                            <i class="fas fa-heartbeat text-2xl text-red-600 dark:text-red-400 mb-2"></i>
                                            <div class="font-semibold text-gray-800 dark:text-white">Medical</div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">Healthcare research</div>
                                        </button>
                                        
                                        <button onclick="selectResearchType('scientific')" class="research-type-btn p-4 rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-all bg-white dark:bg-gray-700">
                                            <i class="fas fa-atom text-2xl text-blue-600 dark:text-blue-400 mb-2"></i>
                                            <div class="font-semibold text-gray-800 dark:text-white">Scientific</div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">Academic research</div>
                                        </button>
                                        
                                        <button onclick="selectResearchType('business')" class="research-type-btn p-4 rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-green-500 transition-all bg-white dark:bg-gray-700">
                                            <i class="fas fa-chart-line text-2xl text-green-600 dark:text-green-400 mb-2"></i>
                                            <div class="font-semibold text-gray-800 dark:text-white">Business</div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">Market research</div>
                                        </button>
                                        
                                        <button onclick="selectResearchType('technology')" class="research-type-btn p-4 rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-purple-500 transition-all bg-white dark:bg-gray-700">
                                            <i class="fas fa-microchip text-2xl text-purple-600 dark:text-purple-400 mb-2"></i>
                                            <div class="font-semibold text-gray-800 dark:text-white">Technology</div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">Tech innovation</div>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Research Form -->
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                            <i class="fas fa-search mr-2 text-blue-500"></i>Research Topic (Arabic/English)
                                        </label>
                                        <input type="text" id="researchTopic" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Enter your research topic...">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                            <i class="fas fa-file-alt mr-2 text-green-500"></i>Research Details &amp; Objectives
                                        </label>
                                        <textarea id="researchDetails" rows="4" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none" placeholder="Describe your research objectives, methodology, and specific questions..."></textarea>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Research Depth</label>
                                        <select id="researchDepth" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                            <option value="quick">Quick Overview</option>
                                            <option value="detailed" selected="">Detailed Analysis</option>
                                            <option value="comprehensive">Comprehensive Study</option>
                                            <option value="academic">Academic Literature Review</option>
                                        </select>
                                    </div>
                                    
                                    <button onclick="startAdvancedResearch()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white py-4 rounded-xl font-bold text-lg transition-all duration-200 transform hover:scale-105 shadow-lg">
                                        <i class="fas fa-rocket mr-2"></i>Start AI Research
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Research Results -->
                            <div class="space-y-6">
                                <!-- Research Progress -->
                                <div id="researchProgress" class="hidden bg-blue-50 dark:bg-blue-900 p-6 rounded-xl border border-blue-200 dark:border-blue-700">
                                    <div class="flex items-center mb-4">
                                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
                                        <h4 class="font-bold text-blue-800 dark:text-blue-300">AI Research in Progress</h4>
                                    </div>
                                    <div class="mb-4">
                                        <div class="w-full bg-blue-200 dark:bg-blue-800 rounded-full h-2">
                                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-1000" id="researchProgressBar" style="width: 0%"></div>
                                        </div>
                                        <div class="text-xs text-blue-600 dark:text-blue-400 mt-1" id="researchProgressText">
                                            Starting research analysis...
                                        </div>
                                    </div>
                                    <div id="researchSteps" class="text-sm text-blue-700 dark:text-blue-400 space-y-1">
                                        <!-- Research steps will be populated here -->
                                    </div>
                                </div>
                                
                                <!-- Research Results -->
                                <div id="researchResults" class="hidden">
                                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden shadow-lg">
                                        <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-4">
                                            <div class="flex justify-between items-center">
                                                <h3 class="font-bold text-lg">
                                                    <i class="fas fa-chart-line mr-2"></i>Research Analysis Complete
                                                </h3>
                                                <div class="flex space-x-2">
                                                    <div class="relative">
                                                        <button onclick="toggleResearchExportMenu()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm transition-all flex items-center">
                                                            <i class="fas fa-download mr-1"></i>Export <i class="fas fa-chevron-down ml-1"></i>
                                                        </button>
                                                        <div id="researchExportMenu" class="hidden absolute right-0 top-full mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg z-10 min-w-48">
                                                            <div class="py-2">
                                                                <button onclick="exportResearchResults('pdf')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                                    <i class="fas fa-file-pdf text-red-500 mr-3"></i>Export as PDF
                                                                </button>
                                                                <button onclick="exportResearchResults('word')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                                    <i class="fas fa-file-word text-blue-500 mr-3"></i>Export as Word
                                                                </button>
                                                                <button onclick="exportResearchResults('excel')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>Export as Excel
                                                                </button>
                                                                <button onclick="exportResearchResults('powerpoint')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                                    <i class="fas fa-file-powerpoint text-orange-500 mr-3"></i>Export as PowerPoint
                                                                </button>
                                                                <button onclick="exportResearchResults('txt')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                                    <i class="fas fa-file-alt text-gray-500 mr-3"></i>Export as Text
                                                                </button>
                                                                <button onclick="exportResearchResults('json')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                                    <i class="fas fa-file-code text-purple-500 mr-3"></i>Export as JSON
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <button onclick="shareResearch()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm transition-all">
                                                        <i class="fas fa-share mr-1"></i>Share
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="p-6">
                                            <div id="researchContent">
                                                <!-- Research results will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Research Templates -->
                                <div id="researchTemplates" class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">
                                        <i class="fas fa-template mr-2 text-yellow-500"></i>Quick Research Templates
                                    </h3>
                                    <div class="space-y-2">
                                        <button onclick="loadResearchTemplate('literature')" class="w-full text-left p-3 bg-white dark:bg-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-500 transition-colors">
                                            <div class="font-medium">📚 Literature Review</div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">Systematic review of existing research</div>
                                        </button>
                                        <button onclick="loadResearchTemplate('market')" class="w-full text-left p-3 bg-white dark:bg-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-500 transition-colors">
                                            <div class="font-medium">📈 Market Analysis</div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">Business and market research</div>
                                        </button>
                                        <button onclick="loadResearchTemplate('clinical')" class="w-full text-left p-3 bg-white dark:bg-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-500 transition-colors">
                                            <div class="font-medium">🏥 Clinical Study</div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">Medical research methodology</div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Finance AI Module -->
            <div id="financeModule" class="module hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-green-500 to-blue-600 text-white p-6">
                        <h2 class="text-3xl font-bold mb-2">
                            <i class="fas fa-chart-line mr-3"></i>Finance AI Analysis
                        </h2>
                        <p class="opacity-90">Intelligent financial data analysis and business insights</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- File Upload & Data Input -->
                            <div class="space-y-6">
                                <!-- File Upload -->
                                <div class="border-2 border-dashed border-green-300 dark:border-green-600 rounded-xl p-6 text-center bg-green-50 dark:bg-green-900/20">
                                    <i class="fas fa-upload text-4xl text-green-500 mb-4"></i>
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-2">Upload Financial Data</h3>
                                    <p class="text-gray-600 dark:text-gray-400 mb-4">
                                        CSV, Excel, PDF, and other financial documents
                                    </p>
                                    <input type="file" id="financeFileInput" accept="*/*" class="hidden" onchange="handleFinanceFileUpload(event)">
                                    <button onclick="document.getElementById('financeFileInput').click()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                                        <i class="fas fa-folder-open mr-2"></i>Choose File
                                    </button>
                                </div>
                                
                                <!-- Manual Data Entry -->
                                <div>
                                    <h3 class="font-semibold text-gray-700 dark:text-gray-300 mb-4">Manual Data Entry</h3>
                                    <textarea id="manualFinanceData" rows="6" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none" placeholder="Enter financial data (revenue, expenses, profits, etc.)..."></textarea>
                                    <button onclick="processManualData()" class="mt-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                                        <i class="fas fa-chart-line mr-2"></i>Analyze Data
                                    </button>
                                </div>
                                
                                <!-- Quick Calculations -->
                                <div>
                                    <h3 class="font-semibold text-gray-700 dark:text-gray-300 mb-4">Quick Financial Tools</h3>
                                    <div class="grid grid-cols-2 gap-3">
                                        <button onclick="openFinancialCalculator('roi')" class="bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-4 py-3 rounded-lg text-sm hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
                                            💰 ROI Calculator
                                        </button>
                                        <button onclick="openFinancialCalculator('profit')" class="bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 px-4 py-3 rounded-lg text-sm hover:bg-green-200 dark:hover:bg-green-800 transition-colors">
                                            📈 Profit Margin
                                        </button>
                                        <button onclick="openFinancialCalculator('cashflow')" class="bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 px-4 py-3 rounded-lg text-sm hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors">
                                            💵 Cash Flow
                                        </button>
                                        <button onclick="openFinancialCalculator('forecast')" class="bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 px-4 py-3 rounded-lg text-sm hover:bg-orange-200 dark:hover:bg-orange-800 transition-colors">
                                            🔮 Forecast
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI Analysis & Chat -->
                            <div class="space-y-6">
                                <!-- Data Preview -->
                                <div id="financeDataPreview" class="hidden">
                                    <h3 class="font-semibold text-gray-700 dark:text-gray-300 mb-4">Data Analysis</h3>
                                    <div id="financeDataTable" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                        <!-- Data preview will be shown here -->
                                    </div>
                                </div>
                                
                                <!-- Finance Analysis Results -->
                                <div id="financeAnalysisResults" class="hidden mb-6">
                                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden shadow-lg">
                                        <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-4">
                                            <div class="flex justify-between items-center">
                                                <h3 class="font-bold text-lg">
                                                    <i class="fas fa-chart-line mr-2"></i>Financial Analysis Complete
                                                </h3>
                                                <div class="flex space-x-2">
                                                    <div class="relative">
                                                        <button onclick="toggleFinanceExportMenu()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm transition-all flex items-center">
                                                            <i class="fas fa-download mr-1"></i>Export <i class="fas fa-chevron-down ml-1"></i>
                                                        </button>
                                                        <div id="financeExportMenu" class="hidden absolute right-0 top-full mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg z-10 min-w-48">
                                                            <div class="py-2">
                                                                <button onclick="exportFinanceResults('pdf')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                                    <i class="fas fa-file-pdf text-red-500 mr-3"></i>Export as PDF
                                                                </button>
                                                                <button onclick="exportFinanceResults('word')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                                    <i class="fas fa-file-word text-blue-500 mr-3"></i>Export as Word
                                                                </button>
                                                                <button onclick="exportFinanceResults('excel')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>Export as Excel
                                                                </button>
                                                                <button onclick="exportFinanceResults('powerpoint')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                                    <i class="fas fa-file-powerpoint text-orange-500 mr-3"></i>Export as PowerPoint
                                                                </button>
                                                                <button onclick="exportFinanceResults('csv')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                                    <i class="fas fa-file-csv text-teal-500 mr-3"></i>Export as CSV
                                                                </button>
                                                                <button onclick="exportFinanceResults('txt')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                                    <i class="fas fa-file-alt text-gray-500 mr-3"></i>Export as Text
                                                                </button>
                                                                <button onclick="exportFinanceResults('json')" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                                                    <i class="fas fa-file-code text-purple-500 mr-3"></i>Export as JSON
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <button onclick="shareFinanceAnalysis()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm transition-all">
                                                        <i class="fas fa-share mr-1"></i>Share
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="p-6">
                                            <div id="financeAnalysisContent">
                                                <!-- Finance analysis results will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- AI Financial Analyst Chat -->
                                <div>
                                    <h3 class="font-semibold text-gray-700 dark:text-gray-300 mb-4">
                                        <i class="fas fa-robot mr-2 text-green-500"></i>AI Financial Analyst
                                    </h3>
                                    <div id="financeChatMessages" class="bg-white dark:bg-gray-800 rounded-lg p-4 h-64 overflow-y-auto mb-4 border">
                                        <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                                            <i class="fas fa-chart-bar text-4xl mb-3"></i>
                                            <p>Upload financial data or ask me questions about financial analysis</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <input type="text" id="financeQuestionInput" class="flex-1 px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Ask your financial question..." onkeypress="if(event.key==='Enter') askFinanceQuestion()">
                                        <button onclick="askFinanceQuestion()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Quick Questions -->
                                    <div class="mt-4">
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Quick questions:</p>
                                        <div class="flex flex-wrap gap-2">
                                            <button onclick="askQuickFinanceQuestion('Analyze my profit margins')" class="text-xs bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 px-3 py-1 rounded-full hover:bg-green-200 dark:hover:bg-green-800">
                                                Profit analysis
                                            </button>
                                            <button onclick="askQuickFinanceQuestion('Show financial trends')" class="text-xs bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 px-3 py-1 rounded-full hover:bg-green-200 dark:hover:bg-green-800">
                                                Trend analysis
                                            </button>
                                            <button onclick="askQuickFinanceQuestion('Calculate ROI')" class="text-xs bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 px-3 py-1 rounded-full hover:bg-green-200 dark:hover:bg-green-800">
                                                ROI calculation
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Smart Calculator Module -->
            <div id="calculatorModule" class="module hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white p-6">
                        <h2 class="text-3xl font-bold mb-2">
                            <i class="fas fa-calculator mr-3"></i>AI-Powered Smart Calculator
                        </h2>
                        <p class="opacity-90">Advanced calculations with AI assistance and financial tools</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Calculator Interface -->
                            <div>
                                <!-- Calculator Display -->
                                <div class="bg-gray-900 dark:bg-gray-800 p-6 rounded-lg mb-4">
                                    <div id="calculatorDisplay" class="text-right text-white text-4xl font-mono min-h-16 flex items-center justify-end">0</div>
                                    <div id="calculatorHistory" class="text-right text-gray-400 text-sm mt-2 min-h-6"></div>
                                </div>
                                
                                <!-- Calculator Buttons -->
                                <div class="grid grid-cols-4 gap-3">
                                    <!-- Row 1 -->
                                    <button onclick="clearCalculator()" class="calc-btn bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-lg text-xl transition-colors">C</button>
                                    <button onclick="backspace()" class="calc-btn bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-lg text-xl transition-colors">⌫</button>
                                    <button onclick="inputOperator('/')" class="calc-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-lg text-xl transition-colors">÷</button>
                                    <button onclick="inputOperator('*')" class="calc-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-lg text-xl transition-colors">×</button>
                                    
                                    <!-- Row 2 -->
                                    <button onclick="inputNumber('7')" class="calc-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 rounded-lg text-xl transition-colors">7</button>
                                    <button onclick="inputNumber('8')" class="calc-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 rounded-lg text-xl transition-colors">8</button>
                                    <button onclick="inputNumber('9')" class="calc-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 rounded-lg text-xl transition-colors">9</button>
                                    <button onclick="inputOperator('-')" class="calc-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-lg text-xl transition-colors">−</button>
                                    
                                    <!-- Row 3 -->
                                    <button onclick="inputNumber('4')" class="calc-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 rounded-lg text-xl transition-colors">4</button>
                                    <button onclick="inputNumber('5')" class="calc-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 rounded-lg text-xl transition-colors">5</button>
                                    <button onclick="inputNumber('6')" class="calc-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 rounded-lg text-xl transition-colors">6</button>
                                    <button onclick="inputOperator('+')" class="calc-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-lg text-xl transition-colors">+</button>
                                    
                                    <!-- Row 4 -->
                                    <button onclick="inputNumber('1')" class="calc-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 rounded-lg text-xl transition-colors">1</button>
                                    <button onclick="inputNumber('2')" class="calc-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 rounded-lg text-xl transition-colors">2</button>
                                    <button onclick="inputNumber('3')" class="calc-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 rounded-lg text-xl transition-colors">3</button>
                                    <button onclick="calculate()" class="calc-btn bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-lg text-xl row-span-2 transition-colors">=</button>
                                    
                                    <!-- Row 5 -->
                                    <button onclick="inputNumber('0')" class="calc-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 rounded-lg text-xl col-span-2 transition-colors">0</button>
                                    <button onclick="inputNumber('.')" class="calc-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 rounded-lg text-xl transition-colors">.</button>
                                </div>
                                
                                <!-- Advanced Functions -->
                                <div class="mt-4 grid grid-cols-3 gap-2">
                                    <button onclick="calculateSquareRoot()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded text-sm transition-colors">√</button>
                                    <button onclick="calculatePower()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded text-sm transition-colors">x²</button>
                                    <button onclick="calculatePercentage()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded text-sm transition-colors">%</button>
                                </div>
                            </div>
                            
                            <!-- AI Calculator Assistant -->
                            <div class="space-y-6">
                                <!-- AI Chat for Calculations -->
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">
                                        <i class="fas fa-robot mr-2 text-purple-500"></i>AI Calculator Assistant
                                    </h3>
                                    <div id="calculatorChatMessages" class="bg-white dark:bg-gray-800 rounded-lg p-4 h-48 overflow-y-auto mb-4 border">
                                        <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                                            <i class="fas fa-calculator text-4xl mb-3"></i>
                                            <p>Ask me to perform complex calculations or solve math problems!</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <input type="text" id="calculatorQuestionInput" class="flex-1 px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="e.g., Calculate 15% of 250 + compound interest..." onkeypress="if(event.key==='Enter') askCalculatorQuestion()">
                                        <button onclick="askCalculatorQuestion()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Quick Calculation Examples -->
                                    <div class="mt-4">
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Quick examples:</p>
                                        <div class="flex flex-wrap gap-2">
                                            <button onclick="askQuickCalculation('Calculate compound interest on $10000 at 5% for 3 years')" class="text-xs bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 px-3 py-1 rounded-full hover:bg-purple-200 dark:hover:bg-purple-800">
                                                Compound interest
                                            </button>
                                            <button onclick="askQuickCalculation('What is 15% tip on $85.50?')" class="text-xs bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 px-3 py-1 rounded-full hover:bg-purple-200 dark:hover:bg-purple-800">
                                                Tip calculator
                                            </button>
                                            <button onclick="askQuickCalculation('Convert 150 USD to EUR')" class="text-xs bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 px-3 py-1 rounded-full hover:bg-purple-200 dark:hover:bg-purple-800">
                                                Currency convert
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Financial Calculators -->
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4">Financial Tools</h3>
                                    <div class="grid grid-cols-1 gap-3">
                                        <button onclick="openLoanCalculator()" class="bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 p-3 rounded-lg hover:bg-green-200 dark:hover:bg-green-800 transition-colors text-left">
                                            <div class="font-medium">🏠 Loan Calculator</div>
                                            <div class="text-xs">Mortgage and loan payments</div>
                                        </button>
                                        <button onclick="openInvestmentCalculator()" class="bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 p-3 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors text-left">
                                            <div class="font-medium">📈 Investment Calculator</div>
                                            <div class="text-xs">ROI and portfolio analysis</div>
                                        </button>
                                        <button onclick="openRetirementCalculator()" class="bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 p-3 rounded-lg hover:bg-orange-200 dark:hover:bg-orange-800 transition-colors text-left">
                                            <div class="font-medium">🎯 Retirement Calculator</div>
                                            <div class="text-xs">Retirement planning tools</div>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Calculation History -->
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4">Calculation History</h3>
                                    <div id="calculationHistory" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg max-h-32 overflow-y-auto">
                                        <p class="text-gray-500 dark:text-gray-400 text-sm">No calculations yet</p>
                                    </div>
                                    <button onclick="clearHistory()" class="mt-2 text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                                        Clear History
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Module -->
            <div id="adminModule" class="module hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6">
                        <h2 class="text-3xl font-bold mb-2">
                            <i class="fas fa-users-cog mr-3"></i>Platform Administration
                        </h2>
                        <p class="opacity-90">Comprehensive user and system management with permissions control</p>
                    </div>
                    
                    <div class="p-6">
                        <!-- Platform Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg text-center">
                                <div class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="totalUsers">0</div>
                                <div class="text-sm text-blue-800 dark:text-blue-300">Total Users</div>
                            </div>
                            <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg text-center">
                                <div class="text-3xl font-bold text-green-600 dark:text-green-400" id="adminActiveUsers">0</div>
                                <div class="text-sm text-green-800 dark:text-green-300">Active Users</div>
                            </div>
                            <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg text-center">
                                <div class="text-3xl font-bold text-purple-600 dark:text-purple-400" id="adminUsers">0</div>
                                <div class="text-sm text-purple-800 dark:text-purple-300">Administrators</div>
                            </div>
                            <div class="bg-orange-50 dark:bg-orange-900 p-4 rounded-lg text-center">
                                <div class="text-3xl font-bold text-orange-600 dark:text-orange-400" id="systemHealth">99.9%</div>
                                <div class="text-sm text-orange-800 dark:text-orange-300">System Health</div>
                            </div>
                        </div>
                        
                        <!-- Navigation Tabs -->
                        <div class="mb-6">
                            <div class="border-b border-gray-200 dark:border-gray-600">
                                <nav class="-mb-px flex space-x-8">
                                    <button onclick="showAdminTab('users')" id="usersTab" class="admin-tab border-b-2 border-indigo-500 text-indigo-600 py-2 px-1 font-medium text-sm">
                                        <i class="fas fa-users mr-2"></i>User Management
                                    </button>
                                    <button onclick="showAdminTab('permissions')" id="permissionsTab" class="admin-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 font-medium text-sm">
                                        <i class="fas fa-shield-alt mr-2"></i>Permissions Overview
                                    </button>
                                    <button onclick="showAdminTab('create')" id="createTab" class="admin-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 font-medium text-sm">
                                        <i class="fas fa-user-plus mr-2"></i>Create User
                                    </button>
                                </nav>
                            </div>
                        </div>
                        
                        <!-- User Management Tab -->
                        <div id="usersTabContent" class="admin-tab-content">
                            <div class="grid grid-cols-1 gap-8">
                                <!-- User List -->
                                <div>
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-xl font-bold text-gray-800 dark:text-white">User Management</h3>
                                        <div class="flex space-x-2">
                                            <input type="text" id="userSearch" placeholder="Search users..." class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" onkeyup="searchUsers()">
                                            <button onclick="refreshUserList()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                                <i class="fas fa-refresh"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="usersList" class="space-y-3 max-h-96 overflow-y-auto">
                                        <!-- Users will be populated here -->
                                    </div>
                                </div>
                                
                                <!-- Bulk Actions -->
                                <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">
                                        <i class="fas fa-tools mr-2 text-indigo-500"></i>Bulk Actions
                                    </h3>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <button onclick="exportUsers()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-medium transition-colors">
                                            <i class="fas fa-download mr-2"></i>Export Users
                                        </button>
                                        <button onclick="importUsers()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg font-medium transition-colors">
                                            <i class="fas fa-upload mr-2"></i>Import Users
                                        </button>
                                        <button onclick="exportPermissions()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-lg font-medium transition-colors">
                                            <i class="fas fa-shield-alt mr-2"></i>Export Permissions
                                        </button>
                                        <button onclick="auditLogs()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-lg font-medium transition-colors">
                                            <i class="fas fa-history mr-2"></i>Audit Logs
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Permissions Overview Tab -->
                        <div id="permissionsTabContent" class="admin-tab-content hidden">
                            <div class="space-y-6">
                                <!-- Permissions Matrix -->
                                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                                    <div class="bg-gradient-to-r from-purple-500 to-blue-600 text-white p-4">
                                        <h3 class="text-xl font-bold">
                                            <i class="fas fa-matrix mr-2"></i>Permissions Matrix
                                        </h3>
                                        <p class="text-sm opacity-90">Overview of user permissions across all modules</p>
                                    </div>
                                    
                                    <div class="p-6 overflow-x-auto">
                                        <table id="permissionsMatrix" class="w-full text-sm">
                                            <thead>
                                                <tr class="border-b border-gray-200 dark:border-gray-600">
                                                    <th class="text-left py-3 px-4 font-semibold text-gray-800 dark:text-white">User</th>
                                                    <th class="text-center py-3 px-2 font-semibold text-red-600 dark:text-red-400">
                                                        <i class="fas fa-heartbeat"></i><br>Medical AI
                                                    </th>
                                                    <th class="text-center py-3 px-2 font-semibold text-blue-600 dark:text-blue-400">
                                                        <i class="fas fa-brain"></i><br>Research AI
                                                    </th>
                                                    <th class="text-center py-3 px-2 font-semibold text-green-600 dark:text-green-400">
                                                        <i class="fas fa-chart-line"></i><br>Finance AI
                                                    </th>
                                                    <th class="text-center py-3 px-2 font-semibold text-purple-600 dark:text-purple-400">
                                                        <i class="fas fa-calculator"></i><br>Calculator
                                                    </th>
                                                    <th class="text-center py-3 px-2 font-semibold text-orange-600 dark:text-orange-400">
                                                        <i class="fas fa-user-md"></i><br>Live Chat
                                                    </th>
                                                    <th class="text-center py-3 px-2 font-semibold text-indigo-600 dark:text-indigo-400">
                                                        <i class="fas fa-users-cog"></i><br>Admin
                                                    </th>
                                                    <th class="text-center py-3 px-2 font-semibold text-gray-600 dark:text-gray-400">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="permissionsMatrixBody">
                                                <!-- Matrix will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Permission Templates -->
                                <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">
                                        <i class="fas fa-template mr-2 text-blue-500"></i>Permission Templates
                                    </h3>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="bg-white dark:bg-gray-600 p-4 rounded-lg border-l-4 border-blue-500">
                                            <h4 class="font-semibold text-gray-800 dark:text-white mb-2">Basic User</h4>
                                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Medical AI + Calculator access only</p>
                                            <button onclick="applyTemplate('basic')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                                <i class="fas fa-apply mr-1"></i>Apply Template
                                            </button>
                                        </div>
                                        <div class="bg-white dark:bg-gray-600 p-4 rounded-lg border-l-4 border-green-500">
                                            <h4 class="font-semibold text-gray-800 dark:text-white mb-2">Professional</h4>
                                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">All AI modules + Live Chat access</p>
                                            <button onclick="applyTemplate('professional')" class="text-green-600 hover:text-green-800 text-sm font-medium">
                                                <i class="fas fa-apply mr-1"></i>Apply Template
                                            </button>
                                        </div>
                                        <div class="bg-white dark:bg-gray-600 p-4 rounded-lg border-l-4 border-purple-500">
                                            <h4 class="font-semibold text-gray-800 dark:text-white mb-2">Administrator</h4>
                                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Full platform access + Admin panel</p>
                                            <button onclick="applyTemplate('admin')" class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                                                <i class="fas fa-apply mr-1"></i>Apply Template
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Create User Tab -->
                        <div id="createTabContent" class="admin-tab-content hidden">
                            <div class="max-w-4xl mx-auto">
                                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                                    <div class="bg-gradient-to-r from-green-500 to-blue-600 text-white p-6">
                                        <h3 class="text-2xl font-bold mb-2">
                                            <i class="fas fa-user-plus mr-3"></i>Create New User
                                        </h3>
                                        <p class="opacity-90">Set up user account with customized permissions</p>
                                    </div>
                                    
                                    <div class="p-6">
                                        <form id="createUserForm" class="space-y-6">
                                            <!-- Basic Information -->
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div>
                                                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                                        <i class="fas fa-user mr-2 text-blue-500"></i>Username
                                                    </label>
                                                    <input type="text" id="newUsername" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Enter username" required="">
                                                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Minimum 3 characters, unique username</div>
                                                </div>
                                                
                                                <div>
                                                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                                        <i class="fas fa-lock mr-2 text-green-500"></i>Password
                                                    </label>
                                                    <div class="relative">
                                                        <input type="password" id="newPassword" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white pr-12" placeholder="Enter password" required="">
                                                        <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" onclick="togglePasswordVisibilityInModal('newPassword', this)">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Minimum 6 characters</div>
                                                </div>
                                                
                                                <div>
                                                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                                        <i class="fas fa-id-badge mr-2 text-purple-500"></i>Role
                                                    </label>
                                                    <select id="newUserRole" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" onchange="updateRolePermissions()">
                                                        <option value="user">User</option>
                                                        <option value="doctor">Doctor</option>
                                                        <option value="admin">Administrator</option>
                                                    </select>
                                                </div>
                                                
                                                <div>
                                                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                                        <i class="fas fa-envelope mr-2 text-orange-500"></i>Email (Optional)
                                                    </label>
                                                    <input type="email" id="newUserEmail" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="user@example.com">
                                                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">For notifications and password recovery</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Permissions Section -->
                                            <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                                                <div class="flex justify-between items-center mb-4">
                                                    <h4 class="text-lg font-bold text-gray-800 dark:text-white">
                                                        <i class="fas fa-shield-alt mr-2 text-indigo-500"></i>Module Permissions
                                                    </h4>
                                                    <div class="flex space-x-2">
                                                        <button type="button" onclick="selectAllPermissions()" class="text-sm bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded">
                                                            <i class="fas fa-check-square mr-1"></i>Select All
                                                        </button>
                                                        <button type="button" onclick="clearAllPermissions()" class="text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">
                                                            <i class="fas fa-square mr-1"></i>Clear All
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                    <!-- Medical AI Permission -->
                                                    <div class="bg-white dark:bg-gray-600 p-4 rounded-lg border-l-4 border-red-500">
                                                        <div class="flex items-center mb-3">
                                                            <input type="checkbox" id="perm_medical" class="permission-checkbox mr-3 rounded">
                                                            <i class="fas fa-heartbeat text-red-600 dark:text-red-400 text-xl mr-3"></i>
                                                            <div>
                                                                <h5 class="font-semibold text-gray-800 dark:text-white">Medical AI</h5>
                                                                <p class="text-xs text-gray-600 dark:text-gray-400">AI medical analysis &amp; diagnosis</p>
                                                            </div>
                                                        </div>
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
                                                            <div>• Upload medical files</div>
                                                            <div>• AI medical analysis</div>
                                                            <div>• Generate medical reports</div>
                                                            <div>• Medical chat assistant</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Research AI Permission -->
                                                    <div class="bg-white dark:bg-gray-600 p-4 rounded-lg border-l-4 border-blue-500">
                                                        <div class="flex items-center mb-3">
                                                            <input type="checkbox" id="perm_research" class="permission-checkbox mr-3 rounded">
                                                            <i class="fas fa-brain text-blue-600 dark:text-blue-400 text-xl mr-3"></i>
                                                            <div>
                                                                <h5 class="font-semibold text-gray-800 dark:text-white">Research AI</h5>
                                                                <p class="text-xs text-gray-600 dark:text-gray-400">Advanced research assistance</p>
                                                            </div>
                                                        </div>
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
                                                            <div>• Multi-language research</div>
                                                            <div>• Academic analysis</div>
                                                            <div>• Literature reviews</div>
                                                            <div>• Research templates</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Finance AI Permission -->
                                                    <div class="bg-white dark:bg-gray-600 p-4 rounded-lg border-l-4 border-green-500">
                                                        <div class="flex items-center mb-3">
                                                            <input type="checkbox" id="perm_finance" class="permission-checkbox mr-3 rounded">
                                                            <i class="fas fa-chart-line text-green-600 dark:text-green-400 text-xl mr-3"></i>
                                                            <div>
                                                                <h5 class="font-semibold text-gray-800 dark:text-white">Finance AI</h5>
                                                                <p class="text-xs text-gray-600 dark:text-gray-400">Financial analysis &amp; insights</p>
                                                            </div>
                                                        </div>
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
                                                            <div>• Financial data analysis</div>
                                                            <div>• AI financial advisor</div>
                                                            <div>• Financial calculators</div>
                                                            <div>• Investment analysis</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Calculator Permission -->
                                                    <div class="bg-white dark:bg-gray-600 p-4 rounded-lg border-l-4 border-purple-500">
                                                        <div class="flex items-center mb-3">
                                                            <input type="checkbox" id="perm_calculator" class="permission-checkbox mr-3 rounded">
                                                            <i class="fas fa-calculator text-purple-600 dark:text-purple-400 text-xl mr-3"></i>
                                                            <div>
                                                                <h5 class="font-semibold text-gray-800 dark:text-white">Smart Calculator</h5>
                                                                <p class="text-xs text-gray-600 dark:text-gray-400">AI-powered calculations</p>
                                                            </div>
                                                        </div>
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
                                                            <div>• Advanced calculator</div>
                                                            <div>• AI math assistant</div>
                                                            <div>• Complex calculations</div>
                                                            <div>• Financial tools</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Live Chat Permission -->
                                                    <div class="bg-white dark:bg-gray-600 p-4 rounded-lg border-l-4 border-orange-500">
                                                        <div class="flex items-center mb-3">
                                                            <input type="checkbox" id="perm_livechat" class="permission-checkbox mr-3 rounded">
                                                            <i class="fas fa-user-md text-orange-600 dark:text-orange-400 text-xl mr-3"></i>
                                                            <div>
                                                                <h5 class="font-semibold text-gray-800 dark:text-white">Live AI Chat</h5>
                                                                <p class="text-xs text-gray-600 dark:text-gray-400">AI specialist consultations</p>
                                                            </div>
                                                        </div>
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
                                                            <div>• AI Doctor chat</div>
                                                            <div>• Cancer consultant</div>
                                                            <div>• Lab tech consultant</div>
                                                            <div>• Real-time assistance</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Admin Permission -->
                                                    <div class="bg-white dark:bg-gray-600 p-4 rounded-lg border-l-4 border-indigo-500">
                                                        <div class="flex items-center mb-3">
                                                            <input type="checkbox" id="perm_admin" class="permission-checkbox mr-3 rounded">
                                                            <i class="fas fa-users-cog text-indigo-600 dark:text-indigo-400 text-xl mr-3"></i>
                                                            <div>
                                                                <h5 class="font-semibold text-gray-800 dark:text-white">Administration</h5>
                                                                <p class="text-xs text-gray-600 dark:text-gray-400">Platform management</p>
                                                            </div>
                                                        </div>
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
                                                            <div>• User management</div>
                                                            <div>• Permission control</div>
                                                            <div>• System administration</div>
                                                            <div>• Platform settings</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Account Settings -->
                                            <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
                                                <h4 class="font-semibold text-blue-800 dark:text-blue-300 mb-3">
                                                    <i class="fas fa-cog mr-2"></i>Account Settings
                                                </h4>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div class="flex items-center space-x-2">
                                                        <input type="checkbox" id="forcePasswordChangeOnLogin" class="rounded">
                                                        <label for="forcePasswordChangeOnLogin" class="text-sm text-blue-700 dark:text-blue-300">
                                                            Force password change on first login
                                                        </label>
                                                    </div>
                                                    <div class="flex items-center space-x-2">
                                                        <input type="checkbox" id="sendWelcomeEmail" class="rounded" checked="">
                                                        <label for="sendWelcomeEmail" class="text-sm text-blue-700 dark:text-blue-300">
                                                            Send welcome email with credentials
                                                        </label>
                                                    </div>
                                                    <div class="flex items-center space-x-2">
                                                        <input type="checkbox" id="enableTwoFactor" class="rounded">
                                                        <label for="enableTwoFactor" class="text-sm text-blue-700 dark:text-blue-300">
                                                            Enable two-factor authentication
                                                        </label>
                                                    </div>
                                                    <div class="flex items-center space-x-2">
                                                        <input type="checkbox" id="accountActive" class="rounded" checked="">
                                                        <label for="accountActive" class="text-sm text-blue-700 dark:text-blue-300">
                                                            Account active immediately
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Action Buttons -->
                                            <div class="flex space-x-4 pt-4">
                                                <button type="button" onclick="resetCreateUserForm()" class="flex-1 px-6 py-3 text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">
                                                    <i class="fas fa-undo mr-2"></i>Reset Form
                                                </button>
                                                <button type="submit" class="flex-2 px-8 py-3 bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 text-white rounded-lg font-semibold transition-all duration-200 transform hover:scale-105">
                                                    <i class="fas fa-user-plus mr-2"></i>Create User Account
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Live Chat Widget (Hidden by default, only shows when activated) -->
        <div id="liveChatWidget" class="fixed bottom-6 right-6 z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-96 border border-gray-200 dark:border-gray-700 relative">
                <!-- Prominent Close Button - Customizable Size -->
                <button onclick="closeLiveChat()" class="absolute -top-3 -right-3 z-10 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-110 flex items-center justify-center group" title="Close Chat">
                    <i class="fas fa-times text-base group-hover:rotate-180 transition-transform duration-300"></i>
                </button>
                <!-- Chat Header with Specialist Selection -->
                <div id="chatHeader" class="bg-gradient-to-r from-blue-500 to-green-500 text-white p-4 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <div id="specialistAvatar" class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i id="specialistIcon" class="fas fa-user-md text-sm"></i>
                            </div>
                            <div>
                                <h4 id="specialistName" class="font-semibold">AI Medical Team</h4>
                                <p id="specialistStatus" class="text-xs opacity-75">Select Specialist</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="showSpecialistMenu()" class="text-white hover:text-gray-200 p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-all" title="Switch Specialist">
                                <i class="fas fa-users text-sm"></i>
                            </button>
                            <button onclick="closeLiveChat()" class="text-white hover:text-red-200 p-2 rounded-full hover:bg-red-500 hover:bg-opacity-30 transition-all duration-200 group" title="Close Chat">
                                <i class="fas fa-times text-sm group-hover:rotate-90 transition-transform duration-200"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Specialist Selection Menu -->
                <div id="specialistMenu" class="hidden bg-gray-50 dark:bg-gray-700 p-4 border-b border-gray-200 dark:border-gray-600">
                    <h5 class="font-bold text-gray-800 dark:text-white mb-3 text-sm">Choose Your AI Specialist:</h5>
                    <div class="grid grid-cols-1 gap-2">
                        <!-- AI Doctor -->
                        <button onclick="selectSpecialist('doctor')" class="flex items-center p-3 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors text-left">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-user-md text-white text-xs"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-sm">AI Doctor</div>
                                <div class="text-xs opacity-75">General medical consultation</div>
                            </div>
                        </button>

                        <!-- Cancer Consultant -->
                        <button onclick="selectSpecialist('cancer')" class="flex items-center p-3 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-lg hover:bg-red-200 dark:hover:bg-red-800 transition-colors text-left">
                            <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-ribbon text-white text-xs"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-sm">Cancer Consultant</div>
                                <div class="text-xs opacity-75">Oncology specialist for cancer care</div>
                            </div>
                        </button>

                        <!-- Lab Tech Consultant -->
                        <button onclick="selectSpecialist('labtech')" class="flex items-center p-3 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-lg hover:bg-green-200 dark:hover:bg-green-800 transition-colors text-left">
                            <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-microscope text-white text-xs"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-sm">Lab Tech Consultant</div>
                                <div class="text-xs opacity-75">Laboratory test analysis expert</div>
                            </div>
                        </button>
                    </div>
                    <button onclick="hideSpecialistMenu()" class="w-full mt-3 text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                        <i class="fas fa-chevron-up mr-1"></i>Hide Menu
                    </button>
                </div>
                
                <!-- Chat Messages -->
                <div id="liveChatMessages" class="h-64 overflow-y-auto p-4 space-y-3">
                    <div class="flex items-start space-x-2">
                        <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-robot text-white text-xs"></i>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 max-w-[80%]">
                            <div class="text-sm text-gray-800 dark:text-white">
                                Welcome to HK AI LAB Medical Team! Please select a specialist above to start your consultation.
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Just now</div>
                        </div>
                    </div>
                </div>
                
                <!-- Active Specialist Indicator -->
                <div id="activeSpecialistBar" class="hidden bg-gradient-to-r from-blue-500 to-green-500 text-white px-4 py-2 text-xs">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-white bg-opacity-30 rounded-full flex items-center justify-center mr-2">
                                <i id="activeSpecialistIcon" class="fas fa-user-md text-xs"></i>
                            </div>
                            <span id="activeSpecialistText">AI Doctor Online</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse mr-1"></span>
                            <span>Live</span>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="p-4 border-t border-gray-200 dark:border-gray-600">
                    <div class="flex space-x-2">
                        <input type="text" id="liveChatInput" class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Select a specialist to start..." disabled="">
                        <button onclick="sendLiveChatMessage()" id="liveChatSendBtn" class="bg-gray-400 text-white px-4 py-2 rounded-lg cursor-not-allowed" disabled="">
                            <i class="fas fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                    
                    <!-- Specialist Quick Actions -->
                    <div id="specialistQuickActions" class="hidden mt-3">
                        <!-- Will be populated based on selected specialist -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Futuristic AI Chat Portal Near Dashboard -->
        <div id="futuristicChatTrigger" class="fixed top-20 right-4 z-40">
            <!-- Futuristic Hidden Trigger -->
            <button onclick="revealFuturisticChat()" id="hiddenFuturisticTrigger" class="relative w-6 h-6 bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 rounded-full shadow-lg hover:shadow-cyan-500/50 transition-all duration-500 opacity-70 hover:opacity-100 group animate-pulse">
                <!-- Outer Glow Ring -->
                <div class="absolute inset-0 bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 rounded-full blur-sm opacity-75 group-hover:opacity-100 transition-all duration-300"></div>
                
                <!-- Inner Core -->
                <div class="relative w-full h-full bg-gradient-to-r from-cyan-300 to-blue-400 rounded-full flex items-center justify-center">
                    <div class="w-2 h-2 bg-white rounded-full animate-ping"></div>
                    <div class="absolute w-1 h-1 bg-cyan-200 rounded-full animate-pulse"></div>
                </div>
                
                <!-- Orbital Rings -->
                <div class="absolute inset-0 border border-cyan-300 rounded-full animate-spin opacity-60" style="animation-duration: 8s;"></div>
                <div class="absolute inset-1 border border-blue-300 rounded-full animate-spin opacity-40" style="animation-duration: 6s; animation-direction: reverse;"></div>
                
                <!-- Futuristic Tooltip -->
                <div class="absolute bottom-8 right-0 bg-black/80 backdrop-blur-sm border border-cyan-400/50 text-cyan-300 text-xs px-3 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition-all duration-300 whitespace-nowrap pointer-events-none shadow-lg shadow-cyan-500/25">
                    <div class="flex items-center space-x-2">
                        <span class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></span>
                        <span>Neural AI Interface</span>
                    </div>
                    <div class="absolute top-full right-4 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-cyan-400/50"></div>
                </div>
            </button>
            
            <!-- Futuristic Full Chat Portal (Hidden by default) -->
            <div id="futuristicChatPortal" class="hidden relative">
                <!-- Main Portal Button -->
                <button onclick="toggleLiveChat()" class="relative bg-gradient-to-r from-cyan-500 via-blue-600 to-purple-700 text-white shadow-2xl hover:shadow-cyan-500/50 transition-all duration-300 rounded-2xl overflow-hidden group backdrop-blur-sm border border-cyan-400/30">
                    <!-- Animated Background -->
                    <div class="absolute inset-0 bg-gradient-to-r from-cyan-400/20 via-blue-500/20 to-purple-600/20 animate-pulse"></div>
                    
                    <!-- Main Content -->
                    <div class="relative flex items-center space-x-3 px-4 py-3">
                        <!-- AI Core Icon -->
                        <div class="relative">
                            <div class="w-10 h-10 bg-gradient-to-r from-cyan-300 to-blue-400 rounded-full flex items-center justify-center shadow-lg shadow-cyan-500/50">
                                <i class="fas fa-brain text-white text-lg"></i>
                            </div>
                            <!-- Pulse Ring -->
                            <div class="absolute inset-0 border-2 border-cyan-300 rounded-full animate-ping opacity-75"></div>
                            <!-- Status Indicator -->
                            <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-400 rounded-full flex items-center justify-center">
                                <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
                            </div>
                        </div>
                        
                        <!-- Text Content -->
                        <div class="flex flex-col items-start">
                            <div class="font-bold text-sm bg-gradient-to-r from-cyan-200 to-white bg-clip-text text-transparent">Neural AI</div>
                            <div class="text-xs text-cyan-200/80">Quantum Support Active</div>
                        </div>
                        
                        <!-- Interaction Elements -->
                        <div class="ml-2 flex flex-col items-center space-y-1">
                            <i class="fas fa-satellite-dish text-lg text-cyan-200 group-hover:animate-spin"></i>
                            <div class="text-xs text-cyan-300/60">LIVE</div>
                        </div>
                    </div>
                    
                    <!-- Holographic Status Bar -->
                    <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 animate-pulse"></div>
                    
                    <!-- Data Stream Effect -->
                    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
                        <div class="absolute top-0 left-0 w-2 h-full bg-gradient-to-b from-transparent via-cyan-300/30 to-transparent animate-pulse" style="animation-duration: 2s;"></div>
                        <div class="absolute top-0 right-0 w-1 h-full bg-gradient-to-b from-transparent via-blue-300/30 to-transparent animate-pulse" style="animation-duration: 3s; animation-delay: 1s;"></div>
                    </div>
                </button>
                
                <!-- Quantum Particles Effect -->
                <div class="absolute inset-0 pointer-events-none">
                    <div class="absolute top-2 left-2 w-1 h-1 bg-cyan-300 rounded-full animate-ping" style="animation-delay: 0.5s;"></div>
                    <div class="absolute bottom-2 right-2 w-1 h-1 bg-blue-300 rounded-full animate-ping" style="animation-delay: 1.5s;"></div>
                    <div class="absolute top-4 right-4 w-0.5 h-0.5 bg-purple-300 rounded-full animate-ping" style="animation-delay: 2.5s;"></div>
                </div>
                
                <!-- Portal Close Button -->
                <button onclick="hideFuturisticChat(event)" class="absolute -top-2 -right-2 w-7 h-7 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white rounded-full text-xs flex items-center justify-center transition-all duration-300 shadow-lg shadow-red-500/50 border border-red-400/50" title="Close Neural Interface">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </div>
        
        <!-- Advanced Neural Chat Interface -->
        <style>
            @keyframes neural-pulse {
                0%, 100% { 
                    transform: scale(1);
                    box-shadow: 0 0 20px rgba(6, 182, 212, 0.4);
                }
                50% { 
                    transform: scale(1.05);
                    box-shadow: 0 0 30px rgba(6, 182, 212, 0.8), 0 0 60px rgba(59, 130, 246, 0.4);
                }
            }
            
            @keyframes data-flow {
                0% { transform: translateX(-100%); opacity: 0; }
                50% { opacity: 1; }
                100% { transform: translateX(100%); opacity: 0; }
            }
            
            @keyframes quantum-orbit {
                0% { transform: rotate(0deg) translateX(15px) rotate(0deg); }
                100% { transform: rotate(360deg) translateX(15px) rotate(-360deg); }
            }
            
            #futuristicChatTrigger {
                animation: neural-pulse 3s ease-in-out infinite;
            }
            
            #futuristicChatPortal::before {
                content: '';
                position: absolute;
                top: -2px;
                left: -2px;
                right: -2px;
                bottom: -2px;
                background: linear-gradient(45deg, transparent, rgba(6, 182, 212, 0.3), transparent);
                border-radius: 1rem;
                z-index: -1;
                animation: data-flow 4s linear infinite;
            }
        </style>
    </div>



    <script>
        // ═══════════════════════════════════════════════════════════════
        // 🚀 HK AI LAB PRO - PROFESSIONAL AI PLATFORM
        // ═══════════════════════════════════════════════════════════════
        
        // Global Variables
        let currentUser = null;
        let users = [];
        let selectedResearchType = 'medical';
        let calculatorValue = '0';
        let calculatorHistory = [];
        let previousValue = null;
        let operator = null;
        let waitingForOperand = false;
        let shouldResetDisplay = false;
        
        // Default Professional Users
        const defaultUsers = [
            {
                username: 'admin',
                password: 'Admin123',
                role: 'admin',
                createdAt: new Date().toISOString(),
                id: 'admin_1',
                isActive: true,
                loginCount: 0
            },
            {
                username: 'doctor',
                password: 'Doctor123',
                role: 'doctor',
                createdAt: new Date().toISOString(),
                id: 'doctor_1',
                isActive: true,
                loginCount: 0
            },
            {
                username: 'user',
                password: 'User123',
                role: 'user',
                createdAt: new Date().toISOString(),
                id: 'user_1',
                isActive: true,
                loginCount: 0
            },
            {
                username: 'guest',
                password: 'Guest123',
                role: 'user',
                createdAt: new Date().toISOString(),
                id: 'guest_1',
                isActive: true,
                loginCount: 0
            }
        ];

        // ═══════════════════════════════════════════════════════════════
        // 🔐 AUTHENTICATION SYSTEM
        // ═══════════════════════════════════════════════════════════════
        
        function initializeUsers() {
            try {
                const savedUsers = localStorage.getItem('hkLabUsers');
                users = savedUsers ? JSON.parse(savedUsers) : defaultUsers;
            } catch (error) {
                users = defaultUsers;
            }
            saveUsers();
        }
        
        function saveUsers() {
            try {
                localStorage.setItem('hkLabUsers', JSON.stringify(users));
            } catch (error) {
                console.warn('Could not save users to localStorage');
            }
        }
        
        // Login Handler
        document.addEventListener('DOMContentLoaded', function() {
            initializeUsers();
            
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                
                const user = users.find(u => u.username === username && u.password === password && u.isActive);
                
                if (user) {
                    user.loginCount = (user.loginCount || 0) + 1;
                    user.lastLogin = new Date().toISOString();
                    saveUsers();
                    
                    currentUser = user;
                    document.getElementById('currentUser').textContent = user.username;
                    document.getElementById('userRole').textContent = user.role.toUpperCase();
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    
                    updateProfilePhoto();
                    
                    if (user.role === 'admin') {
                        showAdminFeatures();
                        loadUsers();
                    }
                    
                    updateStats();
                    
                    // Show welcome message
                    setTimeout(() => {
                        showNotification(`Welcome back, ${user.username}! AI systems are ready.`, 'success');
                    }, 1000);
                } else {
                    showNotification('Invalid credentials. Please try again.', 'error');
                }
            });
        });
        
        function updateProfilePhoto() {
            const initials = currentUser.username.substring(0, 2).toUpperCase();
            document.getElementById('userInitials').textContent = initials;
        }
        
        function showAdminFeatures() {
            document.getElementById('adminTab').classList.remove('hidden');
            document.getElementById('quickAdmin').classList.remove('hidden');
        }
        
        function logout() {
            // Create custom logout confirmation modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 border border-gray-200 dark:border-gray-700">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-red-500 to-orange-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-sign-out-alt text-3xl text-white"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Confirm Logout</h3>
                        <p class="text-gray-600 dark:text-gray-400">Are you sure you want to logout from HK AI LAB Pro?</p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                        <button onclick="performLogout(); this.closest('.fixed').remove();" class="flex-1 px-4 py-3 bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white rounded-lg font-semibold transition-all duration-200 transform hover:scale-105">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                    
                    <!-- User Info -->
                    <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900 rounded-lg border border-blue-200 dark:border-blue-700">
                        <div class="flex items-center text-sm text-blue-700 dark:text-blue-300">
                            <i class="fas fa-user mr-2 text-blue-500"></i>
                            <span>Logged in as: <strong>${currentUser ? currentUser.username : 'Unknown'}</strong> (${currentUser ? currentUser.role.toUpperCase() : 'Unknown Role'})</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function performLogout() {
            const loggedOutUser = currentUser ? currentUser.username : 'Unknown';
            
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Reset UI
            document.getElementById('adminTab').classList.add('hidden');
            document.getElementById('quickAdmin').classList.add('hidden');
            showModule('dashboard');
            
            // Show success message
            setTimeout(() => {
                showNotification(`Successfully logged out. Goodbye, ${loggedOutUser}!`, 'success');
            }, 500);
        }
        
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const passwordIcon = document.getElementById('passwordIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordIcon.classList.remove('fa-eye');
                passwordIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                passwordIcon.classList.remove('fa-eye-slash');
                passwordIcon.classList.add('fa-eye');
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // 🧠 AI INTEGRATION SYSTEM
        // ═══════════════════════════════════════════════════════════════
        
        // Check if Poe Embed API is available
        function isAIAvailable() {
            return typeof window !== 'undefined' && window.Poe && window.Poe.sendUserMessage;
        }
        
        // AI Message Handler Registration
        if (isAIAvailable()) {
            // Medical AI Handler
            window.Poe.registerHandler("medical-analysis", (result, context) => {
                const msg = result.responses[0];
                if (msg.status === "error") {
                    document.getElementById('medicalAnalysisContent').innerHTML = `
                        <div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg">
                            <h4 class="font-bold text-red-800 dark:text-red-300 mb-2">Analysis Error</h4>
                            <p class="text-red-600 dark:text-red-400">${msg.statusText || 'An error occurred during analysis'}</p>
                        </div>
                    `;
                } else if (msg.status === "complete") {
                    document.getElementById('medicalAnalysisContent').innerHTML = `
                        <div class="prose dark:prose-invert max-w-none">
                            ${marked.parse(msg.content)}
                        </div>
                    `;
                    if (msg.attachments && msg.attachments.length > 0) {
                        // Handle medical report attachments
                        msg.attachments.forEach(attachment => {
                            if (attachment.isInline) {
                                document.getElementById('medicalAnalysisContent').innerHTML += `
                                    <div class="mt-4">
                                        <img src="${attachment.url}" alt="${attachment.name}" class="max-w-full rounded-lg shadow-lg">
                                    </div>
                                `;
                            }
                        });
                    }
                }
            });
            
            // Research AI Handler
            window.Poe.registerHandler("research-analysis", (result, context) => {
                const msg = result.responses[0];
                if (msg.status === "error") {
                    showNotification('Research analysis failed. Please try again.', 'error');
                } else if (msg.status === "complete") {
                    document.getElementById('researchContent').innerHTML = `
                        <div class="prose dark:prose-invert max-w-none">
                            ${marked.parse(msg.content)}
                        </div>
                    `;
                    document.getElementById('researchResults').classList.remove('hidden');
                }
            });
            
            // Finance AI Handler
            window.Poe.registerHandler("finance-analysis", (result, context) => {
                const msg = result.responses[0];
                addFinanceChatMessage('ai', msg.content, msg.status === "incomplete");
            });
            
            // Calculator AI Handler
            window.Poe.registerHandler("calculator-analysis", (result, context) => {
                const msg = result.responses[0];
                addCalculatorChatMessage('ai', msg.content, msg.status === "incomplete");
            });
            
            // Medical Chat Handler
            window.Poe.registerHandler("medical-chat", (result, context) => {
                const msg = result.responses[0];
                addMedicalChatMessage('ai', msg.content, msg.status === "incomplete");
            });
        }

        // ═══════════════════════════════════════════════════════════════
        // 🏥 MEDICAL AI MODULE
        // ═══════════════════════════════════════════════════════════════
        
        async function handleMedicalFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showMedicalProgress();
            
            const steps = [
                { progress: 20, text: "🔍 AI scanning medical file structure..." },
                { progress: 40, text: "👤 Extracting patient information..." },
                { progress: 60, text: "🧬 Analyzing medical data with AI..." },
                { progress: 80, text: "👨‍⚕️ AI Doctor reviewing results..." },
                { progress: 100, text: "✅ Medical analysis complete!" }
            ];
            
            for (const step of steps) {
                document.getElementById('medicalProgressBar').style.width = step.progress + '%';
                document.getElementById('medicalProgressText').textContent = step.text;
                
                const stepsDiv = document.getElementById('medicalAnalysisSteps');
                stepsDiv.innerHTML += `<div class="text-blue-600 dark:text-blue-400">✓ ${step.text}</div>`;
                
                await new Promise(resolve => setTimeout(resolve, 1500));
            }
            
            // Use AI for real medical analysis
            if (isAIAvailable()) {
                try {
                    const prompt = `@Claude-Sonnet-4 As a medical AI specialist, analyze this medical file: ${file.name}. 

Please provide a comprehensive medical analysis including:

1. **File Type Identification**: Determine if this is a lab result, X-ray, MRI, blood test, etc.
2. **Patient Information**: Extract any patient details (keeping privacy in mind)
3. **Medical Values Analysis**: Analyze all numerical values, ranges, and their clinical significance
4. **Key Findings**: Highlight important or abnormal findings
5. **Health Insights**: Provide clear, understandable explanations
6. **Recommendations**: Suggest next steps or follow-up care
7. **Risk Assessment**: Identify any areas of concern

Format the response professionally with clear sections and use medical terminology explained in layman's terms. Focus on accuracy and helpful insights while maintaining appropriate medical disclaimers.

File Details:
- Name: ${file.name}
- Size: ${(file.size / 1024).toFixed(2)} KB
- Type: ${file.type || 'Unknown'}

NOTE: This is an AI analysis and should not replace professional medical consultation.`;

                    await window.Poe.sendUserMessage(prompt, {
                        handler: "medical-analysis",
                        stream: false,
                        openChat: false,
                        attachments: [file]
                    });
                } catch (error) {
                    showNotification('AI analysis failed. Please try again.', 'error');
                    document.getElementById('medicalAnalysisProgress').classList.add('hidden');
                }
            } else {
                // Fallback demo analysis
                setTimeout(() => {
                    document.getElementById('medicalAnalysisContent').innerHTML = generateDemoMedicalAnalysis(file);
                    showMedicalResults();
                }, 1000);
            }
        }
        
        function showMedicalProgress() {
            document.getElementById('medicalAnalysisProgress').classList.remove('hidden');
            document.getElementById('medicalAnalysisResults').classList.add('hidden');
            document.getElementById('medicalProgressBar').style.width = '0%';
            document.getElementById('medicalAnalysisSteps').innerHTML = '';
        }
        
        function showMedicalResults() {
            document.getElementById('medicalAnalysisProgress').classList.add('hidden');
            document.getElementById('medicalAnalysisResults').classList.remove('hidden');
        }
        
        function generateDemoMedicalAnalysis(file) {
            return `
                <div class="space-y-6">
                    <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-800 dark:text-blue-300 mb-2">📄 File Analysis</h4>
                        <p class="text-blue-700 dark:text-blue-400">
                            <strong>File:</strong> ${file.name}<br>
                            <strong>Type:</strong> ${file.type || 'Medical Document'}<br>
                            <strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB<br>
                            <strong>Analysis Date:</strong> ${new Date().toLocaleString()}
                        </p>
                    </div>
                    
                    <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg">
                        <h4 class="font-bold text-green-800 dark:text-green-300 mb-2">🎯 AI Medical Analysis</h4>
                        <div class="text-green-700 dark:text-green-400">
                            <p class="mb-3">This is a professional demonstration of the HK AI LAB medical analysis system.</p>
                            <p class="mb-3">In the full version with live AI integration, you would see:</p>
                            <ul class="list-disc list-inside space-y-1 mb-3">
                                <li>Complete medical file content extraction</li>
                                <li>Detailed analysis of all lab values and ranges</li>
                                <li>AI-powered health insights and recommendations</li>
                                <li>Risk assessment and clinical correlations</li>
                                <li>Comparison with normal reference ranges</li>
                                <li>Personalized health advice and next steps</li>
                            </ul>
                            <p><strong>Next Steps:</strong> This analysis would be processed by Claude-Sonnet-4 medical AI for comprehensive insights.</p>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 dark:bg-orange-900 p-4 rounded-lg">
                        <h4 class="font-bold text-orange-800 dark:text-orange-300 mb-2">⚠️ Medical Disclaimer</h4>
                        <p class="text-orange-700 dark:text-orange-400 text-sm">
                            This AI analysis is for informational purposes only and should not replace professional medical advice, diagnosis, or treatment. Always consult with qualified healthcare providers for medical decisions.
                        </p>
                    </div>
                </div>
            `;
        }
        
        async function askMedicalQuestion() {
            const question = document.getElementById('medicalQuestionInput').value.trim();
            if (!question) return;
            
            document.getElementById('medicalQuestionInput').value = '';
            addMedicalChatMessage('user', question);
            
            if (isAIAvailable()) {
                try {
                    const prompt = `@Claude-Sonnet-4 As a medical AI assistant, please answer this health question: "${question}"

Provide a comprehensive, accurate response that includes:
1. Clear explanation of the medical topic
2. Relevant health information
3. Practical advice when appropriate
4. Important warnings or considerations
5. When to seek professional medical care

Please maintain a professional medical tone while making the information accessible to patients. Include appropriate medical disclaimers.`;

                    await window.Poe.sendUserMessage(prompt, {
                        handler: "medical-chat",
                        stream: true,
                        openChat: false
                    });
                } catch (error) {
                    addMedicalChatMessage('ai', 'I apologize, but I encountered an error processing your question. Please try again or consult with a healthcare professional.');
                }
            } else {
                // Fallback response
                setTimeout(() => {
                    addMedicalChatMessage('ai', `Thank you for your question about "${question}". In the full version, this would be processed by advanced medical AI to provide comprehensive health insights and recommendations.`);
                }, 1000);
            }
        }
        
        function askQuickMedicalQuestion(question) {
            document.getElementById('medicalQuestionInput').value = question;
            askMedicalQuestion();
        }
        
        function addMedicalChatMessage(sender, message, isTyping = false) {
            const messagesContainer = document.getElementById('medicalChatMessages');
            
            // Clear welcome message
            if (messagesContainer.children.length === 1 && messagesContainer.children[0].classList.contains('text-center')) {
                messagesContainer.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-2 mb-3';
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-user text-white text-xs"></i>
                    </div>
                    <div class="bg-red-100 dark:bg-red-800 rounded-lg p-3 max-w-[80%]">
                        <div class="text-sm text-red-800 dark:text-red-200">${message}</div>
                        <div class="text-xs text-red-600 dark:text-red-400 mt-1">Just now</div>
                    </div>`;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-user-md text-white text-xs"></i>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 max-w-[80%]">
                        <div class="text-sm text-gray-800 dark:text-white">${marked.parse(message)}</div>
                        <div class="text-xs text-gray-500 mt-1">${isTyping ? 'Typing...' : 'Just now'}</div>
                    </div>`;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Toggle Export Menus
        function toggleMedicalExportMenu() {
            const menu = document.getElementById('medicalExportMenu');
            menu.classList.toggle('hidden');
        }
        
        function toggleResearchExportMenu() {
            const menu = document.getElementById('researchExportMenu');
            menu.classList.toggle('hidden');
        }
        
        function toggleFinanceExportMenu() {
            const menu = document.getElementById('financeExportMenu');
            menu.classList.toggle('hidden');
        }
        
        // Close export menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.relative')) {
                document.querySelectorAll('[id$="ExportMenu"]').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        });
        
        // Comprehensive Export Functions
        function exportMedicalResults(format) {
            const content = document.getElementById('medicalAnalysisContent')?.innerHTML || '';
            
            if (!content.trim()) {
                showNotification('No medical analysis available to export', 'error');
                return;
            }
            
            const timestamp = new Date().toISOString().split('T')[0];
            const patientName = currentUser ? currentUser.username : 'Patient';
            
            switch(format) {
                case 'pdf':
                    generateMedicalPDF();
                    break;
                case 'word':
                    exportAsWord(content, `HK_AI_LAB_Medical_Analysis_${patientName}_${timestamp}`, 'Medical Analysis Report');
                    break;
                case 'excel':
                    exportAsExcel(content, `HK_AI_LAB_Medical_Analysis_${patientName}_${timestamp}`, 'Medical');
                    break;
                case 'powerpoint':
                    exportAsPowerPoint(content, `HK_AI_LAB_Medical_Analysis_${patientName}_${timestamp}`, 'Medical AI Analysis');
                    break;
                case 'txt':
                    exportAsText(content, `HK_AI_LAB_Medical_Analysis_${patientName}_${timestamp}`);
                    break;
                case 'json':
                    exportAsJSON(content, `HK_AI_LAB_Medical_Analysis_${patientName}_${timestamp}`, 'medical');
                    break;
                default:
                    showNotification(`Export format ${format} not supported`, 'error');
            }
            
            // Close menu
            document.getElementById('medicalExportMenu').classList.add('hidden');
        }
        
        function exportResearchResults(format) {
            const content = document.getElementById('researchContent')?.innerHTML || '';
            
            if (!content.trim()) {
                showNotification('No research analysis available to export', 'error');
                return;
            }
            
            const timestamp = new Date().toISOString().split('T')[0];
            const topic = document.getElementById('researchTopic')?.value || 'Research';
            const cleanTopic = topic.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 50);
            
            switch(format) {
                case 'pdf':
                    generateResearchPDF();
                    break;
                case 'word':
                    exportAsWord(content, `HK_AI_LAB_Research_${cleanTopic}_${timestamp}`, 'Research Analysis Report');
                    break;
                case 'excel':
                    exportAsExcel(content, `HK_AI_LAB_Research_${cleanTopic}_${timestamp}`, 'Research');
                    break;
                case 'powerpoint':
                    exportAsPowerPoint(content, `HK_AI_LAB_Research_${cleanTopic}_${timestamp}`, 'AI Research Analysis');
                    break;
                case 'txt':
                    exportAsText(content, `HK_AI_LAB_Research_${cleanTopic}_${timestamp}`);
                    break;
                case 'json':
                    exportAsJSON(content, `HK_AI_LAB_Research_${cleanTopic}_${timestamp}`, 'research');
                    break;
                default:
                    showNotification(`Export format ${format} not supported`, 'error');
            }
            
            // Close menu
            document.getElementById('researchExportMenu').classList.add('hidden');
        }
        
        function exportFinanceResults(format) {
            const content = document.getElementById('financeAnalysisContent')?.innerHTML || '';
            
            if (!content.trim()) {
                showNotification('No finance analysis available to export', 'error');
                return;
            }
            
            const timestamp = new Date().toISOString().split('T')[0];
            const userName = currentUser ? currentUser.username : 'User';
            
            switch(format) {
                case 'pdf':
                    generateFinancePDF();
                    break;
                case 'word':
                    exportAsWord(content, `HK_AI_LAB_Finance_Analysis_${userName}_${timestamp}`, 'Financial Analysis Report');
                    break;
                case 'excel':
                    exportAsExcel(content, `HK_AI_LAB_Finance_Analysis_${userName}_${timestamp}`, 'Finance');
                    break;
                case 'powerpoint':
                    exportAsPowerPoint(content, `HK_AI_LAB_Finance_Analysis_${userName}_${timestamp}`, 'AI Financial Analysis');
                    break;
                case 'csv':
                    exportAsCSV(content, `HK_AI_LAB_Finance_Data_${userName}_${timestamp}`);
                    break;
                case 'txt':
                    exportAsText(content, `HK_AI_LAB_Finance_Analysis_${userName}_${timestamp}`);
                    break;
                case 'json':
                    exportAsJSON(content, `HK_AI_LAB_Finance_Analysis_${userName}_${timestamp}`, 'finance');
                    break;
                default:
                    showNotification(`Export format ${format} not supported`, 'error');
            }
            
            // Close menu
            document.getElementById('financeExportMenu').classList.add('hidden');
        }
        
        // Generic Export Functions
        function exportAsWord(htmlContent, filename, title) {
            try {
                // Create Word-compatible HTML
                const wordContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>${title} - HK AI LAB Pro</title>
                        <style>
                            body { font-family: 'Times New Roman', serif; margin: 1in; line-height: 1.5; }
                            h1, h2, h3 { color: #1890ff; page-break-after: avoid; }
                            .header { text-align: center; border-bottom: 2px solid #1890ff; padding-bottom: 10px; margin-bottom: 20px; }
                            .footer { position: fixed; bottom: 0; width: 100%; text-align: center; font-size: 10pt; color: #666; }
                            table { border-collapse: collapse; width: 100%; margin: 10px 0; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); 
                                        font-size: 48pt; color: rgba(24, 144, 255, 0.1); z-index: -1; }
                        </style>
                    </head>
                    <body>
                        <div class="watermark">HK AI LAB PRO</div>
                        
                        <div class="header">
                            <h1>⚕ HK AI LAB PRO</h1>
                            <h2>${title}</h2>
                            <p>Generated: ${new Date().toLocaleString()} | User: ${currentUser ? currentUser.username : 'Unknown'}</p>
                        </div>
                        
                        <div class="content">
                            ${htmlContent}
                        </div>
                        
                        <div class="footer">
                            <p>HK AI LAB Pro - Professional AI Analysis Platform | Contact: hadi.karkaba@gmail.com</p>
                        </div>
                    </body>
                    </html>
                `;
                
                const blob = new Blob([wordContent], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
                downloadBlob(blob, `${filename}.doc`);
                showNotification('Word document generated successfully!', 'success');
                
            } catch (error) {
                console.error('Word export error:', error);
                showNotification('Error generating Word document', 'error');
            }
        }
        
        function exportAsExcel(htmlContent, filename, sheetName) {
            try {
                // Extract text content and create CSV-like data
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                const textContent = tempDiv.textContent || tempDiv.innerText || '';
                
                // Create Excel-compatible HTML
                const excelContent = `
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            table { border-collapse: collapse; width: 100%; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #1890ff; color: white; font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        <table>
                            <tr>
                                <th colspan="3">HK AI LAB Pro - ${sheetName} Analysis</th>
                            </tr>
                            <tr>
                                <td><strong>Generated:</strong></td>
                                <td colspan="2">${new Date().toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td><strong>User:</strong></td>
                                <td colspan="2">${currentUser ? currentUser.username : 'Unknown'}</td>
                            </tr>
                            <tr>
                                <td><strong>Platform:</strong></td>
                                <td colspan="2">HK AI LAB Pro</td>
                            </tr>
                            <tr><td colspan="3"></td></tr>
                            <tr>
                                <th colspan="3">Analysis Content</th>
                            </tr>
                            <tr>
                                <td colspan="3">${textContent}</td>
                            </tr>
                        </table>
                    </body>
                    </html>
                `;
                
                const blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
                downloadBlob(blob, `${filename}.xls`);
                showNotification('Excel file generated successfully!', 'success');
                
            } catch (error) {
                console.error('Excel export error:', error);
                showNotification('Error generating Excel file', 'error');
            }
        }
        
        function exportAsPowerPoint(htmlContent, filename, title) {
            try {
                // Extract sections for slides
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                const sections = tempDiv.textContent.split('\n').filter(line => line.trim());
                
                // Create PowerPoint-compatible HTML
                const pptContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>${title}</title>
                        <style>
                            body { font-family: 'Arial', sans-serif; margin: 0; padding: 20px; }
                            .slide { width: 100%; height: 100vh; padding: 40px; margin-bottom: 50px; 
                                    border: 2px solid #1890ff; background: white; page-break-after: always; }
                            .slide h1 { color: #1890ff; text-align: center; margin-bottom: 30px; }
                            .slide h2 { color: #52c41a; border-bottom: 2px solid #52c41a; padding-bottom: 10px; }
                            .slide-number { position: absolute; bottom: 20px; right: 20px; color: #666; }
                            .title-slide { background: linear-gradient(135deg, #1890ff 0%, #52c41a 100%); color: white; text-align: center; }
                            .title-slide h1 { color: white; font-size: 36pt; margin-top: 200px; }
                        </style>
                    </head>
                    <body>
                        <!-- Title Slide -->
                        <div class="slide title-slide">
                            <h1>${title}</h1>
                            <h2>HK AI LAB Pro Platform</h2>
                            <p style="font-size: 18pt; margin-top: 50px;">Generated: ${new Date().toLocaleString()}</p>
                            <p style="font-size: 14pt;">User: ${currentUser ? currentUser.username : 'Unknown'}</p>
                        </div>
                        
                        <!-- Content Slide -->
                        <div class="slide">
                            <h1>Analysis Results</h1>
                            <div style="font-size: 14pt; line-height: 1.6;">
                                ${htmlContent}
                            </div>
                            <div class="slide-number">2</div>
                        </div>
                        
                        <!-- Summary Slide -->
                        <div class="slide">
                            <h1>Summary & Next Steps</h1>
                            <div style="font-size: 16pt; margin-top: 50px;">
                                <h2>Key Findings:</h2>
                                <ul style="line-height: 2;">
                                    <li>Comprehensive AI analysis completed successfully</li>
                                    <li>Professional insights and recommendations provided</li>
                                    <li>Data analyzed using advanced AI algorithms</li>
                                </ul>
                                
                                <h2 style="margin-top: 50px;">Next Steps:</h2>
                                <ul style="line-height: 2;">
                                    <li>Review analysis results with relevant professionals</li>
                                    <li>Implement recommended actions</li>
                                    <li>Schedule follow-up analysis if needed</li>
                                </ul>
                            </div>
                            <div class="slide-number">3</div>
                        </div>
                    </body>
                    </html>
                `;
                
                const blob = new Blob([pptContent], { type: 'application/vnd.ms-powerpoint' });
                downloadBlob(blob, `${filename}.ppt`);
                showNotification('PowerPoint presentation generated successfully!', 'success');
                
            } catch (error) {
                console.error('PowerPoint export error:', error);
                showNotification('Error generating PowerPoint presentation', 'error');
            }
        }
        
        function exportAsCSV(htmlContent, filename) {
            try {
                // Extract data and create CSV
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                const textContent = tempDiv.textContent || tempDiv.innerText || '';
                
                const csvContent = `"Field","Value"
"Generated","${new Date().toLocaleString()}"
"User","${currentUser ? currentUser.username : 'Unknown'}"
"Platform","HK AI LAB Pro"
"Analysis Type","Finance AI Analysis"
"Content","${textContent.replace(/"/g, '""')}"`;
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                downloadBlob(blob, `${filename}.csv`);
                showNotification('CSV file generated successfully!', 'success');
                
            } catch (error) {
                console.error('CSV export error:', error);
                showNotification('Error generating CSV file', 'error');
            }
        }
        
        function exportAsText(htmlContent, filename) {
            try {
                // Convert HTML to plain text
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                const textContent = tempDiv.textContent || tempDiv.innerText || '';
                
                const txtContent = `HK AI LAB PRO - ANALYSIS REPORT
==========================================

Generated: ${new Date().toLocaleString()}
User: ${currentUser ? currentUser.username : 'Unknown'}
Platform: HK AI LAB Pro
Contact: hadi.karkaba@gmail.com

ANALYSIS CONTENT:
${textContent}

==========================================
This analysis was generated by HK AI LAB Pro
Professional AI-Powered Analysis Platform
`;
                
                const blob = new Blob([txtContent], { type: 'text/plain' });
                downloadBlob(blob, `${filename}.txt`);
                showNotification('Text file generated successfully!', 'success');
                
            } catch (error) {
                console.error('Text export error:', error);
                showNotification('Error generating text file', 'error');
            }
        }
        
        function exportAsJSON(htmlContent, filename, analysisType) {
            try {
                // Extract text content
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                const textContent = tempDiv.textContent || tempDiv.innerText || '';
                
                const jsonData = {
                    metadata: {
                        platform: "HK AI LAB Pro",
                        version: "2.0.0-pro",
                        generated: new Date().toISOString(),
                        user: currentUser ? currentUser.username : 'Unknown',
                        analysisType: analysisType,
                        contact: "hadi.karkaba@gmail.com"
                    },
                    analysis: {
                        htmlContent: htmlContent,
                        textContent: textContent,
                        timestamp: Date.now()
                    },
                    userInfo: currentUser ? {
                        username: currentUser.username,
                        role: currentUser.role,
                        loginCount: currentUser.loginCount
                    } : null,
                    exportInfo: {
                        exportedAt: new Date().toISOString(),
                        format: "JSON",
                        filename: filename
                    }
                };
                
                const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
                downloadBlob(blob, `${filename}.json`);
                showNotification('JSON file generated successfully!', 'success');
                
            } catch (error) {
                console.error('JSON export error:', error);
                showNotification('Error generating JSON file', 'error');
            }
        }
        
        // PDF Generation for Research and Finance
        function generateResearchPDF() {
            if (typeof window.jsPDF === 'undefined') {
                showNotification('PDF library not loaded. Please try again.', 'error');
                return;
            }
            
            const content = document.getElementById('researchContent');
            if (!content || content.innerHTML.trim() === '') {
                showNotification('No research analysis available to export', 'error');
                return;
            }
            
            try {
                const { jsPDF } = window.jsPDF;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Add content similar to medical PDF but for research
                const topic = document.getElementById('researchTopic')?.value || 'Research Analysis';
                const timestamp = new Date().toISOString().split('T')[0];
                
                // Add header, content, and footer (similar to medical PDF structure)
                doc.text('HK AI LAB PRO - RESEARCH ANALYSIS', 20, 20);
                doc.text(`Topic: ${topic}`, 20, 40);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 50);
                
                const filename = `HK_AI_LAB_Research_${topic.replace(/[^a-zA-Z0-9]/g, '_')}_${timestamp}.pdf`;
                doc.save(filename);
                
                showNotification('Research PDF generated successfully!', 'success');
                
            } catch (error) {
                console.error('Research PDF generation error:', error);
                showNotification('Error generating research PDF', 'error');
            }
        }
        
        function generateFinancePDF() {
            if (typeof window.jsPDF === 'undefined') {
                showNotification('PDF library not loaded. Please try again.', 'error');
                return;
            }
            
            const content = document.getElementById('financeAnalysisContent');
            if (!content || content.innerHTML.trim() === '') {
                showNotification('No finance analysis available to export', 'error');
                return;
            }
            
            try {
                const { jsPDF } = window.jsPDF;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const timestamp = new Date().toISOString().split('T')[0];
                const userName = currentUser ? currentUser.username : 'User';
                
                // Add header, content, and footer (similar to medical PDF structure)
                doc.text('HK AI LAB PRO - FINANCIAL ANALYSIS', 20, 20);
                doc.text(`User: ${userName}`, 20, 40);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 50);
                
                const filename = `HK_AI_LAB_Finance_Analysis_${userName}_${timestamp}.pdf`;
                doc.save(filename);
                
                showNotification('Finance PDF generated successfully!', 'success');
                
            } catch (error) {
                console.error('Finance PDF generation error:', error);
                showNotification('Error generating finance PDF', 'error');
            }
        }
        
        // Utility function for downloading blobs
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Share functions for Finance
        function shareFinanceAnalysis() {
            showNotification('Finance analysis prepared for sharing', 'success');
        }
        
        function shareWithDoctor() {
            showNotification('Medical analysis prepared for sharing with healthcare provider', 'success');
        }
        
        // ═══════════════════════════════════════════════════════════════
        // 📄 PROFESSIONAL PDF GENERATION SYSTEM
        // ═══════════════════════════════════════════════════════════════
        
        function generateMedicalPDF() {
            // Check if jsPDF is available
            if (typeof window.jsPDF === 'undefined') {
                showNotification('PDF library not loaded. Please try again.', 'error');
                return;
            }
            
            const analysisContent = document.getElementById('medicalAnalysisContent');
            if (!analysisContent || analysisContent.innerHTML.trim() === '') {
                showNotification('No medical analysis available to export', 'error');
                return;
            }
            
            try {
                // Create PDF document
                const { jsPDF } = window.jsPDF;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // PDF Configuration
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                const contentWidth = pageWidth - 2 * margin;
                let currentY = margin;
                
                // Colors
                const primaryColor = [24, 144, 255]; // #1890ff
                const secondaryColor = [82, 196, 26]; // #52c41a
                const textColor = [51, 51, 51]; // #333333
                const grayColor = [128, 128, 128]; // #808080
                
                // Professional Header
                function addHeader() {
                    // Logo background
                    doc.setFillColor(...primaryColor);
                    doc.rect(margin, currentY, contentWidth, 25, 'F');
                    
                    // Logo text
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text('HK AI LAB PRO', margin + 10, currentY + 10);
                    
                    // Subtitle
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Professional AI-Powered Medical Analysis Report', margin + 10, currentY + 18);
                    
                    // Medical symbol
                    doc.setFontSize(16);
                    doc.text('⚕', pageWidth - margin - 15, currentY + 12);
                    
                    currentY += 35;
                }
                
                // Report Information Box
                function addReportInfo() {
                    const boxHeight = 35;
                    
                    // Background box
                    doc.setFillColor(248, 249, 250);
                    doc.setDrawColor(229, 231, 235);
                    doc.rect(margin, currentY, contentWidth, boxHeight, 'FD');
                    
                    // Report details
                    doc.setTextColor(...textColor);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('MEDICAL ANALYSIS REPORT', margin + 10, currentY + 10);
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    
                    const reportDate = new Date().toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    doc.text(`Report Generated: ${reportDate}`, margin + 10, currentY + 18);
                    doc.text(`Patient/User: ${currentUser ? currentUser.username : 'Unknown'}`, margin + 10, currentY + 24);
                    doc.text(`Analysis ID: HK-${Date.now().toString(36).toUpperCase()}`, margin + 10, currentY + 30);
                    
                    // Status indicator
                    doc.setFillColor(...secondaryColor);
                    doc.circle(pageWidth - margin - 20, currentY + 15, 3, 'F');
                    doc.setTextColor(...secondaryColor);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text('COMPLETED', pageWidth - margin - 35, currentY + 18);
                    
                    currentY += boxHeight + 15;
                }
                
                // Extract and format content
                function addAnalysisContent() {
                    doc.setTextColor(...textColor);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('AI MEDICAL ANALYSIS RESULTS', margin, currentY);
                    currentY += 10;
                    
                    // Add separator line
                    doc.setDrawColor(...primaryColor);
                    doc.setLineWidth(0.5);
                    doc.line(margin, currentY, pageWidth - margin, currentY);
                    currentY += 8;
                    
                    // Extract text from HTML content
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = analysisContent.innerHTML;
                    
                    // Remove HTML tags and get clean text
                    const textContent = tempDiv.textContent || tempDiv.innerText || '';
                    const sections = textContent.split('\n').filter(line => line.trim());
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    
                    sections.forEach(section => {
                        const trimmedSection = section.trim();
                        if (trimmedSection) {
                            // Check if it's a heading (contains certain keywords)
                            const isHeading = trimmedSection.includes('File Analysis') || 
                                            trimmedSection.includes('AI Medical Analysis') || 
                                            trimmedSection.includes('Medical Disclaimer') ||
                                            trimmedSection.match(/^\d+\./); // Numbered sections
                            
                            if (isHeading) {
                                // Add some space before headings
                                currentY += 5;
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(11);
                            } else {
                                doc.setFont('helvetica', 'normal');
                                doc.setFontSize(9);
                            }
                            
                            // Split long lines to fit page width
                            const lines = doc.splitTextToSize(trimmedSection, contentWidth - 10);
                            
                            // Check if we need a new page
                            if (currentY + (lines.length * 5) > pageHeight - margin) {
                                doc.addPage();
                                currentY = margin;
                                addWatermark();
                            }
                            
                            // Add the text
                            lines.forEach(line => {
                                doc.text(line, margin + 5, currentY);
                                currentY += 5;
                            });
                            
                            currentY += 2; // Extra spacing between sections
                        }
                    });
                }
                
                // Professional footer
                function addFooter() {
                    const footerY = pageHeight - 20;
                    
                    // Footer line
                    doc.setDrawColor(...grayColor);
                    doc.setLineWidth(0.3);
                    doc.line(margin, footerY - 5, pageWidth - margin, footerY - 5);
                    
                    // Footer text
                    doc.setTextColor(...grayColor);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    
                    doc.text('HK AI LAB Pro - Professional AI Medical Analysis Platform', margin, footerY);
                    doc.text('⚠ This AI analysis is for informational purposes only. Consult healthcare professionals for medical decisions.', margin, footerY + 4);
                    
                    // Page number
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.text(`Page ${i} of ${pageCount}`, pageWidth - margin - 20, footerY);
                    }
                }
                
                // Watermark for professional look
                function addWatermark() {
                    doc.saveGraphicsState();
                    doc.setGState(new doc.GState({opacity: 0.1}));
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(50);
                    doc.setFont('helvetica', 'bold');
                    
                    // Center the watermark
                    const text = 'HK AI LAB';
                    const textWidth = doc.getTextWidth(text);
                    const textX = (pageWidth - textWidth) / 2;
                    const textY = pageHeight / 2;
                    
                    doc.text(text, textX, textY, {angle: 45});
                    doc.restoreGraphicsState();
                }
                
                // Medical disclaimer box
                function addDisclaimer() {
                    currentY += 10;
                    const disclaimerHeight = 25;
                    
                    // Disclaimer box
                    doc.setFillColor(255, 243, 205); // Light orange background
                    doc.setDrawColor(255, 173, 51); // Orange border
                    doc.setLineWidth(0.5);
                    doc.rect(margin, currentY, contentWidth, disclaimerHeight, 'FD');
                    
                    // Warning icon and text
                    doc.setTextColor(180, 83, 9); // Dark orange text
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('⚠ MEDICAL DISCLAIMER', margin + 5, currentY + 8);
                    
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    const disclaimerText = 'This AI-generated analysis is for informational purposes only and should not replace professional medical advice, diagnosis, or treatment. Always consult with qualified healthcare providers for medical decisions. HK AI LAB Pro is not responsible for medical decisions based on this analysis.';
                    
                    const disclaimerLines = doc.splitTextToSize(disclaimerText, contentWidth - 10);
                    disclaimerLines.forEach((line, index) => {
                        doc.text(line, margin + 5, currentY + 14 + (index * 4));
                    });
                    
                    currentY += disclaimerHeight + 10;
                }
                
                // Build the PDF
                addHeader();
                addReportInfo();
                addWatermark();
                addAnalysisContent();
                addDisclaimer();
                addFooter();
                
                // Generate filename
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `HK_AI_LAB_Medical_Analysis_${timestamp}.pdf`;
                
                // Save the PDF
                doc.save(filename);
                
                showNotification('Professional medical report generated successfully!', 'success');
                
                // Show print option
                setTimeout(() => {
                    showPrintOptions(doc, filename);
                }, 1000);
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showNotification('Error generating PDF. Please try again.', 'error');
            }
        }
        
        function showPrintOptions(pdfDoc, filename) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-gray-200 dark:border-gray-700">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-green-500 to-blue-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-pdf text-3xl text-white"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Medical Report Generated</h3>
                        <p class="text-gray-600 dark:text-gray-400">Professional PDF report created successfully</p>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Report Info -->
                        <div class="bg-green-50 dark:bg-green-900 p-3 rounded-lg border border-green-200 dark:border-green-700">
                            <div class="flex items-center text-sm text-green-700 dark:text-green-300">
                                <i class="fas fa-check-circle mr-2 text-green-500"></i>
                                <div>
                                    <div class="font-semibold">${filename}</div>
                                    <div class="text-xs">Professional medical analysis report</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="printMedicalReport('${filename}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105 flex items-center justify-center">
                                <i class="fas fa-print mr-2"></i>
                                Print Report
                            </button>
                            
                            <button onclick="openPDFPreview('${filename}')" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center">
                                <i class="fas fa-eye mr-2"></i>
                                Preview PDF
                            </button>
                            
                            <button onclick="shareMedicalReport('${filename}')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center">
                                <i class="fas fa-share mr-2"></i>
                                Share with Doctor
                            </button>
                        </div>
                        
                        <!-- Professional Features -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                            <h4 class="font-bold text-gray-800 dark:text-white mb-2 text-sm">
                                <i class="fas fa-certificate mr-1 text-yellow-500"></i>Professional Features
                            </h4>
                            <div class="grid grid-cols-2 gap-2 text-xs text-gray-600 dark:text-gray-400">
                                <div class="flex items-center">
                                    <i class="fas fa-check mr-1 text-green-500"></i>
                                    Medical-grade formatting
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-check mr-1 text-green-500"></i>
                                    AI analysis timestamp
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-check mr-1 text-green-500"></i>
                                    Professional disclaimers
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-check mr-1 text-green-500"></i>
                                    Print-ready layout
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-times mr-2"></i>Close
                        </button>
                        <button onclick="generateAnotherReport()" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-colors">
                            <i class="fas fa-redo mr-2"></i>New Analysis
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function printMedicalReport(filename) {
            try {
                // Create a new window for printing
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    showNotification('Please allow popups to print the report', 'warning');
                    return;
                }
                
                // Get the analysis content
                const analysisContent = document.getElementById('medicalAnalysisContent');
                const patientInfo = currentUser ? currentUser.username : 'Unknown Patient';
                const reportDate = new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Create professional print layout
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>HK AI LAB Medical Report - ${filename}</title>
                        <style>
                            @media print {
                                @page {
                                    margin: 1in;
                                    size: A4;
                                }
                                body { margin: 0; }
                            }
                            
                            body {
                                font-family: 'Arial', sans-serif;
                                line-height: 1.6;
                                color: #333;
                                max-width: 800px;
                                margin: 0 auto;
                                padding: 20px;
                            }
                            
                            .header {
                                background: linear-gradient(135deg, #1890ff 0%, #52c41a 100%);
                                color: white;
                                padding: 20px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                                text-align: center;
                            }
                            
                            .header h1 {
                                margin: 0;
                                font-size: 24px;
                                font-weight: bold;
                            }
                            
                            .header p {
                                margin: 5px 0 0 0;
                                font-size: 14px;
                                opacity: 0.9;
                            }
                            
                            .report-info {
                                background: #f8f9fa;
                                border: 1px solid #e9ecef;
                                border-radius: 8px;
                                padding: 15px;
                                margin-bottom: 20px;
                            }
                            
                            .report-info h2 {
                                margin: 0 0 10px 0;
                                color: #1890ff;
                                font-size: 16px;
                            }
                            
                            .info-grid {
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 10px;
                                font-size: 14px;
                            }
                            
                            .analysis-content {
                                background: white;
                                border: 1px solid #e9ecef;
                                border-radius: 8px;
                                padding: 20px;
                                margin-bottom: 20px;
                            }
                            
                            .analysis-content h3 {
                                color: #1890ff;
                                border-bottom: 2px solid #1890ff;
                                padding-bottom: 5px;
                                margin-bottom: 15px;
                            }
                            
                            .disclaimer {
                                background: #fff3cd;
                                border: 1px solid #ffeaa7;
                                border-radius: 8px;
                                padding: 15px;
                                margin-top: 20px;
                            }
                            
                            .disclaimer h4 {
                                color: #856404;
                                margin: 0 0 10px 0;
                                font-size: 14px;
                            }
                            
                            .disclaimer p {
                                color: #856404;
                                font-size: 12px;
                                margin: 0;
                            }
                            
                            .footer {
                                text-align: center;
                                margin-top: 30px;
                                padding-top: 20px;
                                border-top: 1px solid #e9ecef;
                                font-size: 12px;
                                color: #666;
                            }
                            
                            .watermark {
                                position: fixed;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%) rotate(-45deg);
                                font-size: 60px;
                                color: rgba(24, 144, 255, 0.1);
                                font-weight: bold;
                                z-index: -1;
                                pointer-events: none;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="watermark">HK AI LAB PRO</div>
                        
                        <div class="header">
                            <h1>⚕ HK AI LAB PRO</h1>
                            <p>Professional AI-Powered Medical Analysis Report</p>
                        </div>
                        
                        <div class="report-info">
                            <h2>📋 Medical Analysis Report</h2>
                            <div class="info-grid">
                                <div><strong>Patient/User:</strong> ${patientInfo}</div>
                                <div><strong>Report ID:</strong> HK-${Date.now().toString(36).toUpperCase()}</div>
                                <div><strong>Generated:</strong> ${reportDate}</div>
                                <div><strong>Status:</strong> ✅ Analysis Complete</div>
                            </div>
                        </div>
                        
                        <div class="analysis-content">
                            <h3>🔬 AI Medical Analysis Results</h3>
                            ${analysisContent.innerHTML}
                        </div>
                        
                        <div class="disclaimer">
                            <h4>⚠️ IMPORTANT MEDICAL DISCLAIMER</h4>
                            <p>This AI-generated analysis is for informational purposes only and should not replace professional medical advice, diagnosis, or treatment. Always consult with qualified healthcare providers for medical decisions. HK AI LAB Pro is not responsible for medical decisions based solely on this analysis.</p>
                        </div>
                        
                        <div class="footer">
                            <p><strong>HK AI LAB Pro</strong> - Professional AI Medical Analysis Platform</p>
                            <p>Generated on ${reportDate} | Contact: hadi.karkaba@gmail.com</p>
                        </div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                
                // Wait for content to load, then print
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        showNotification('Medical report sent to printer', 'success');
                    }, 500);
                };
                
            } catch (error) {
                console.error('Print error:', error);
                showNotification('Error printing report. Please try again.', 'error');
            }
        }
        
        function openPDFPreview(filename) {
            showNotification('PDF preview feature would open the generated report in a new window', 'info');
        }
        
        function shareMedicalReport(filename) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-gray-200 dark:border-gray-700">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-blue-500 to-green-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-user-md text-3xl text-white"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Share Medical Report</h3>
                        <p class="text-gray-600 dark:text-gray-400">Send professional analysis to healthcare provider</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded-lg border border-blue-200 dark:border-blue-700">
                            <div class="flex items-center text-sm text-blue-700 dark:text-blue-300">
                                <i class="fas fa-file-pdf mr-2 text-blue-500"></i>
                                <div>
                                    <div class="font-semibold">${filename}</div>
                                    <div class="text-xs">Ready for professional consultation</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="shareViaEmail('${filename}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center">
                                <i class="fas fa-envelope mr-2"></i>
                                Email to Doctor
                            </button>
                            
                            <button onclick="shareViaWhatsApp('${filename}')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center">
                                <i class="fab fa-whatsapp mr-2"></i>
                                Send via WhatsApp
                            </button>
                            
                            <button onclick="copyShareableLink('${filename}')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center">
                                <i class="fas fa-link mr-2"></i>
                                Copy Shareable Link
                            </button>
                        </div>
                    </div>
                    
                    <button onclick="this.closest('.fixed').remove()" class="w-full mt-4 px-4 py-2 text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function shareViaEmail(filename) {
            // Create enhanced email sharing modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-full mx-4 border border-gray-200 dark:border-gray-700">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-blue-500 to-green-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-envelope text-3xl text-white"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Email Medical Report</h3>
                        <p class="text-gray-600 dark:text-gray-400">Share professional analysis with healthcare provider</p>
                    </div>
                    
                    <form id="emailShareForm" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                <i class="fas fa-user-md mr-2 text-blue-500"></i>Doctor's Email Address
                            </label>
                            <input type="email" id="doctorEmail" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="doctor@hospital.com" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                <i class="fas fa-user mr-2 text-green-500"></i>Your Name
                            </label>
                            <input type="text" id="patientName" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Your full name" value="${currentUser ? currentUser.username : ''}" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                <i class="fas fa-comment mr-2 text-purple-500"></i>Additional Message (Optional)
                            </label>
                            <textarea id="additionalMessage" rows="3" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none" placeholder="Any specific questions or concerns you'd like to share..."></textarea>
                        </div>
                        
                        <!-- Email Preview -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600">
                            <h4 class="font-bold text-gray-800 dark:text-white mb-2 text-sm">
                                <i class="fas fa-eye mr-1 text-blue-500"></i>Email Preview
                            </h4>
                            <div class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                <div><strong>Subject:</strong> Medical Analysis Report - HK AI LAB Pro</div>
                                <div><strong>Report:</strong> ${filename}</div>
                                <div><strong>Generated:</strong> ${new Date().toLocaleString()}</div>
                                <div><strong>Platform:</strong> HK AI LAB Pro - Professional AI Medical Analysis</div>
                            </div>
                        </div>
                        
                        <!-- Email Options -->
                        <div class="space-y-3">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="copyToSelf" class="rounded">
                                <label for="copyToSelf" class="text-sm text-gray-700 dark:text-gray-300">Send a copy to yourself</label>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="urgentFlag" class="rounded">
                                <label for="urgentFlag" class="text-sm text-gray-700 dark:text-gray-300">Mark as urgent/priority</label>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">
                                <i class="fas fa-times mr-2"></i>Cancel
                            </button>
                            <button type="submit" class="flex-1 px-4 py-3 bg-gradient-to-r from-blue-500 to-green-500 hover:from-blue-600 hover:to-green-600 text-white rounded-lg font-semibold transition-all duration-200 transform hover:scale-105">
                                <i class="fas fa-paper-plane mr-2"></i>Send Email
                            </button>
                        </div>
                        
                        <!-- Professional Note -->
                        <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900 rounded-lg border border-blue-200 dark:border-blue-700">
                            <div class="flex items-start text-sm text-blue-700 dark:text-blue-300">
                                <i class="fas fa-info-circle mr-2 text-blue-500 mt-0.5"></i>
                                <span>The PDF report will need to be manually attached to the email. This system generates the professional email content and opens your default email client.</span>
                            </div>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up form handler
            document.getElementById('emailShareForm').addEventListener('submit', (e) => handleEmailShare(e, filename));
            
            // Focus on doctor email field
            setTimeout(() => {
                document.getElementById('doctorEmail').focus();
            }, 100);
        }
        
        function handleEmailShare(event, filename) {
            event.preventDefault();
            
            const doctorEmail = document.getElementById('doctorEmail').value.trim();
            const patientName = document.getElementById('patientName').value.trim();
            const additionalMessage = document.getElementById('additionalMessage').value.trim();
            const copyToSelf = document.getElementById('copyToSelf').checked;
            const urgentFlag = document.getElementById('urgentFlag').checked;
            
            if (!doctorEmail || !patientName) {
                showNotification('Please fill in doctor email and your name', 'error');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(doctorEmail)) {
                showNotification('Please enter a valid email address', 'error');
                document.getElementById('doctorEmail').focus();
                return;
            }
            
            // Build professional email
            const urgentText = urgentFlag ? '[URGENT] ' : '';
            const subject = encodeURIComponent(`${urgentText}Medical Analysis Report - ${patientName} - HK AI LAB Pro`);
            
            let emailBody = `Dear Doctor,

I hope this email finds you well. I am reaching out to share my recent medical analysis report generated using HK AI LAB Pro, an advanced artificial intelligence medical analysis platform.

📋 PATIENT INFORMATION:
• Patient Name: ${patientName}
• Report Generated: ${new Date().toLocaleString()}
• Report ID: HK-${Date.now().toString(36).toUpperCase()}
• Platform: HK AI LAB Pro - Professional AI Medical Analysis

📄 ATTACHED REPORT:
• File: ${filename}
• Format: Professional PDF with comprehensive AI analysis
• Content: Detailed medical data analysis and AI-generated insights

🔬 REPORT INCLUDES:
• Comprehensive file analysis and data extraction
• AI-powered medical insights and interpretations  
• Risk assessment and clinical correlations
• Professional recommendations and next steps
• Reference ranges and comparative analysis

`;

            if (additionalMessage) {
                emailBody += `💬 ADDITIONAL INFORMATION:
${additionalMessage}

`;
            }

            emailBody += `🎯 PURPOSE:
This AI analysis is provided to assist in our medical consultation and to give you comprehensive insights into my health data. I understand that this is for informational purposes only and does not replace your professional medical judgment.

⚕️ REQUEST:
Could we please schedule a consultation to discuss these findings? I would greatly appreciate your professional review and medical opinion on the AI analysis results.

📞 NEXT STEPS:
I am available for a consultation at your earliest convenience. Please let me know your preferred time, and I will arrange accordingly.

Thank you for your time, expertise, and continued care.

Best regards,
${patientName}

---
📧 Email generated by HK AI LAB Pro
🏥 Professional AI Medical Analysis Platform
⚠️  IMPORTANT: This AI analysis is for informational purposes only. Always consult with healthcare professionals for medical decisions.
📞 Support: hadi.karkaba@gmail.com

Generated on: ${new Date().toLocaleString()}`;

            // Handle CC to self
            const ccEmail = copyToSelf && currentUser ? `&cc=${encodeURIComponent(currentUser.username + '@example.com')}` : '';
            
            const mailtoLink = `mailto:${encodeURIComponent(doctorEmail)}?subject=${subject}&body=${encodeURIComponent(emailBody)}${ccEmail}`;
            
            // Open email client
            window.open(mailtoLink, '_blank');
            
            // Close modal
            document.querySelector('.fixed.inset-0').remove();
            
            // Show success message with instructions
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-gray-200 dark:border-gray-700">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-green-500 to-blue-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-check-circle text-3xl text-white"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Email Prepared Successfully</h3>
                        <p class="text-gray-600 dark:text-gray-400">Professional email opened in your default email client</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-green-50 dark:bg-green-900 p-3 rounded-lg border border-green-200 dark:border-green-700">
                            <div class="text-sm text-green-700 dark:text-green-300">
                                <div class="font-semibold mb-1">✅ Email Details:</div>
                                <div>• To: ${doctorEmail}</div>
                                <div>• Patient: ${patientName}</div>
                                <div>• Report: ${filename}</div>
                                ${urgentFlag ? '<div>• Priority: URGENT</div>' : ''}
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded-lg border border-blue-200 dark:border-blue-700">
                            <div class="text-sm text-blue-700 dark:text-blue-300">
                                <div class="font-semibold mb-2">📎 Next Steps:</div>
                                <ol class="list-decimal list-inside space-y-1 text-xs">
                                    <li>Your email client should now be open</li>
                                    <li>Attach the PDF report (${filename})</li>
                                    <li>Review the email content</li>
                                    <li>Send the email to your doctor</li>
                                </ol>
                            </div>
                        </div>
                        
                        ${copyToSelf ? `
                        <div class="bg-purple-50 dark:bg-purple-900 p-3 rounded-lg border border-purple-200 dark:border-purple-700">
                            <div class="text-sm text-purple-700 dark:text-purple-300">
                                <i class="fas fa-copy mr-1"></i>
                                A copy will be sent to yourself for your records.
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-check mr-2"></i>Done
                        </button>
                        <button onclick="shareViaEmail('${filename}'); this.closest('.fixed').remove();" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-colors">
                            <i class="fas fa-redo mr-2"></i>Send Another
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            showNotification('Professional email generated and opened in your email client', 'success');
        }
        
        function shareViaWhatsApp(filename) {
            const message = encodeURIComponent(`🏥 Medical Report - HK AI LAB Pro

Dear Doctor,

I have generated a comprehensive medical analysis report using AI technology that I would like to share for your professional review.

📋 Report: ${filename}
👤 Patient: ${currentUser ? currentUser.username : 'Patient'}  
📅 Date: ${new Date().toLocaleDateString()}
🤖 Platform: HK AI LAB Pro

The AI analysis includes detailed findings and recommendations. I understand this is for informational purposes only and does not replace your professional medical judgment.

Could we schedule a consultation to discuss these findings?

Thank you for your time.`);
            
            window.open(`https://wa.me/?text=${message}`, '_blank');
            showNotification('WhatsApp message prepared. Please send to your doctor.', 'success');
        }
        
        function copyShareableLink(filename) {
            const shareableText = `🏥 Medical Analysis Report - HK AI LAB Pro

Report: ${filename}
Patient: ${currentUser ? currentUser.username : 'Patient'}
Generated: ${new Date().toLocaleString()}

This professional medical analysis was generated using advanced AI technology for informational purposes. Please consult with healthcare professionals for medical decisions.

Platform: HK AI LAB Pro - Professional AI Medical Analysis`;
            
            navigator.clipboard.writeText(shareableText).then(() => {
                showNotification('Shareable information copied to clipboard', 'success');
            }).catch(() => {
                showNotification('Could not copy to clipboard. Please copy manually.', 'warning');
            });
        }
        
        function generateAnotherReport() {
            // Close all modals
            document.querySelectorAll('.modal-overlay').forEach(modal => modal.remove());
            
            // Reset the medical analysis
            document.getElementById('medicalAnalysisResults').classList.add('hidden');
            document.getElementById('medicalAnalysisProgress').classList.add('hidden');
            document.getElementById('medicalFileInput').value = '';
            
            showNotification('Ready for new medical analysis', 'info');
        }

        // ═══════════════════════════════════════════════════════════════
        // 🔬 RESEARCH AI MODULE
        // ═══════════════════════════════════════════════════════════════
        
        function selectResearchType(type) {
            selectedResearchType = type;
            
            // Update UI
            document.querySelectorAll('.research-type-btn').forEach(btn => {
                btn.classList.remove('border-red-500', 'border-blue-500', 'border-green-500', 'border-purple-500');
                btn.classList.add('border-gray-200', 'dark:border-gray-600');
            });
            
            const selectedBtn = event.target.closest('.research-type-btn');
            if (selectedBtn) {
                const colors = {
                    'medical': 'border-red-500',
                    'scientific': 'border-blue-500',
                    'business': 'border-green-500',
                    'technology': 'border-purple-500'
                };
                selectedBtn.classList.remove('border-gray-200', 'dark:border-gray-600');
                selectedBtn.classList.add(colors[type]);
            }
        }
        
        async function startAdvancedResearch() {
            const topic = document.getElementById('researchTopic').value.trim();
            const details = document.getElementById('researchDetails').value.trim();
            const depth = document.getElementById('researchDepth').value;
            
            if (!topic) {
                showNotification('Please enter a research topic', 'error');
                return;
            }
            
            showResearchProgress();
            
            // Simulate progress
            const steps = [
                { progress: 20, text: "🔍 Analyzing research topic and objectives..." },
                { progress: 40, text: "📚 Searching specialized databases and literature..." },
                { progress: 60, text: "🧠 AI processing and organizing information..." },
                { progress: 80, text: "📝 Generating comprehensive analysis..." },
                { progress: 100, text: "✅ Research analysis complete!" }
            ];
            
            for (const step of steps) {
                document.getElementById('researchProgressBar').style.width = step.progress + '%';
                document.getElementById('researchProgressText').textContent = step.text;
                
                const stepsDiv = document.getElementById('researchSteps');
                stepsDiv.innerHTML += `<div class="text-blue-600 dark:text-blue-400">✓ ${step.text}</div>`;
                
                await new Promise(resolve => setTimeout(resolve, 1500));
            }
            
            if (isAIAvailable()) {
                try {
                    const prompt = `@Claude-Sonnet-4 As an expert research assistant, conduct a comprehensive ${depth} research analysis on the topic: "${topic}"

Research Type: ${selectedResearchType}
${details ? `Additional Details: ${details}` : ''}

Please provide a thorough research analysis including:

1. **Executive Summary**: Overview of the research topic and key findings
2. **Background & Context**: Current state of knowledge in this field
3. **Key Findings**: Most important discoveries and insights
4. **Methodology**: Research approaches and data sources used
5. **Analysis & Discussion**: Critical evaluation of findings
6. **Implications**: Practical applications and significance
7. **Future Directions**: Recommendations for further research
8. **Conclusion**: Summary of main takeaways

Format the response professionally with clear headings and structure. Use academic language while keeping it accessible. Include relevant statistics, studies, and evidence where appropriate.

Research Depth Level: ${depth}
Expected Length: ${depth === 'comprehensive' ? 'Extensive' : depth === 'detailed' ? 'Detailed' : 'Concise'}`;

                    await window.Poe.sendUserMessage(prompt, {
                        handler: "research-analysis",
                        stream: false,
                        openChat: false
                    });
                } catch (error) {
                    showNotification('Research analysis failed. Please try again.', 'error');
                    hideResearchProgress();
                }
            } else {
                // Fallback demo
                setTimeout(() => {
                    document.getElementById('researchContent').innerHTML = generateDemoResearch(topic, details, depth);
                    showResearchResults();
                }, 1000);
            }
        }
        
        function showResearchProgress() {
            document.getElementById('researchTemplates').classList.add('hidden');
            document.getElementById('researchProgress').classList.remove('hidden');
            document.getElementById('researchResults').classList.add('hidden');
            document.getElementById('researchProgressBar').style.width = '0%';
            document.getElementById('researchSteps').innerHTML = '';
        }
        
        function hideResearchProgress() {
            document.getElementById('researchProgress').classList.add('hidden');
            document.getElementById('researchTemplates').classList.remove('hidden');
        }
        
        function showResearchResults() {
            document.getElementById('researchProgress').classList.add('hidden');
            document.getElementById('researchResults').classList.remove('hidden');
        }
        
        function generateDemoResearch(topic, details, depth) {
            return `
                <div class="space-y-6">
                    <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-800 dark:text-blue-300 mb-2">📋 Research Overview</h4>
                        <div class="text-blue-700 dark:text-blue-400">
                            <p><strong>Topic:</strong> ${topic}</p>
                            <p><strong>Type:</strong> ${selectedResearchType.charAt(0).toUpperCase() + selectedResearchType.slice(1)} Research</p>
                            <p><strong>Depth:</strong> ${depth.charAt(0).toUpperCase() + depth.slice(1)} Analysis</p>
                            <p><strong>Analysis Date:</strong> ${new Date().toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg">
                        <h4 class="font-bold text-green-800 dark:text-green-300 mb-2">🎯 AI Research Analysis</h4>
                        <div class="text-green-700 dark:text-green-400">
                            <p class="mb-3">Professional demonstration of HK AI LAB research capabilities.</p>
                            <p class="mb-3">With live AI integration, this analysis would include:</p>
                            <ul class="list-disc list-inside space-y-1 mb-3">
                                <li>Comprehensive literature review and analysis</li>
                                <li>Current research trends and findings</li>
                                <li>Expert insights and professional recommendations</li>
                                <li>Statistical analysis and data visualization</li>
                                <li>Multi-language research capabilities</li>
                                <li>Academic citation and reference management</li>
                            </ul>
                            <p><strong>AI Model:</strong> Research would be processed by Claude-Sonnet-4 for academic-quality insights.</p>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg">
                        <h4 class="font-bold text-purple-800 dark:text-purple-300 mb-2">📊 Expected Deliverables</h4>
                        <div class="text-purple-700 dark:text-purple-400">
                            <ul class="list-disc list-inside space-y-1">
                                <li>Executive summary with key findings</li>
                                <li>Detailed methodology and data sources</li>
                                <li>Professional conclusions and recommendations</li>
                                <li>Export options: PDF, Word, PowerPoint</li>
                                <li>Citation-ready academic formatting</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadResearchTemplate(type) {
            const templates = {
                'literature': {
                    topic: 'Systematic Literature Review on Machine Learning in Healthcare',
                    details: 'Conduct a comprehensive review of recent literature on ML applications in healthcare, including methodology for search strategy, inclusion criteria, and synthesis approach.'
                },
                'market': {
                    topic: 'Market Analysis for Telemedicine Solutions Post-COVID-19',
                    details: 'Analyze market trends, growth opportunities, competitive landscape, and consumer adoption patterns in the telemedicine sector.'
                },
                'clinical': {
                    topic: 'Clinical Research Study Design for AI-Assisted Diagnosis',
                    details: 'Design a clinical study to evaluate AI diagnostic tools, including patient selection, outcome measures, and regulatory considerations.'
                }
            };
            
            const template = templates[type];
            if (template) {
                document.getElementById('researchTopic').value = template.topic;
                document.getElementById('researchDetails').value = template.details;
            }
        }
        
        function exportResearch(format) {
            showNotification(`Research exported as ${format.toUpperCase()}`, 'success');
        }
        
        function shareResearch() {
            showNotification('Research analysis prepared for sharing', 'success');
        }

        // ═══════════════════════════════════════════════════════════════
        // 💰 FINANCE AI MODULE
        // ═══════════════════════════════════════════════════════════════
        
        async function handleFinanceFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showNotification('Processing financial data...', 'info');
            
            document.getElementById('financeDataPreview').classList.remove('hidden');
            document.getElementById('financeDataTable').innerHTML = `
                <div class="bg-green-50 dark:bg-green-900 p-4 rounded">
                    <h4 class="font-bold text-green-800 dark:text-green-300 mb-2">📄 File Processed</h4>
                    <div class="text-green-600 dark:text-green-400">
                        <p><strong>File:</strong> ${file.name}</p>
                        <p><strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                        <p><strong>Type:</strong> ${file.type || 'Financial Document'}</p>
                        <p class="mt-2">💡 Ready for AI financial analysis</p>
                    </div>
                </div>
            `;
            
            // Auto-ask for analysis
            setTimeout(() => {
                askFinanceQuestion('Analyze this financial data and provide insights');
            }, 1000);
        }
        
        async function processManualData() {
            const data = document.getElementById('manualFinanceData').value.trim();
            if (!data) {
                showNotification('Please enter financial data', 'error');
                return;
            }
            
            document.getElementById('financeDataPreview').classList.remove('hidden');
            document.getElementById('financeDataTable').innerHTML = `
                <div class="bg-green-50 dark:bg-green-900 p-4 rounded">
                    <h4 class="font-bold text-green-800 dark:text-green-300 mb-2">📊 Data Processed</h4>
                    <div class="text-green-600 dark:text-green-400">
                        <p><strong>Data Length:</strong> ${data.length} characters</p>
                        <p><strong>Processing Time:</strong> ${new Date().toLocaleString()}</p>
                        <p class="mt-2">💡 Ready for AI financial analysis</p>
                    </div>
                </div>
            `;
            
            // Auto-analyze the data
            askFinanceQuestion(`Analyze this financial data: ${data}`);
        }
        
        async function askFinanceQuestion() {
            const question = document.getElementById('financeQuestionInput').value.trim();
            if (!question) return;
            
            document.getElementById('financeQuestionInput').value = '';
            addFinanceChatMessage('user', question);
            
            if (isAIAvailable()) {
                try {
                    const prompt = `@Claude-Sonnet-4 As a professional financial analyst and AI assistant, please analyze this financial question: "${question}"

Provide a comprehensive financial analysis including:

1. **Data Analysis**: Examine the financial information provided
2. **Key Metrics**: Calculate important financial ratios and indicators
3. **Insights**: Identify trends, patterns, and significant findings
4. **Risk Assessment**: Evaluate potential risks and opportunities
5. **Recommendations**: Provide actionable financial advice
6. **Visualizations**: Suggest charts or graphs that would help illustrate the data
7. **Next Steps**: Recommend follow-up actions or analysis

Use professional financial terminology while keeping explanations clear. Include relevant calculations and provide specific, actionable insights based on best practices in financial analysis.`;

                    await window.Poe.sendUserMessage(prompt, {
                        handler: "finance-analysis",
                        stream: true,
                        openChat: false
                    });
                } catch (error) {
                    addFinanceChatMessage('ai', 'I apologize, but I encountered an error analyzing your financial data. Please try again.');
                }
            } else {
                // Fallback response
                setTimeout(() => {
                    addFinanceChatMessage('ai', generateFinanceResponse(question));
                }, 1000);
            }
        }
        
        function askQuickFinanceQuestion(question) {
            document.getElementById('financeQuestionInput').value = question;
            askFinanceQuestion();
        }
        
        function addFinanceChatMessage(sender, message, isTyping = false) {
            const messagesContainer = document.getElementById('financeChatMessages');
            
            // Clear welcome message
            if (messagesContainer.children.length === 1 && messagesContainer.children[0].classList.contains('text-center')) {
                messagesContainer.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-2 mb-3';
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-user text-white text-xs"></i>
                    </div>
                    <div class="bg-green-100 dark:bg-green-800 rounded-lg p-3 max-w-[80%]">
                        <div class="text-sm text-green-800 dark:text-green-200">${message}</div>
                        <div class="text-xs text-green-600 dark:text-green-400 mt-1">Just now</div>
                    </div>`;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-chart-line text-white text-xs"></i>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 max-w-[80%]">
                        <div class="text-sm text-gray-800 dark:text-white">${marked.parse(message)}</div>
                        <div class="text-xs text-gray-500 mt-1">${isTyping ? 'Analyzing...' : 'Just now'}</div>
                    </div>`;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function generateFinanceResponse(question) {
            const responses = {
                'profit': `## 📊 Profit Analysis

**Key Insights:**
- Profit margins are critical indicators of business efficiency
- Industry averages vary: Software (20-30%), Retail (2-5%), Healthcare (15-25%)
- Focus on both gross and net profit margins

**Recommendations:**
1. Track monthly profit trends
2. Implement cost optimization strategies
3. Monitor competitor pricing
4. Diversify revenue streams

**Next Steps:**
Upload your financial statements for detailed AI analysis.`,
                
                'trend': `## 📈 Financial Trend Analysis

**Market Indicators:**
- Current economic conditions favor technology investments
- Healthcare sector shows strong growth potential
- Inflation impact requires strategic planning

**Analysis Framework:**
1. Historical performance review
2. Seasonal pattern identification
3. Growth rate calculations
4. Future projections

**Tools Available:**
- AI-powered forecasting
- Trend visualization
- Risk assessment models`,
                
                'default': `## 💼 Financial Analysis Response

Thank you for your financial question. Our AI system can help with:

**Available Services:**
- Profit & loss analysis
- Cash flow projections
- Investment evaluations
- Risk assessments
- Market trend analysis
- Financial planning

**How to Get Started:**
1. Upload financial documents (Excel, CSV, PDF)
2. Enter manual data for quick analysis
3. Ask specific questions about financial metrics

**Professional Features:**
- Real-time AI analysis
- Industry benchmarking
- Detailed reporting
- Export capabilities

Would you like to analyze specific financial data?`
            };
            
            const lowerQuestion = question.toLowerCase();
            if (lowerQuestion.includes('profit') || lowerQuestion.includes('margin')) {
                return responses.profit;
            } else if (lowerQuestion.includes('trend') || lowerQuestion.includes('forecast')) {
                return responses.trend;
            } else {
                return responses.default;
            }
        }
        
        function openFinancialCalculator(type) {
            // Create modal for financial calculators
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            
            let content = '';
            switch(type) {
                case 'roi':
                    content = createROICalculator();
                    break;
                case 'profit':
                    content = createProfitCalculator();
                    break;
                case 'cashflow':
                    content = createCashFlowCalculator();
                    break;
                case 'forecast':
                    content = createForecastCalculator();
                    break;
            }
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white">${type.toUpperCase()} Calculator</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    ${content}
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function createROICalculator() {
            return `
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Initial Investment ($)</label>
                        <input type="number" id="roiInvestment" class="w-full px-3 py-2 border rounded-lg" placeholder="10000" step="0.01">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Current Value ($)</label>
                        <input type="number" id="roiValue" class="w-full px-3 py-2 border rounded-lg" placeholder="12000" step="0.01">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Time Period (Years)</label>
                        <input type="number" id="roiTime" class="w-full px-3 py-2 border rounded-lg" placeholder="2" step="0.1">
                    </div>
                    <button onclick="calculateROI()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg">Calculate ROI</button>
                    <div id="roiResults" class="hidden bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"></div>
                </div>
            `;
        }
        
        function calculateROI() {
            const investment = parseFloat(document.getElementById('roiInvestment').value) || 0;
            const value = parseFloat(document.getElementById('roiValue').value) || 0;
            const time = parseFloat(document.getElementById('roiTime').value) || 1;
            
            if (investment === 0) {
                showNotification('Please enter investment amount', 'error');
                return;
            }
            
            const totalReturn = value - investment;
            const roiPercent = (totalReturn / investment) * 100;
            const annualizedROI = time > 0 ? (Math.pow(value / investment, 1/time) - 1) * 100 : roiPercent;
            
            document.getElementById('roiResults').classList.remove('hidden');
            document.getElementById('roiResults').innerHTML = `
                <h4 class="font-bold mb-2">ROI Analysis Results</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Total Return:</span>
                        <span class="font-bold ${totalReturn >= 0 ? 'text-green-600' : 'text-red-600'}">$${totalReturn.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>ROI:</span>
                        <span class="font-bold ${roiPercent >= 0 ? 'text-green-600' : 'text-red-600'}">${roiPercent.toFixed(2)}%</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Annualized ROI:</span>
                        <span class="font-bold ${annualizedROI >= 0 ? 'text-green-600' : 'text-red-600'}">${annualizedROI.toFixed(2)}%</span>
                    </div>
                    <div class="mt-3 p-2 bg-blue-50 dark:bg-blue-900 rounded text-xs">
                        <strong>Performance:</strong> 
                        ${annualizedROI >= 15 ? '🟢 Excellent' : annualizedROI >= 10 ? '🟡 Good' : annualizedROI >= 5 ? '🟠 Average' : '🔴 Below Average'}
                    </div>
                </div>
            `;
        }

        // ═══════════════════════════════════════════════════════════════
        // 🧮 SMART CALCULATOR MODULE
        // ═══════════════════════════════════════════════════════════════
        
        function updateCalculatorDisplay() {
            const display = document.getElementById('calculatorDisplay');
            if (display) {
                const numValue = parseFloat(calculatorValue);
                if (isNaN(numValue)) {
                    display.textContent = 'Error';
                } else {
                    display.textContent = numValue.toLocaleString('en-US', {
                        maximumFractionDigits: 8,
                        useGrouping: true
                    });
                }
            }
        }
        
        function inputNumber(number) {
            if (shouldResetDisplay) {
                calculatorValue = '0';
                shouldResetDisplay = false;
            }
            
            if (waitingForOperand) {
                calculatorValue = number;
                waitingForOperand = false;
            } else {
                if (number === '.' && calculatorValue.includes('.')) {
                    return;
                }
                calculatorValue = calculatorValue === '0' && number !== '.' ? number : calculatorValue + number;
            }
            updateCalculatorDisplay();
        }
        
        function inputOperator(nextOperator) {
            const inputValue = parseFloat(calculatorValue);

            if (previousValue === null) {
                previousValue = inputValue;
            } else if (operator && !waitingForOperand) {
                const currentValue = parseFloat(calculatorValue) || 0;
                const result = performCalculation(previousValue, currentValue, operator);
                
                if (isNaN(result) || !isFinite(result)) {
                    calculatorValue = 'Error';
                    previousValue = null;
                    operator = null;
                    waitingForOperand = false;
                    shouldResetDisplay = true;
                    updateCalculatorDisplay();
                    return;
                }
                
                calculatorValue = String(result);
                previousValue = result;
                updateCalculatorDisplay();
                
                // Add to history
                addToCalculatorHistory(`${previousValue} ${operator} ${currentValue} = ${result}`);
            }

            waitingForOperand = true;
            operator = nextOperator;
            
            // Update history display
            document.getElementById('calculatorHistory').textContent = `${previousValue} ${operator}`;
        }
        
        function calculate() {
            const inputValue = parseFloat(calculatorValue);

            if (previousValue !== null && operator && !waitingForOperand) {
                const result = performCalculation(previousValue, inputValue, operator);
                
                if (isNaN(result) || !isFinite(result)) {
                    calculatorValue = 'Error';
                    shouldResetDisplay = true;
                } else {
                    const calculation = `${previousValue} ${operator} ${inputValue} = ${result}`;
                    addToCalculatorHistory(calculation);
                    calculatorValue = String(result);
                }
                
                updateCalculatorDisplay();
            }

            previousValue = null;
            operator = null;
            waitingForOperand = true;
            shouldResetDisplay = true;
            document.getElementById('calculatorHistory').textContent = '';
        }
        
        function performCalculation(firstOperand, secondOperand, operator) {
            switch (operator) {
                case '+':
                    return firstOperand + secondOperand;
                case '-':
                    return firstOperand - secondOperand;
                case '*':
                    return firstOperand * secondOperand;
                case '/':
                    if (secondOperand === 0) {
                        showNotification('Cannot divide by zero', 'error');
                        return 0;
                    }
                    return firstOperand / secondOperand;
                default:
                    return secondOperand;
            }
        }
        
        function clearCalculator() {
            calculatorValue = '0';
            previousValue = null;
            operator = null;
            waitingForOperand = false;
            shouldResetDisplay = false;
            document.getElementById('calculatorHistory').textContent = '';
            updateCalculatorDisplay();
        }
        
        function backspace() {
            if (shouldResetDisplay || calculatorValue === 'Error') {
                clearCalculator();
                return;
            }
            
            if (calculatorValue.length > 1 && calculatorValue !== '0') {
                calculatorValue = calculatorValue.slice(0, -1);
            } else {
                calculatorValue = '0';
            }
            updateCalculatorDisplay();
        }
        
        function calculateSquareRoot() {
            const value = parseFloat(calculatorValue);
            if (value < 0) {
                calculatorValue = 'Error';
                shouldResetDisplay = true;
            } else {
                const result = Math.sqrt(value);
                addToCalculatorHistory(`√${value} = ${result}`);
                calculatorValue = String(result);
                shouldResetDisplay = true;
            }
            updateCalculatorDisplay();
        }
        
        function calculatePower() {
            const value = parseFloat(calculatorValue);
            const result = Math.pow(value, 2);
            addToCalculatorHistory(`${value}² = ${result}`);
            calculatorValue = String(result);
            shouldResetDisplay = true;
            updateCalculatorDisplay();
        }
        
        function calculatePercentage() {
            const value = parseFloat(calculatorValue);
            const result = value / 100;
            addToCalculatorHistory(`${value}% = ${result}`);
            calculatorValue = String(result);
            shouldResetDisplay = true;
            updateCalculatorDisplay();
        }
        
        function addToCalculatorHistory(calculation) {
            calculatorHistory.unshift(calculation);
            if (calculatorHistory.length > 10) {
                calculatorHistory.pop();
            }
            updateCalculatorHistoryDisplay();
        }
        
        function updateCalculatorHistoryDisplay() {
            const historyDiv = document.getElementById('calculationHistory');
            if (calculatorHistory.length === 0) {
                historyDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">No calculations yet</p>';
            } else {
                historyDiv.innerHTML = calculatorHistory.map(calc => 
                    `<div class="text-sm text-gray-700 dark:text-gray-300 py-1 border-b border-gray-200 dark:border-gray-600 last:border-b-0">${calc}</div>`
                ).join('');
            }
        }
        
        function clearHistory() {
            calculatorHistory = [];
            updateCalculatorHistoryDisplay();
        }
        
        async function askCalculatorQuestion() {
            const question = document.getElementById('calculatorQuestionInput').value.trim();
            if (!question) return;
            
            document.getElementById('calculatorQuestionInput').value = '';
            addCalculatorChatMessage('user', question);
            
            if (isAIAvailable()) {
                try {
                    const prompt = `@Claude-Sonnet-4 As a mathematical AI assistant, please solve this calculation or math problem: "${question}"

Provide a comprehensive response including:
1. **Solution**: Step-by-step calculation with clear explanations
2. **Final Answer**: Clearly stated result
3. **Method**: Explanation of the mathematical approach used
4. **Verification**: Double-check or alternative method if applicable
5. **Context**: Practical applications or related concepts

Format mathematical expressions clearly and show all work. If the question involves financial calculations, include relevant formulas and interpretations.`;

                    await window.Poe.sendUserMessage(prompt, {
                        handler: "calculator-analysis",
                        stream: true,
                        openChat: false
                    });
                } catch (error) {
                    addCalculatorChatMessage('ai', 'I apologize, but I encountered an error processing your calculation. Please try again.');
                }
            } else {
                setTimeout(() => {
                    addCalculatorChatMessage('ai', generateCalculatorResponse(question));
                }, 1000);
            }
        }
        
        function askQuickCalculation(question) {
            document.getElementById('calculatorQuestionInput').value = question;
            askCalculatorQuestion();
        }
        
        function addCalculatorChatMessage(sender, message, isTyping = false) {
            const messagesContainer = document.getElementById('calculatorChatMessages');
            
            // Clear welcome message
            if (messagesContainer.children.length === 1 && messagesContainer.children[0].classList.contains('text-center')) {
                messagesContainer.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-2 mb-3';
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-user text-white text-xs"></i>
                    </div>
                    <div class="bg-purple-100 dark:bg-purple-800 rounded-lg p-3 max-w-[80%]">
                        <div class="text-sm text-purple-800 dark:text-purple-200">${message}</div>
                        <div class="text-xs text-purple-600 dark:text-purple-400 mt-1">Just now</div>
                    </div>`;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-calculator text-white text-xs"></i>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 max-w-[80%]">
                        <div class="text-sm text-gray-800 dark:text-white">${marked.parse(message)}</div>
                        <div class="text-xs text-gray-500 mt-1">${isTyping ? 'Calculating...' : 'Just now'}</div>
                    </div>`;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function generateCalculatorResponse(question) {
            const lowerQuestion = question.toLowerCase();
            
            if (lowerQuestion.includes('compound interest')) {
                return `## 💰 Compound Interest Calculation

**Formula:** A = P(1 + r/n)^(nt)

**Example Calculation:**
- Principal: $10,000
- Annual Rate: 5%
- Compounding: Annually
- Time: 3 years

**Result:** $11,576.25

**Step-by-step:**
1. A = 10000(1 + 0.05/1)^(1×3)
2. A = 10000(1.05)^3
3. A = 10000 × 1.157625
4. A = $11,576.25

**Interest Earned:** $1,576.25`;
            }
            
            if (lowerQuestion.includes('tip')) {
                return `## 🧾 Tip Calculator

**Calculation:**
- Bill Amount: $85.50
- Tip Percentage: 15%
- Tip Amount: $85.50 × 0.15 = $12.83
- Total Amount: $85.50 + $12.83 = $98.33

**Common Tip Percentages:**
- 15% (Standard): $12.83
- 18% (Good Service): $15.39
- 20% (Excellent): $17.10

**Quick Mental Math:** 
Move decimal left one place and multiply by 1.5 for 15%`;
            }
            
            return `## 🔢 Mathematical Analysis

Thank you for your calculation request. I can help with:

**Available Calculations:**
- Basic arithmetic operations
- Percentage calculations
- Financial formulas (compound interest, loans, ROI)
- Scientific calculations
- Currency conversions
- Statistical analysis

**Example Problems I Can Solve:**
- "Calculate 15% tip on $85.50"
- "Compound interest on $10,000 at 5% for 3 years"
- "What is 25% of 240?"
- "Convert 150 USD to EUR"
- "Calculate monthly payment for $300,000 loan at 4.5%"

Please provide specific numbers and I'll show you the complete solution with step-by-step calculations.`;
        }

        // ═══════════════════════════════════════════════════════════════
        // 👥 ADMIN MODULE
        // ═══════════════════════════════════════════════════════════════
        
        // Admin Tab Management
        function showAdminTab(tabName) {
            // Hide all admin tab contents
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('border-indigo-500', 'text-indigo-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show target tab content
            const targetContent = document.getElementById(tabName + 'TabContent');
            if (targetContent) {
                targetContent.classList.remove('hidden');
            }
            
            // Highlight active tab
            const activeTab = document.getElementById(tabName + 'Tab');
            if (activeTab) {
                activeTab.classList.add('border-indigo-500', 'text-indigo-600');
                activeTab.classList.remove('border-transparent', 'text-gray-500');
            }
            
            // Tab-specific initialization
            if (tabName === 'permissions') {
                loadPermissionsMatrix();
            } else if (tabName === 'create') {
                setupCreateUserForm();
            }
        }
        
        // Setup Create User Form
        function setupCreateUserForm() {
            const form = document.getElementById('createUserForm');
            if (form) {
                // Remove existing event listeners to avoid duplicates
                form.removeEventListener('submit', handleCreateUser);
                form.addEventListener('submit', handleCreateUser);
            }
            
            // Update role-based permissions display
            updateRolePermissions();
        }
        
        // Handle Create User Form Submission
        function handleCreateUser(event) {
            event.preventDefault();
            createUser();
        }
        
        // Update Role Permissions Display
        function updateRolePermissions() {
            const role = document.getElementById('newUserRole')?.value;
            const checkboxes = document.querySelectorAll('.permission-checkbox');
            
            if (!role || !checkboxes.length) return;
            
            // Clear all checkboxes first
            checkboxes.forEach(cb => cb.checked = false);
            
            // Set permissions based on role
            const rolePermissions = {
                'user': ['perm_medical', 'perm_calculator'],
                'doctor': ['perm_medical', 'perm_research', 'perm_calculator', 'perm_livechat'],
                'admin': ['perm_medical', 'perm_research', 'perm_finance', 'perm_calculator', 'perm_livechat', 'perm_admin']
            };
            
            const permissions = rolePermissions[role] || [];
            permissions.forEach(permId => {
                const checkbox = document.getElementById(permId);
                if (checkbox) checkbox.checked = true;
            });
        }
        
        // Permission Management Functions
        function selectAllPermissions() {
            document.querySelectorAll('.permission-checkbox').forEach(cb => {
                cb.checked = true;
            });
        }
        
        function clearAllPermissions() {
            document.querySelectorAll('.permission-checkbox').forEach(cb => {
                cb.checked = false;
            });
        }
        
        function resetCreateUserForm() {
            const form = document.getElementById('createUserForm');
            if (form) {
                form.reset();
                clearAllPermissions();
                updateRolePermissions();
            }
        }
        
        async function createUser() {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Only administrators can create users', 'error');
                return;
            }
            
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const role = document.getElementById('newUserRole').value;
            const email = document.getElementById('newUserEmail').value.trim();
            
            if (!username || !password) {
                showNotification('Please fill in both username and password', 'error');
                return;
            }
            
            if (username.length < 3) {
                showNotification('Username must be at least 3 characters long', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('Password must be at least 6 characters long', 'error');
                return;
            }
            
            if (users.find(u => u.username === username)) {
                showNotification('Username already exists', 'error');
                return;
            }
            
            // Get selected permissions
            const permissions = {};
            document.querySelectorAll('.permission-checkbox').forEach(cb => {
                permissions[cb.id] = cb.checked;
            });
            
            // Get additional settings
            const forcePasswordChange = document.getElementById('forcePasswordChangeOnLogin').checked;
            const sendWelcomeEmail = document.getElementById('sendWelcomeEmail').checked;
            const enableTwoFactor = document.getElementById('enableTwoFactor').checked;
            const accountActive = document.getElementById('accountActive').checked;
            
            const newUser = {
                username,
                password,
                role,
                email: email || null,
                permissions,
                forcePasswordChange,
                enableTwoFactor,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.username,
                id: Date.now().toString(),
                isActive: accountActive,
                loginCount: 0
            };
            
            users.push(newUser);
            saveUsers();
            
            // Send welcome email if requested
            if (sendWelcomeEmail && email) {
                sendWelcomeEmail(newUser);
            }
            
            // Clear form
            resetCreateUserForm();
            
            loadUsers();
            updateStats();
            
            // Show success message
            showSuccessModal(newUser);
        }
        
        function sendWelcomeEmail(user) {
            const subject = encodeURIComponent('Welcome to HK AI LAB Pro - Account Created');
            const body = encodeURIComponent(`Dear ${user.username},

Welcome to HK AI LAB Pro! Your account has been successfully created.

🔐 LOGIN CREDENTIALS:
Username: ${user.username}
Password: ${user.password}
Role: ${user.role.toUpperCase()}

🌐 PLATFORM ACCESS:
You can now access the HK AI LAB Pro platform with your credentials.

🎯 YOUR PERMISSIONS:
${Object.entries(user.permissions).filter(([key, value]) => value).map(([key, value]) => {
    const permissionNames = {
        'perm_medical': '• Medical AI Analysis',
        'perm_research': '• Research AI Assistant', 
        'perm_finance': '• Finance AI Analysis',
        'perm_calculator': '• Smart Calculator',
        'perm_livechat': '• Live AI Chat',
        'perm_admin': '• Administrative Access'
    };
    return permissionNames[key] || key;
}).join('\n')}

📧 NEXT STEPS:
1. Log in to the platform with your credentials
2. ${user.forcePasswordChange ? 'Change your password (required on first login)' : 'Explore the available AI modules'}
3. Contact support if you need assistance

⚠️ SECURITY:
- Keep your credentials secure
- ${user.enableTwoFactor ? 'Set up two-factor authentication for enhanced security' : 'Consider enabling two-factor authentication'}
- Do not share your login details

If you have any questions or need assistance, please contact our support team.

Best regards,
HK AI LAB Pro Team

---
Account created by: ${user.createdBy}
Date: ${new Date(user.createdAt).toLocaleString()}
Platform: HK AI LAB Pro`);

            const mailtoLink = `mailto:${user.email}?subject=${subject}&body=${body}`;
            window.open(mailtoLink, '_blank');
            
            showNotification('Welcome email prepared for sending', 'info');
        }
        
        function showSuccessModal(user) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-green-200 dark:border-green-700">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-green-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-user-check text-3xl text-white"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">User Created Successfully</h3>
                        <p class="text-gray-600 dark:text-gray-400">New user account has been set up and is ready to use</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg border border-green-200 dark:border-green-700">
                            <div class="text-sm text-green-700 dark:text-green-300">
                                <div class="font-semibold mb-2">👤 User Details:</div>
                                <div>• Username: ${user.username}</div>
                                <div>• Role: ${user.role.toUpperCase()}</div>
                                <div>• Status: ${user.isActive ? 'Active' : 'Inactive'}</div>
                                <div>• Created: ${new Date().toLocaleString()}</div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
                            <div class="text-sm text-blue-700 dark:text-blue-300">
                                <div class="font-semibold mb-2">🔑 Login Credentials:</div>
                                <div class="font-mono bg-white dark:bg-gray-800 p-2 rounded border">
                                    <div>Username: ${user.username}</div>
                                    <div>Password: ${user.password}</div>
                                </div>
                                <div class="text-xs mt-2 opacity-75">Share these credentials securely with the user</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="createAnotherUser(); this.closest('.fixed').remove();" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors text-sm">
                                <i class="fas fa-user-plus mr-1"></i>Create Another
                            </button>
                            <button onclick="viewUsersList(); this.closest('.fixed').remove();" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors text-sm">
                                <i class="fas fa-users mr-1"></i>View Users
                            </button>
                        </div>
                    </div>
                    
                    <button onclick="this.closest('.fixed').remove()" class="w-full mt-4 px-4 py-2 text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-check mr-2"></i>Done
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function createAnotherUser() {
            resetCreateUserForm();
            showNotification('Form reset for new user creation', 'info');
        }
        
        function viewUsersList() {
            showAdminTab('users');
        }
        
        function loadUsers() {
            const usersList = document.getElementById('usersList');
            if (!usersList) return;
            
            const searchTerm = document.getElementById('userSearch')?.value.toLowerCase() || '';
            let filteredUsers = users;
            
            if (searchTerm) {
                filteredUsers = users.filter(user => 
                    user.username.toLowerCase().includes(searchTerm) ||
                    user.role.toLowerCase().includes(searchTerm)
                );
            }
            
            usersList.innerHTML = '';
            
            filteredUsers.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-blue-500';
                
                const createdDate = new Date(user.createdAt).toLocaleDateString();
                const lastLoginDate = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never';
                
                userDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <span class="font-semibold text-gray-800 dark:text-white text-lg">${user.username}</span>
                                <span class="ml-3 px-2 py-1 text-xs rounded-full ${
                                    user.role === 'admin' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' : 
                                    user.role === 'doctor' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' :
                                    'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300'
                                }">${user.role.toUpperCase()}</span>
                            </div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                                <div>Created: ${createdDate} ${user.createdBy ? `by ${user.createdBy}` : ''}</div>
                                <div>Last Login: ${lastLoginDate} | Logins: ${user.loginCount || 0}</div>
                                <div>Status: <span class="${user.isActive ? 'text-green-600' : 'text-red-600'}">${user.isActive ? 'Active' : 'Inactive'}</span></div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="editUser('${user.username}')" class="text-blue-500 hover:text-blue-700 p-2" title="Edit User">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="resetUserPassword('${user.username}')" class="text-orange-500 hover:text-orange-700 p-2" title="Reset Password">
                                <i class="fas fa-key"></i>
                            </button>
                            ${user.username !== 'admin' ? `
                                <button onclick="toggleUserStatus('${user.username}')" class="text-purple-500 hover:text-purple-700 p-2" title="Toggle Status">
                                    <i class="fas fa-toggle-${user.isActive ? 'on' : 'off'}"></i>
                                </button>
                                <button onclick="deleteUser('${user.username}')" class="text-red-500 hover:text-red-700 p-2" title="Delete User">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : '<i class="fas fa-shield-alt text-yellow-500 p-2" title="Protected Admin"></i>'}
                        </div>
                    </div>
                `;
                usersList.appendChild(userDiv);
            });
        }
        
        function searchUsers() {
            loadUsers();
        }
        
        function refreshUserList() {
            loadUsers();
            updateStats();
            showNotification('User list refreshed', 'info');
        }
        
        function editUser(username) {
            showNotification(`Edit functionality for ${username} would open here`, 'info');
        }
        
        function resetUserPassword(username) {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Only administrators can reset passwords', 'error');
                return;
            }
            
            // Create professional password reset modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-gray-200 dark:border-gray-700">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-orange-500 to-red-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-key text-3xl text-white"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Reset User Password</h3>
                        <p class="text-gray-600 dark:text-gray-400">Reset password for user: <strong>${username}</strong></p>
                    </div>
                    
                    <form id="resetPasswordForm" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                <i class="fas fa-lock mr-2 text-orange-500"></i>New Password
                            </label>
                            <div class="relative">
                                <input type="password" id="resetNewPassword" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white pr-12" placeholder="Enter new password" required>
                                <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" onclick="togglePasswordVisibilityInModal('resetNewPassword', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                                Password must be at least 6 characters long
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                <i class="fas fa-check mr-2 text-green-500"></i>Confirm New Password
                            </label>
                            <div class="relative">
                                <input type="password" id="resetConfirmPassword" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white pr-12" placeholder="Confirm new password" required>
                                <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" onclick="togglePasswordVisibilityInModal('resetConfirmPassword', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Password Strength Indicator -->
                        <div id="resetPasswordStrength" class="hidden">
                            <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Password Strength:</div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div id="resetStrengthBar" class="h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <div id="resetStrengthText" class="text-xs mt-1"></div>
                        </div>
                        
                        <!-- Options -->
                        <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded-lg border border-blue-200 dark:border-blue-700">
                            <div class="flex items-start space-x-2">
                                <input type="checkbox" id="notifyUser" class="mt-1" checked>
                                <label for="notifyUser" class="text-sm text-blue-700 dark:text-blue-300">
                                    <i class="fas fa-bell mr-1"></i>
                                    Notify user about password reset via email
                                </label>
                            </div>
                            <div class="flex items-start space-x-2 mt-2">
                                <input type="checkbox" id="forcePasswordChange" class="mt-1" checked>
                                <label for="forcePasswordChange" class="text-sm text-blue-700 dark:text-blue-300">
                                    <i class="fas fa-shield-alt mr-1"></i>
                                    Force user to change password on next login
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">
                                <i class="fas fa-times mr-2"></i>Cancel
                            </button>
                            <button type="submit" class="flex-1 px-4 py-3 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white rounded-lg font-semibold transition-all duration-200 transform hover:scale-105">
                                <i class="fas fa-key mr-2"></i>Reset Password
                            </button>
                        </div>
                        
                        <!-- Security Warning -->
                        <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900 rounded-lg border border-yellow-200 dark:border-yellow-700">
                            <div class="flex items-center text-sm text-yellow-700 dark:text-yellow-300">
                                <i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i>
                                <span>This action will immediately change the user's password and may log them out of all sessions.</span>
                            </div>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up form handler
            document.getElementById('resetPasswordForm').addEventListener('submit', (e) => handlePasswordReset(e, username));
            
            // Set up password strength checker
            document.getElementById('resetNewPassword').addEventListener('input', checkResetPasswordStrength);
            
            // Focus on new password field
            setTimeout(() => {
                document.getElementById('resetNewPassword').focus();
            }, 100);
        }
        
        function checkResetPasswordStrength() {
            const password = document.getElementById('resetNewPassword').value;
            const strengthIndicator = document.getElementById('resetPasswordStrength');
            const strengthBar = document.getElementById('resetStrengthBar');
            const strengthText = document.getElementById('resetStrengthText');
            
            if (!password) {
                strengthIndicator.classList.add('hidden');
                return;
            }
            
            strengthIndicator.classList.remove('hidden');
            
            let strength = 0;
            let feedback = [];
            
            // Length check
            if (password.length >= 8) strength += 20;
            else if (password.length >= 6) strength += 10;
            else feedback.push('Use at least 6 characters');
            
            // Character variety checks
            if (/[a-z]/.test(password)) strength += 15;
            else feedback.push('Add lowercase letters');
            
            if (/[A-Z]/.test(password)) strength += 15;
            else feedback.push('Add uppercase letters');
            
            if (/[0-9]/.test(password)) strength += 15;
            else feedback.push('Add numbers');
            
            if (/[^A-Za-z0-9]/.test(password)) strength += 20;
            else feedback.push('Add special characters');
            
            // Length bonus
            if (password.length >= 12) strength += 15;
            
            // Update strength bar
            strengthBar.style.width = Math.min(strength, 100) + '%';
            
            // Color and text based on strength
            if (strength < 30) {
                strengthBar.className = 'h-2 rounded-full transition-all duration-300 bg-red-500';
                strengthText.textContent = 'Weak';
                strengthText.className = 'text-xs mt-1 text-red-600 dark:text-red-400';
            } else if (strength < 60) {
                strengthBar.className = 'h-2 rounded-full transition-all duration-300 bg-orange-500';
                strengthText.textContent = 'Fair';
                strengthText.className = 'text-xs mt-1 text-orange-600 dark:text-orange-400';
            } else if (strength < 80) {
                strengthBar.className = 'h-2 rounded-full transition-all duration-300 bg-yellow-500';
                strengthText.textContent = 'Good';
                strengthText.className = 'text-xs mt-1 text-yellow-600 dark:text-yellow-400';
            } else {
                strengthBar.className = 'h-2 rounded-full transition-all duration-300 bg-green-500';
                strengthText.textContent = 'Strong';
                strengthText.className = 'text-xs mt-1 text-green-600 dark:text-green-400';
            }
            
            if (feedback.length > 0) {
                strengthText.textContent += ' - ' + feedback.slice(0, 2).join(', ');
            }
        }
        
        function handlePasswordReset(event, username) {
            event.preventDefault();
            
            const newPassword = document.getElementById('resetNewPassword').value;
            const confirmPassword = document.getElementById('resetConfirmPassword').value;
            const notifyUser = document.getElementById('notifyUser').checked;
            const forcePasswordChange = document.getElementById('forcePasswordChange').checked;
            
            // Validation
            if (!newPassword || !confirmPassword) {
                showNotification('Please fill in both password fields', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('Password must be at least 6 characters long', 'error');
                document.getElementById('resetNewPassword').focus();
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                document.getElementById('resetConfirmPassword').focus();
                return;
            }
            
            // Find and update user
            const userIndex = users.findIndex(u => u.username === username);
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                users[userIndex].passwordResetAt = new Date().toISOString();
                users[userIndex].passwordResetBy = currentUser.username;
                users[userIndex].forcePasswordChange = forcePasswordChange;
                
                saveUsers();
                
                // Close modal
                document.querySelector('.fixed.inset-0').remove();
                
                // Refresh user list
                loadUsers();
                
                // Show success message
                showNotification(`Password reset successfully for ${username}`, 'success');
                
                // Send notification email if requested
                if (notifyUser) {
                    sendPasswordResetNotification(username, newPassword);
                }
                
                // Log the password reset
                console.log(`Password reset for user: ${username} by ${currentUser.username} at ${new Date().toISOString()}`);
            } else {
                showNotification('User not found', 'error');
            }
        }
        
        function sendPasswordResetNotification(username, newPassword) {
            const subject = encodeURIComponent('HK AI LAB Pro - Password Reset Notification');
            const body = encodeURIComponent(`Dear ${username},

Your password has been reset by an administrator on HK AI LAB Pro platform.

🔐 NEW LOGIN CREDENTIALS:
Username: ${username}
New Password: ${newPassword}

⚠️ IMPORTANT SECURITY NOTICE:
- Please change your password after logging in
- Do not share these credentials with anyone
- Contact support if you didn't request this reset

🛡️ NEXT STEPS:
1. Log in with your new password
2. Change your password in Account Settings
3. Enable two-factor authentication (if available)

If you have any questions or concerns, please contact our support team immediately.

Best regards,
HK AI LAB Pro Security Team

---
This is an automated security notification from HK AI LAB Pro.
Reset performed by: ${currentUser.username}
Date: ${new Date().toLocaleString()}
Platform: HK AI LAB Pro`);
            
            const mailtoLink = `mailto:?subject=${subject}&body=${body}`;
            window.open(mailtoLink, '_blank');
            
            showNotification('Password reset notification email prepared', 'info');
        }
        
        function toggleUserStatus(username) {
            const user = users.find(u => u.username === username);
            if (user) {
                user.isActive = !user.isActive;
                saveUsers();
                loadUsers();
                updateStats();
                showNotification(`User ${username} ${user.isActive ? 'activated' : 'deactivated'}`, 'success');
            }
        }
        
        function deleteUser(username) {
            if (confirm(`Are you sure you want to delete user "${username}"?`)) {
                users = users.filter(u => u.username !== username);
                saveUsers();
                loadUsers();
                updateStats();
                showNotification(`User "${username}" deleted`, 'success');
            }
        }
        
        function exportUsers() {
            const exportData = users.map(user => ({
                username: user.username,
                role: user.role,
                createdAt: user.createdAt,
                isActive: user.isActive,
                loginCount: user.loginCount
            }));
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hk_lab_users_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Users exported successfully', 'success');
        }
        
        function importUsers() {
            showNotification('Import functionality would open file picker here', 'info');
        }
        
        function updateStats() {
            const totalUsersCount = users.length;
            const activeUsersCount = users.filter(u => u.isActive).length;
            const adminUsersCount = users.filter(u => u.role === 'admin').length;
            
            // Update dashboard stats
            document.getElementById('dailyAnalyses').textContent = Math.floor(Math.random() * 100) + 200;
            document.getElementById('activeUsers').textContent = activeUsersCount;
            
            // Update admin stats
            const totalUsersEl = document.getElementById('totalUsers');
            const adminActiveUsersEl = document.getElementById('adminActiveUsers');
            const adminUsersEl = document.getElementById('adminUsers');
            
            if (totalUsersEl) totalUsersEl.textContent = totalUsersCount;
            if (adminActiveUsersEl) adminActiveUsersEl.textContent = activeUsersCount;
            if (adminUsersEl) adminUsersEl.textContent = adminUsersCount;
        }

        // ═══════════════════════════════════════════════════════════════
        // 💬 LIVE CHAT SYSTEM WITH AI SPECIALISTS
        // ═══════════════════════════════════════════════════════════════
        
        // Global chat variables
        let currentSpecialist = null;
        let liveChatHandlers = {};
        
        // Futuristic chat button reveal and hide functions
        function revealFuturisticChat() {
            const hiddenTrigger = document.getElementById('hiddenFuturisticTrigger');
            const fullPortal = document.getElementById('futuristicChatPortal');
            
            if (hiddenTrigger && fullPortal) {
                hiddenTrigger.classList.add('hidden');
                fullPortal.classList.remove('hidden');
                
                // Add quantum reveal animation
                fullPortal.style.transform = 'scale(0.5) rotate(180deg)';
                fullPortal.style.opacity = '0';
                
                setTimeout(() => {
                    fullPortal.style.transform = 'scale(1) rotate(0deg)';
                    fullPortal.style.opacity = '1';
                    fullPortal.style.transition = 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                }, 10);
                
                showNotification('🧠 Neural AI Interface activated! Quantum support ready.', 'success');
            }
        }
        
        function hideFuturisticChat(event) {
            if (event) {
                event.stopPropagation();
            }
            
            const hiddenTrigger = document.getElementById('hiddenFuturisticTrigger');
            const fullPortal = document.getElementById('futuristicChatPortal');
            const chatWidget = document.getElementById('liveChatWidget');
            
            if (hiddenTrigger && fullPortal) {
                // Close chat widget if open
                if (chatWidget && !chatWidget.classList.contains('hidden')) {
                    chatWidget.classList.add('hidden');
                }
                
                // Add quantum hide animation
                fullPortal.style.transform = 'scale(0.5) rotate(-180deg)';
                fullPortal.style.opacity = '0';
                fullPortal.style.transition = 'all 0.4s ease-in';
                
                setTimeout(() => {
                    fullPortal.classList.add('hidden');
                    hiddenTrigger.classList.remove('hidden');
                    
                    // Reset transforms
                    fullPortal.style.transform = '';
                    fullPortal.style.opacity = '';
                    fullPortal.style.transition = '';
                }, 400);
                
                showNotification('🔌 Neural Interface deactivated. Quantum standby mode.', 'info');
            }
        }
        
        // Register AI specialist handlers
        if (isAIAvailable()) {
            // AI Doctor Handler
            window.Poe.registerHandler("ai-doctor", (result, context) => {
                const msg = result.responses[0];
                addLiveChatMessage('ai', msg.content, msg.status === "incomplete");
            });
            
            // Cancer Consultant Handler
            window.Poe.registerHandler("cancer-consultant", (result, context) => {
                const msg = result.responses[0];
                addLiveChatMessage('ai', msg.content, msg.status === "incomplete");
            });
            
            // Lab Tech Consultant Handler
            window.Poe.registerHandler("lab-tech", (result, context) => {
                const msg = result.responses[0];
                addLiveChatMessage('ai', msg.content, msg.status === "incomplete");
            });
        }
        
        function toggleLiveChat() {
            const chatWidget = document.getElementById('liveChatWidget');
            chatWidget.classList.toggle('hidden');
            
            if (!chatWidget.classList.contains('hidden')) {
                // Show specialist menu if no specialist selected
                if (!currentSpecialist) {
                    showSpecialistMenu();
                }
                setTimeout(() => {
                    document.getElementById('liveChatInput').focus();
                }, 100);
            }
        }
        
        function closeLiveChat() {
            document.getElementById('liveChatWidget').classList.add('hidden');
        }
        
        function showSpecialistMenu() {
            document.getElementById('specialistMenu').classList.remove('hidden');
        }
        
        function hideSpecialistMenu() {
            document.getElementById('specialistMenu').classList.add('hidden');
        }
        
        function selectSpecialist(type) {
            currentSpecialist = type;
            hideSpecialistMenu();
            
            // Update UI based on selected specialist
            const specialists = {
                'doctor': {
                    name: 'AI Doctor',
                    status: 'General Practice Online',
                    icon: 'fas fa-user-md',
                    color: 'from-blue-500 to-green-500',
                    avatar: 'bg-blue-500',
                    greeting: "Hello! I'm your AI Doctor. I can help with general medical questions, symptom analysis, and health advice. How can I assist you today?",
                    quickActions: [
                        { text: 'General Health Question', action: () => addQuickSpecialistMessage('I have a general health question') },
                        { text: 'Symptom Analysis', action: () => addQuickSpecialistMessage('Can you help analyze my symptoms?') },
                        { text: 'Medication Info', action: () => addQuickSpecialistMessage('I need information about a medication') },
                        { text: 'Health Advice', action: () => addQuickSpecialistMessage('I need general health advice') }
                    ]
                },
                'cancer': {
                    name: 'Cancer Consultant',
                    status: 'Oncology Specialist Online',
                    icon: 'fas fa-ribbon',
                    color: 'from-red-500 to-pink-500',
                    avatar: 'bg-red-500',
                    greeting: "Hello! I'm your AI Oncology Consultant. I specialize in cancer-related questions, treatment options, and support. How can I help you today?",
                    quickActions: [
                        { text: 'Cancer Screening Info', action: () => addQuickSpecialistMessage('Tell me about cancer screening options') },
                        { text: 'Treatment Options', action: () => addQuickSpecialistMessage('What are my treatment options?') },
                        { text: 'Test Results Analysis', action: () => addQuickSpecialistMessage('Can you help analyze my cancer test results?') },
                        { text: 'Support & Care', action: () => addQuickSpecialistMessage('I need information about cancer care support') }
                    ]
                },
                'labtech': {
                    name: 'Lab Tech Consultant',
                    status: 'Laboratory Analysis Expert Online',
                    icon: 'fas fa-microscope',
                    color: 'from-green-500 to-teal-500',
                    avatar: 'bg-green-500',
                    greeting: "Hello! I'm your AI Laboratory Technician. I specialize in analyzing lab results, blood tests, and medical diagnostics. How can I assist you today?",
                    quickActions: [
                        { text: 'Blood Test Analysis', action: () => addQuickSpecialistMessage('Can you analyze my blood test results?') },
                        { text: 'Lab Value Explanation', action: () => addQuickSpecialistMessage('What do these lab values mean?') },
                        { text: 'Test Preparation', action: () => addQuickSpecialistMessage('How should I prepare for lab tests?') },
                        { text: 'Normal Range Info', action: () => addQuickSpecialistMessage('What are normal ranges for lab values?') }
                    ]
                }
            };
            
            const specialist = specialists[type];
            
            // Update header
            document.getElementById('chatHeader').className = `bg-gradient-to-r ${specialist.color} text-white p-4 rounded-t-lg`;
            document.getElementById('specialistIcon').className = specialist.icon + ' text-sm';
            document.getElementById('specialistAvatar').className = `w-8 h-8 ${specialist.avatar} rounded-full flex items-center justify-center`;
            document.getElementById('specialistName').textContent = specialist.name;
            document.getElementById('specialistStatus').textContent = specialist.status;
            
            // Update active specialist bar
            document.getElementById('activeSpecialistBar').classList.remove('hidden');
            document.getElementById('activeSpecialistBar').className = `bg-gradient-to-r ${specialist.color} text-white px-4 py-2 text-xs`;
            document.getElementById('activeSpecialistIcon').className = specialist.icon + ' text-xs';
            document.getElementById('activeSpecialistText').textContent = specialist.name + ' Online';
            
            // Enable chat input
            const chatInput = document.getElementById('liveChatInput');
            const sendBtn = document.getElementById('liveChatSendBtn');
            chatInput.disabled = false;
            chatInput.placeholder = `Message ${specialist.name}...`;
            sendBtn.disabled = false;
            sendBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg';
            
            // Clear previous messages and add greeting
            const messagesContainer = document.getElementById('liveChatMessages');
            messagesContainer.innerHTML = '';
            addLiveChatMessage('ai', specialist.greeting);
            
            // Update quick actions
            updateSpecialistQuickActions(specialist.quickActions);
            
            showNotification(`Connected to ${specialist.name}`, 'success');
        }
        
        function updateSpecialistQuickActions(actions) {
            const quickActionsDiv = document.getElementById('specialistQuickActions');
            quickActionsDiv.classList.remove('hidden');
            
            quickActionsDiv.innerHTML = `
                <div class="flex flex-wrap gap-2">
                    ${actions.map(action => `
                        <button onclick="(${action.action})()" class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-1 rounded-full hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
                            ${action.text}
                        </button>
                    `).join('')}
                </div>
            `;
        }
        
        function addQuickSpecialistMessage(message) {
            document.getElementById('liveChatInput').value = message;
            sendLiveChatMessage();
        }
        
        async function sendLiveChatMessage() {
            const input = document.getElementById('liveChatInput');
            const message = input.value.trim();
            if (!message || !currentSpecialist) return;
            
            input.value = '';
            addLiveChatMessage('user', message);
            
            // Send to appropriate AI specialist
            if (isAIAvailable()) {
                try {
                    let prompt = '';
                    let handler = '';
                    
                    switch(currentSpecialist) {
                        case 'doctor':
                            prompt = `@Claude-Sonnet-4 You are an AI Doctor providing medical consultation. Patient message: "${message}"

As a professional AI Doctor, provide:
1. **Professional Medical Response**: Address the patient's concern professionally
2. **Medical Information**: Provide accurate, evidence-based medical information
3. **Recommendations**: Suggest appropriate next steps or care
4. **Safety First**: Always recommend consulting healthcare professionals for serious concerns
5. **Empathetic Care**: Use a caring, professional medical tone

IMPORTANT: Always include medical disclaimers and emphasize the importance of professional medical consultation for diagnosis and treatment.`;
                            handler = 'ai-doctor';
                            break;
                            
                        case 'cancer':
                            prompt = `@Claude-Sonnet-4 You are an AI Oncology Consultant specializing in cancer care. Patient message: "${message}"

As a specialized Cancer Consultant, provide:
1. **Oncology Expertise**: Address cancer-related questions with specialized knowledge
2. **Treatment Information**: Explain treatment options, procedures, and care approaches
3. **Support & Resources**: Provide information about cancer support resources
4. **Screening & Prevention**: Share guidance on cancer screening and prevention
5. **Compassionate Care**: Use understanding and supportive communication

CRITICAL: Always emphasize the importance of working with oncology professionals and provide hope while being realistic about cancer care.`;
                            handler = 'cancer-consultant';
                            break;
                            
                        case 'labtech':
                            prompt = `@Claude-Sonnet-4 You are an AI Laboratory Technician expert in medical diagnostics. Patient message: "${message}"

As a Laboratory Analysis Expert, provide:
1. **Lab Result Analysis**: Interpret laboratory values and test results
2. **Technical Explanation**: Explain what different tests measure and detect
3. **Normal Ranges**: Provide information about normal vs. abnormal values
4. **Test Preparation**: Guide on how to prepare for various lab tests
5. **Clinical Correlation**: Explain how lab results relate to health conditions

ESSENTIAL: Always recommend discussing results with healthcare providers for proper interpretation and clinical correlation.`;
                            handler = 'lab-tech';
                            break;
                    }
                    
                    await window.Poe.sendUserMessage(prompt, {
                        handler: handler,
                        stream: true,
                        openChat: false
                    });
                    
                } catch (error) {
                    addLiveChatMessage('ai', 'I apologize, but I encountered an error. Please try again or contact technical support if the issue persists.');
                }
            } else {
                // Fallback responses for demo mode
                setTimeout(() => {
                    const responses = {
                        'doctor': "Thank you for your question. As an AI Doctor, I'd be happy to help with your health concerns. In the full version with live AI integration, I would provide detailed medical guidance based on your specific question.",
                        'cancer': "Thank you for reaching out. As an AI Cancer Consultant, I understand your concerns and would provide specialized oncology information and support. The live AI integration would offer comprehensive cancer care guidance.",
                        'labtech': "Thank you for your lab-related question. As an AI Lab Tech Consultant, I would analyze your test results and provide detailed explanations of lab values and their clinical significance."
                    };
                    addLiveChatMessage('ai', responses[currentSpecialist] + "\n\n**Note**: This is demo mode. Connect to live AI for real-time specialist consultation.");
                }, 1000);
            }
        }
        
        function sendQuickMessage(message) {
            if (!currentSpecialist) {
                showSpecialistMenu();
                showNotification('Please select a specialist first', 'warning');
                return;
            }
            document.getElementById('liveChatInput').value = message;
            sendLiveChatMessage();
        }
        
        function addLiveChatMessage(sender, message, isTyping = false) {
            const messagesContainer = document.getElementById('liveChatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-2 mb-3';
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-user text-white text-xs"></i>
                    </div>
                    <div class="bg-blue-100 dark:bg-blue-800 rounded-lg p-3 max-w-[80%]">
                        <div class="text-sm text-blue-800 dark:text-blue-200">${message}</div>
                        <div class="text-xs text-blue-600 dark:text-blue-400 mt-1">Just now</div>
                    </div>`;
            } else {
                const specialistIcons = {
                    'doctor': 'fas fa-user-md',
                    'cancer': 'fas fa-ribbon', 
                    'labtech': 'fas fa-microscope'
                };
                const icon = currentSpecialist ? specialistIcons[currentSpecialist] : 'fas fa-robot';
                
                messageDiv.innerHTML = `
                    <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="${icon} text-white text-xs"></i>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 max-w-[80%]">
                        <div class="text-sm text-gray-800 dark:text-white">${marked.parse(message)}</div>
                        <div class="text-xs text-gray-500 mt-1">${isTyping ? 'Typing...' : 'Just now'}</div>
                    </div>`;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ═══════════════════════════════════════════════════════════════
        // 🎛️ UI MANAGEMENT
        // ═══════════════════════════════════════════════════════════════
        
        function showModule(moduleName) {
            // Hide all modules
            document.querySelectorAll('.module').forEach(module => {
                module.classList.add('hidden');
            });
            
            // Reset navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('border-primary-500', 'text-primary-600');
                btn.classList.add('text-gray-600', 'dark:text-gray-300');
            });
            
            // Show target module
            const targetModule = document.getElementById(moduleName + 'Module');
            if (targetModule) {
                targetModule.classList.remove('hidden');
            }
            
            // Highlight active nav button
            if (event && event.target) {
                const button = event.target.closest('.nav-btn');
                if (button) {
                    button.classList.add('border-primary-500', 'text-primary-600');
                    button.classList.remove('text-gray-600', 'dark:text-gray-300');
                }
            }
            
            // Module-specific initialization
            if (moduleName === 'admin' && currentUser?.role === 'admin') {
                setTimeout(() => {
                    loadUsers();
                    updateStats();
                }, 100);
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium max-w-md w-full mx-4 ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                type === 'warning' ? 'bg-yellow-500' :
                'bg-blue-500'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-${
                            type === 'success' ? 'check-circle' :
                            type === 'error' ? 'exclamation-circle' :
                            type === 'warning' ? 'exclamation-triangle' :
                            'info-circle'
                        } mr-2"></i>
                        <span>${message}</span>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        function showProfileSettings() {
            showNotification('Profile settings would open here', 'info');
        }
        
        // ═══════════════════════════════════════════════════════════════
        // 🔑 PASSWORD CHANGE FUNCTIONALITY
        // ═══════════════════════════════════════════════════════════════
        
        function showChangePassword() {
            if (!currentUser) {
                showNotification('Please login first', 'error');
                return;
            }
            
            // Create modal for password change
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-gray-200 dark:border-gray-700">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-blue-500 to-green-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-key text-3xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Change Password</h3>
                        <p class="text-gray-600 dark:text-gray-400">Update your account password securely</p>
                    </div>
                    
                    <form id="changePasswordForm" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                <i class="fas fa-lock mr-2 text-gray-500"></i>Current Password
                            </label>
                            <div class="relative">
                                <input type="password" id="currentPassword" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white pr-12" placeholder="Enter current password" required>
                                <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" onclick="togglePasswordVisibilityInModal('currentPassword', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                <i class="fas fa-key mr-2 text-blue-500"></i>New Password
                            </label>
                            <div class="relative">
                                <input type="password" id="newPassword" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white pr-12" placeholder="Enter new password" required>
                                <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" onclick="togglePasswordVisibilityInModal('newPassword', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                                Password must be at least 6 characters long
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                <i class="fas fa-check mr-2 text-green-500"></i>Confirm New Password
                            </label>
                            <div class="relative">
                                <input type="password" id="confirmPassword" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white pr-12" placeholder="Confirm new password" required>
                                <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" onclick="togglePasswordVisibilityInModal('confirmPassword', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Password Strength Indicator -->
                        <div id="passwordStrength" class="hidden">
                            <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Password Strength:</div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div id="strengthBar" class="h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <div id="strengthText" class="text-xs mt-1"></div>
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">
                                <i class="fas fa-times mr-2"></i>Cancel
                            </button>
                            <button type="submit" class="flex-1 px-4 py-3 bg-gradient-to-r from-blue-500 to-green-500 hover:from-blue-600 hover:to-green-600 text-white rounded-lg font-semibold transition-all duration-200 transform hover:scale-105">
                                <i class="fas fa-save mr-2"></i>Update Password
                            </button>
                        </div>
                        
                        <!-- Security Notice -->
                        <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900 rounded-lg border border-blue-200 dark:border-blue-700">
                            <div class="flex items-center text-sm text-blue-700 dark:text-blue-300">
                                <i class="fas fa-shield-alt mr-2 text-blue-500"></i>
                                <span>Your password will be updated immediately and securely stored.</span>
                            </div>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up form handler
            document.getElementById('changePasswordForm').addEventListener('submit', handlePasswordChange);
            
            // Set up password strength checker
            document.getElementById('newPassword').addEventListener('input', checkPasswordStrength);
            
            // Focus on current password field
            setTimeout(() => {
                document.getElementById('currentPassword').focus();
            }, 100);
        }
        
        function togglePasswordVisibilityInModal(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthIndicator = document.getElementById('passwordStrength');
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');
            
            if (!password) {
                strengthIndicator.classList.add('hidden');
                return;
            }
            
            strengthIndicator.classList.remove('hidden');
            
            let strength = 0;
            let feedback = [];
            
            // Length check
            if (password.length >= 8) strength += 20;
            else if (password.length >= 6) strength += 10;
            else feedback.push('Use at least 6 characters');
            
            // Character variety checks
            if (/[a-z]/.test(password)) strength += 15;
            else feedback.push('Add lowercase letters');
            
            if (/[A-Z]/.test(password)) strength += 15;
            else feedback.push('Add uppercase letters');
            
            if (/[0-9]/.test(password)) strength += 15;
            else feedback.push('Add numbers');
            
            if (/[^A-Za-z0-9]/.test(password)) strength += 20;
            else feedback.push('Add special characters');
            
            // Length bonus
            if (password.length >= 12) strength += 15;
            
            // Update strength bar
            strengthBar.style.width = Math.min(strength, 100) + '%';
            
            // Color and text based on strength
            if (strength < 30) {
                strengthBar.className = 'h-2 rounded-full transition-all duration-300 bg-red-500';
                strengthText.textContent = 'Weak';
                strengthText.className = 'text-xs mt-1 text-red-600 dark:text-red-400';
            } else if (strength < 60) {
                strengthBar.className = 'h-2 rounded-full transition-all duration-300 bg-orange-500';
                strengthText.textContent = 'Fair';
                strengthText.className = 'text-xs mt-1 text-orange-600 dark:text-orange-400';
            } else if (strength < 80) {
                strengthBar.className = 'h-2 rounded-full transition-all duration-300 bg-yellow-500';
                strengthText.textContent = 'Good';
                strengthText.className = 'text-xs mt-1 text-yellow-600 dark:text-yellow-400';
            } else {
                strengthBar.className = 'h-2 rounded-full transition-all duration-300 bg-green-500';
                strengthText.textContent = 'Strong';
                strengthText.className = 'text-xs mt-1 text-green-600 dark:text-green-400';
            }
            
            if (feedback.length > 0) {
                strengthText.textContent += ' - ' + feedback.slice(0, 2).join(', ');
            }
        }
        
        function handlePasswordChange(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('Please fill in all password fields', 'error');
                return;
            }
            
            // Check current password
            if (currentPassword !== currentUser.password) {
                showNotification('Current password is incorrect', 'error');
                document.getElementById('currentPassword').focus();
                return;
            }
            
            // Check new password length
            if (newPassword.length < 6) {
                showNotification('New password must be at least 6 characters long', 'error');
                document.getElementById('newPassword').focus();
                return;
            }
            
            // Check password confirmation
            if (newPassword !== confirmPassword) {
                showNotification('New passwords do not match', 'error');
                document.getElementById('confirmPassword').focus();
                return;
            }
            
            // Check if new password is different from current
            if (newPassword === currentPassword) {
                showNotification('New password must be different from current password', 'error');
                document.getElementById('newPassword').focus();
                return;
            }
            
            // Update password
            const userIndex = users.findIndex(u => u.username === currentUser.username);
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                currentUser.password = newPassword;
                users[userIndex].passwordChangedAt = new Date().toISOString();
                users[userIndex].passwordChangedBy = currentUser.username;
                
                saveUsers();
                
                // Close modal
                document.querySelector('.fixed.inset-0').remove();
                
                // Show success message
                showNotification('Password updated successfully! Please use your new password for future logins.', 'success');
                
                // Log the password change
                console.log(`Password changed for user: ${currentUser.username} at ${new Date().toISOString()}`);
            } else {
                showNotification('Error updating password. Please try again.', 'error');
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // 🚀 INITIALIZATION
        // ═══════════════════════════════════════════════════════════════
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Update AI status based on availability
            const aiStatus = document.getElementById('aiStatus');
            if (isAIAvailable()) {
                aiStatus.innerHTML = '<span class="w-2 h-2 bg-white rounded-full animate-pulse"></span><span>AI Online</span>';
                aiStatus.className = 'fixed top-4 right-4 z-50 bg-green-500 text-white px-3 py-1 rounded-full text-xs flex items-center space-x-2 shadow-lg';
            } else {
                aiStatus.innerHTML = '<span class="w-2 h-2 bg-white rounded-full"></span><span>Demo Mode</span>';
                aiStatus.className = 'fixed top-4 right-4 z-50 bg-orange-500 text-white px-3 py-1 rounded-full text-xs flex items-center space-x-2 shadow-lg';
            }
            
            // Set up live chat input handler
            const liveChatInput = document.getElementById('liveChatInput');
            if (liveChatInput) {
                liveChatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendLiveChatMessage();
                    }
                });
            }
            
            // Initialize calculator
            updateCalculatorDisplay();
            updateCalculatorHistoryDisplay();
            
            // Auto-focus on username field
            const usernameField = document.getElementById('username');
            if (usernameField) {
                usernameField.focus();
            }
            
            console.log('🚀 HK AI LAB Pro initialized successfully');
        });

        // ═══════════════════════════════════════════════════════════════
        // 📧 CONTACT SUPPORT FUNCTIONALITY
        // ═══════════════════════════════════════════════════════════════
        
        function showContactModal() {
            // Create compact contact modal with prominent close option
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-2xl max-w-xs w-full mx-4 border border-gray-200 dark:border-gray-700 relative">
                    <!-- Prominent Close Button -->
                    <button onclick="this.closest('.fixed').remove()" class="absolute -top-2 -right-2 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-110 flex items-center justify-center z-10" title="Close Support">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                    
                    <div class="text-center mb-3">
                        <div class="w-10 h-10 mx-auto mb-2 bg-gradient-to-br from-blue-500 to-green-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-headset text-lg text-white"></i>
                        </div>
                        <h3 class="text-base font-bold text-gray-800 dark:text-white mb-1">Contact Support</h3>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Get professional assistance</p>
                    </div>
                    
                    <div class="space-y-2">
                        <!-- Quick Contact Buttons -->
                        <div class="grid grid-cols-1 gap-2">
                            <button onclick="contactEmail(); this.closest('.fixed').remove();" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105 flex items-center justify-center text-sm">
                                <i class="fas fa-envelope mr-2"></i>
                                Email Support
                            </button>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="contactWhatsApp(); this.closest('.fixed').remove();" class="bg-green-500 hover:bg-green-600 text-white px-2 py-2 rounded text-xs transition-colors flex items-center justify-center">
                                    <i class="fab fa-whatsapp mr-1"></i>
                                    WhatsApp
                                </button>
                                <button onclick="contactTelegram(); this.closest('.fixed').remove();" class="bg-blue-400 hover:bg-blue-500 text-white px-2 py-2 rounded text-xs transition-colors flex items-center justify-center">
                                    <i class="fab fa-telegram mr-1"></i>
                                    Telegram
                                </button>
                            </div>
                        </div>
                        
                        <!-- Request Callback -->
                        <button onclick="requestContactBack(); this.closest('.fixed').remove();" class="w-full bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-800 px-3 py-2 rounded-lg transition-colors text-sm">
                            <i class="fas fa-phone-alt mr-2"></i>
                            Request HK to Call You
                        </button>
                        
                        <!-- Emergency -->
                        <button onclick="emergencyContact(); this.closest('.fixed').remove();" class="w-full bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-800 px-3 py-2 rounded-lg transition-colors text-sm">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Emergency Support
                        </button>
                        
                        <!-- Response Time -->
                        <div class="bg-green-50 dark:bg-green-900 p-2 rounded-lg border border-green-200 dark:border-green-700">
                            <div class="flex items-center justify-center text-xs text-green-700 dark:text-green-300">
                                <i class="fas fa-clock mr-2 text-green-500"></i>
                                <span><strong>Response:</strong> Usually 2-4 hours</span>
                            </div>
                        </div>
                        
                        <!-- Direct Contact Info -->
                        <div class="bg-yellow-50 dark:bg-yellow-900 p-2 rounded text-xs text-center">
                            <span class="text-yellow-700 dark:text-yellow-300">Direct: </span>
                            <span class="font-mono text-yellow-800 dark:text-yellow-200 select-all">hadi.karkaba@gmail.com</span>
                        </div>
                    </div>
                    
                    <!-- Close Button at Bottom -->
                    <button onclick="this.closest('.fixed').remove()" class="w-full mt-3 px-3 py-2 text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors text-sm">
                        <i class="fas fa-check mr-1"></i>Done
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto close when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function contactEmail() {
            const subject = encodeURIComponent('HK AI LAB Pro - Support Request');
            const body = encodeURIComponent(`Hello,

I need assistance with HK AI LAB Pro platform.

Platform Information:
- User: ${currentUser ? currentUser.username : 'Not logged in'}
- Role: ${currentUser ? currentUser.role : 'N/A'}
- Browser: ${navigator.userAgent}
- Timestamp: ${new Date().toISOString()}

Issue Description:
[Please describe your issue here]

Best regards`);
            
            const mailtoLink = `mailto:hadi.karkaba@gmail.com?subject=${subject}&body=${body}`;
            window.open(mailtoLink, '_blank');
            
            showNotification('Email client opened. Please send your support request.', 'success');
        }
        
        function contactWhatsApp() {
            const message = encodeURIComponent(`Hello! I need help with HK AI LAB Pro platform.

User: ${currentUser ? currentUser.username : 'Not logged in'}
Role: ${currentUser ? currentUser.role : 'N/A'}
Platform: HK AI LAB Pro
Time: ${new Date().toLocaleString()}

Issue Description:
[Please describe your issue here]

Thank you for your support!`);
            
            // WhatsApp link with your phone number
            const whatsappUrl = `https://wa.me/96170406880?text=${message}`;
            window.open(whatsappUrl, '_blank');
            
            showNotification('Opening WhatsApp. Please send your message.', 'success');
        }
        
        function contactTelegram() {
            const message = encodeURIComponent(`Hello! I need help with HK AI LAB Pro platform.

User: ${currentUser ? currentUser.username : 'Not logged in'}
Role: ${currentUser ? currentUser.role : 'N/A'}
Platform: HK AI LAB Pro
Time: ${new Date().toLocaleString()}

Issue Description:
[Please describe your issue here]

Thank you for your support!`);
            
            // Try to open Telegram with phone number
            const telegramUrl = `https://t.me/+96170406880`;
            window.open(telegramUrl, '_blank');
            
            // Also provide backup option
            showNotification('Opening Telegram. If it doesn\'t work, please message +961 70 406 880 directly.', 'info');
        }
        
        function emergencyContact() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 border border-red-200 dark:border-red-700">
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 mx-auto mb-4 bg-red-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-3xl text-white"></i>
                        </div>
                        <h3 class="text-xl font-bold text-red-800 dark:text-red-300 mb-2">Emergency Contact</h3>
                        <p class="text-gray-600 dark:text-gray-400 text-sm">For urgent technical issues affecting critical operations</p>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="directEmail()" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-envelope mr-2"></i>
                            Direct Email (Priority)
                        </button>
                        
                        <div class="text-xs text-gray-500 dark:text-gray-400 text-center">
                            Emergency support is for critical system failures only.
                            Regular inquiries should use standard support channels.
                        </div>
                    </div>
                    
                    <button onclick="this.closest('.fixed').remove()" class="w-full mt-4 px-4 py-2 text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function directEmail() {
            const subject = encodeURIComponent('URGENT - HK AI LAB Pro Emergency Support');
            const body = encodeURIComponent(`URGENT SUPPORT REQUEST

Platform: HK AI LAB Pro
User: ${currentUser ? currentUser.username : 'Not logged in'}
Role: ${currentUser ? currentUser.role : 'N/A'}
Timestamp: ${new Date().toISOString()}

CRITICAL ISSUE:
[Please describe the urgent issue affecting operations]

Impact:
[Describe how this affects your work/users]

Steps Taken:
[What have you tried to resolve this?]

Contact: [Your phone number for immediate callback if needed]`);
            
            const mailtoLink = `mailto:hadi.karkaba@gmail.com?subject=${subject}&body=${body}`;
            window.open(mailtoLink, '_blank');
            
            // Close all modals
            document.querySelectorAll('.modal-overlay').forEach(modal => modal.remove());
            
            showNotification('Emergency email sent. You should receive a response within 1 hour.', 'warning');
        }
        
        function requestContactBack() {
            // Show the hidden contact info when user requests contact back
            const hiddenInfo = document.getElementById('hiddenContactInfo');
            if (hiddenInfo) {
                hiddenInfo.classList.remove('hidden');
            }
            
            // Create request contact back modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-purple-200 dark:border-purple-700">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-phone-alt text-3xl text-white"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Request HK Contact</h3>
                        <p class="text-gray-600 dark:text-gray-400">Request a direct callback from HK AI LAB support team</p>
                    </div>
                    
                    <form id="contactRequestForm" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                <i class="fas fa-user mr-2 text-purple-500"></i>Your Name
                            </label>
                            <input type="text" id="requestName" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Enter your full name" value="${currentUser ? currentUser.username : ''}" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                <i class="fas fa-phone mr-2 text-green-500"></i>Your Phone Number
                            </label>
                            <input type="tel" id="requestPhone" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="+1234567890" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                <i class="fas fa-envelope mr-2 text-blue-500"></i>Email Address
                            </label>
                            <input type="email" id="requestEmail" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="your@email.com" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                <i class="fas fa-clock mr-2 text-orange-500"></i>Preferred Contact Time
                            </label>
                            <select id="requestTime" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                                <option value="">Select preferred time</option>
                                <option value="asap">As soon as possible</option>
                                <option value="morning">Morning (9 AM - 12 PM)</option>
                                <option value="afternoon">Afternoon (12 PM - 6 PM)</option>
                                <option value="evening">Evening (6 PM - 9 PM)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                <i class="fas fa-comment mr-2 text-indigo-500"></i>Reason for Contact (Optional)
                            </label>
                            <textarea id="requestReason" rows="3" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none" placeholder="Brief description of what you need help with..."></textarea>
                        </div>
                        
                        <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
                            <div class="text-sm text-purple-700 dark:text-purple-300">
                                <div class="font-semibold mb-2">📞 What happens next:</div>
                                <ul class="text-xs space-y-1">
                                    <li>• We'll review your request within 2-4 hours</li>
                                    <li>• HK will contact you at your preferred time</li>
                                    <li>• You'll receive an email confirmation</li>
                                    <li>• Our team will provide personalized assistance</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">
                                <i class="fas fa-times mr-2"></i>Cancel
                            </button>
                            <button type="submit" class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white rounded-lg font-semibold transition-all duration-200 transform hover:scale-105">
                                <i class="fas fa-paper-plane mr-2"></i>Send Request
                            </button>
                        </div>
                        
                        <!-- Direct Contact Info -->
                        <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900 rounded-lg border border-yellow-200 dark:border-yellow-700">
                            <div class="text-sm text-yellow-700 dark:text-yellow-300 text-center">
                                <div class="font-semibold mb-1">📧 Direct Contact:</div>
                                <div class="font-mono text-yellow-800 dark:text-yellow-200 select-all">hadi.karkaba@gmail.com</div>
                                <div class="text-xs mt-1 opacity-75">You can also email directly for faster response</div>
                            </div>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up form handler
            document.getElementById('contactRequestForm').addEventListener('submit', handleContactRequest);
            
            // Focus on name field
            setTimeout(() => {
                document.getElementById('requestName').focus();
            }, 100);
        }
        
        function handleContactRequest(event) {
            event.preventDefault();
            
            const name = document.getElementById('requestName').value.trim();
            const phone = document.getElementById('requestPhone').value.trim();
            const email = document.getElementById('requestEmail').value.trim();
            const time = document.getElementById('requestTime').value;
            const reason = document.getElementById('requestReason').value.trim();
            
            // Validation
            if (!name || !phone || !email || !time) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showNotification('Please enter a valid email address', 'error');
                return;
            }
            
            // Phone validation (basic)
            const phoneRegex = /^[\+]?[\d\s\-\(\)]{10,}$/;
            if (!phoneRegex.test(phone)) {
                showNotification('Please enter a valid phone number', 'error');
                return;
            }
            
            // Create email to HK
            const subject = encodeURIComponent('HK AI LAB Pro - Contact Request from ' + name);
            const body = encodeURIComponent(`Contact Request - HK AI LAB Pro

Client Information:
Name: ${name}
Phone: ${phone}
Email: ${email}
Preferred Contact Time: ${time}

Platform Information:
User: ${currentUser ? currentUser.username : 'Not logged in'}
Role: ${currentUser ? currentUser.role : 'N/A'}
Request Time: ${new Date().toLocaleString()}

Contact Reason:
${reason || 'No specific reason provided'}

Client Request: Please contact this client directly for support with HK AI LAB Pro platform.

---
This request was submitted through the HK AI LAB Pro contact system.`);
            
            const mailtoLink = `mailto:hadi.karkaba@gmail.com?subject=${subject}&body=${body}`;
            window.open(mailtoLink, '_blank');
            
            // Close modal
            document.querySelector('.fixed.inset-0').remove();
            
            // Show success message
            const successModal = document.createElement('div');
            successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            
            successModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-green-200 dark:border-green-700">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-green-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-check-circle text-3xl text-white"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Request Sent Successfully</h3>
                        <p class="text-gray-600 dark:text-gray-400">Your contact request has been submitted to HK AI LAB support team</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg border border-green-200 dark:border-green-700">
                            <div class="text-sm text-green-700 dark:text-green-300">
                                <div class="font-semibold mb-2">✅ Request Details:</div>
                                <div>• Name: ${name}</div>
                                <div>• Phone: ${phone}</div>
                                <div>• Email: ${email}</div>
                                <div>• Preferred Time: ${time}</div>
                                <div>• Submitted: ${new Date().toLocaleString()}</div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
                            <div class="text-sm text-blue-700 dark:text-blue-300">
                                <div class="font-semibold mb-2">📋 Next Steps:</div>
                                <ol class="text-xs space-y-1 list-decimal list-inside">
                                    <li>Request has been sent to hadi.karkaba@gmail.com</li>
                                    <li>You'll receive confirmation within 2-4 hours</li>
                                    <li>HK will contact you at your preferred time</li>
                                    <li>Check your email for updates</li>
                                </ol>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 dark:bg-yellow-900 p-3 rounded-lg border border-yellow-200 dark:border-yellow-700">
                            <div class="text-sm text-yellow-700 dark:text-yellow-300">
                                <div class="font-semibold mb-1">📧 Direct Contact Available:</div>
                                <div class="font-mono text-yellow-800 dark:text-yellow-200 text-center">hadi.karkaba@gmail.com</div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="this.closest('.fixed').remove()" class="w-full mt-6 px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold transition-colors">
                        <i class="fas fa-check mr-2"></i>Perfect, Thank You!
                    </button>
                </div>
            `;
            
            document.body.appendChild(successModal);
            
            showNotification('Contact request sent successfully! HK will reach out to you soon.', 'success');
        }

        // ═══════════════════════════════════════════════════════════════
        // 🚀 FREE TRIAL REQUEST FUNCTIONALITY
        // ═══════════════════════════════════════════════════════════════
        
        function showFreeTrialModal() {
            // Create compact futuristic free trial modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-purple-200 dark:border-purple-700 relative overflow-hidden">
                    <!-- Futuristic Background -->
                    <div class="absolute inset-0 bg-gradient-to-br from-purple-900/20 via-blue-900/20 to-cyan-900/20 pointer-events-none"></div>
                    
                    <!-- Animated particles -->
                    <div class="absolute inset-0 pointer-events-none overflow-hidden">
                        <div class="absolute top-2 left-2 w-1 h-1 bg-purple-400 rounded-full animate-ping opacity-60"></div>
                        <div class="absolute top-3 right-3 w-1 h-1 bg-cyan-400 rounded-full animate-pulse opacity-40"></div>
                        <div class="absolute bottom-2 left-2 w-0.5 h-0.5 bg-blue-400 rounded-full animate-bounce opacity-50"></div>
                        <div class="absolute bottom-2 right-2 w-1 h-1 bg-indigo-400 rounded-full animate-ping opacity-30"></div>
                    </div>
                    
                    <!-- Close Button -->
                    <button onclick="this.closest('.fixed').remove()" class="absolute top-2 right-2 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-110 flex items-center justify-center z-10" title="Close">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                    
                    <div class="relative p-4">
                        <!-- Compact Header -->
                        <div class="text-center mb-4">
                            <div class="relative mx-auto mb-3 w-12 h-12">
                                <!-- Simple orbital ring -->
                                <div class="absolute inset-0 border border-purple-300 rounded-full animate-spin opacity-30" style="animation-duration: 8s;"></div>
                                
                                <!-- Central rocket icon -->
                                <div class="relative w-12 h-12 mx-auto bg-gradient-to-br from-purple-500 via-blue-500 to-cyan-500 rounded-lg flex items-center justify-center shadow-lg">
                                    <i class="fas fa-rocket text-lg text-white"></i>
                                </div>
                            </div>
                            
                            <h3 class="text-xl font-bold bg-gradient-to-r from-purple-600 via-blue-600 to-cyan-600 bg-clip-text text-transparent mb-2">
                                🚀 AI Platform Access
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                                1-month FREE access to HK AI LAB Pro
                            </p>
                            
                            <!-- Compact AI Features -->
                            <div class="grid grid-cols-4 gap-1 mb-3">
                                <div class="bg-red-100 dark:bg-red-900 p-1 rounded text-center">
                                    <i class="fas fa-heartbeat text-red-600 dark:text-red-400 text-sm"></i>
                                    <div class="text-xs text-red-700 dark:text-red-300">Medical</div>
                                </div>
                                <div class="bg-blue-100 dark:bg-blue-900 p-1 rounded text-center">
                                    <i class="fas fa-brain text-blue-600 dark:text-blue-400 text-sm"></i>
                                    <div class="text-xs text-blue-700 dark:text-blue-300">Research</div>
                                </div>
                                <div class="bg-green-100 dark:bg-green-900 p-1 rounded text-center">
                                    <i class="fas fa-chart-line text-green-600 dark:text-green-400 text-sm"></i>
                                    <div class="text-xs text-green-700 dark:text-green-300">Finance</div>
                                </div>
                                <div class="bg-purple-100 dark:bg-purple-900 p-1 rounded text-center">
                                    <i class="fas fa-user-md text-purple-600 dark:text-purple-400 text-sm"></i>
                                    <div class="text-xs text-purple-700 dark:text-purple-300">Chat</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Compact Table Form -->
                        <form id="freeTrialForm" class="space-y-2">
                            <table class="w-full text-xs">
                                <tbody>
                                    <tr>
                                        <td class="text-gray-700 dark:text-gray-300 font-bold py-1 pr-2 w-20">
                                            <i class="fas fa-user mr-1 text-purple-500"></i>Name
                                        </td>
                                        <td class="py-1">
                                            <input type="text" id="trialName" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-1 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Full name" required>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-gray-700 dark:text-gray-300 font-bold py-1 pr-2">
                                            <i class="fas fa-envelope mr-1 text-blue-500"></i>Email
                                        </td>
                                        <td class="py-1">
                                            <input type="email" id="trialEmail" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-1 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="your@email.com" required>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-gray-700 dark:text-gray-300 font-bold py-1 pr-2">
                                            <i class="fas fa-phone mr-1 text-green-500"></i>Phone
                                        </td>
                                        <td class="py-1">
                                            <input type="tel" id="trialPhone" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-1 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="+1234567890" required>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-gray-700 dark:text-gray-300 font-bold py-1 pr-2">
                                            <i class="fas fa-briefcase mr-1 text-orange-500"></i>Role
                                        </td>
                                        <td class="py-1">
                                            <input type="text" id="trialOrganization" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-1 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Hospital, Research..." required>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-gray-700 dark:text-gray-300 font-bold py-1 pr-2">
                                            <i class="fas fa-target mr-1 text-cyan-500"></i>Use Case
                                        </td>
                                        <td class="py-1">
                                            <select id="trialUseCase" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-1 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                                                <option value="">Select interest</option>
                                                <option value="medical">🏥 Medical AI</option>
                                                <option value="research">🔬 Research AI</option>
                                                <option value="finance">💰 Finance AI</option>
                                                <option value="general">🌟 General AI</option>
                                                <option value="enterprise">🏢 Enterprise</option>
                                                <option value="education">🎓 Education</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-gray-700 dark:text-gray-300 font-bold py-1 pr-2 align-top">
                                            <i class="fas fa-comment-dots mr-1 text-indigo-500"></i>Needs
                                        </td>
                                        <td class="py-1">
                                            <textarea id="trialNeeds" rows="2" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-1 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none" placeholder="What AI features would be valuable?"></textarea>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <!-- Compact Benefits -->
                            <div class="bg-gradient-to-r from-purple-50 to-cyan-50 dark:from-purple-900 dark:to-cyan-900 p-2 rounded border border-purple-200 dark:border-purple-700">
                                <h4 class="font-bold text-purple-800 dark:text-purple-300 mb-1 text-xs flex items-center">
                                    <i class="fas fa-crown mr-1 text-yellow-500"></i>
                                    Platform Includes:
                                </h4>
                                <div class="grid grid-cols-2 gap-1 text-xs text-purple-700 dark:text-purple-300">
                                    <div class="flex items-center">
                                        <i class="fas fa-check mr-1 text-green-500 text-xs"></i>
                                        30 days full access
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-check mr-1 text-green-500 text-xs"></i>
                                        All AI modules
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-check mr-1 text-green-500 text-xs"></i>
                                        Priority support
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-check mr-1 text-green-500 text-xs"></i>
                                        Export capabilities
                                    </div>
                                </div>
                                
                                <div class="mt-2 p-1 bg-yellow-100 dark:bg-yellow-900 rounded text-center">
                                    <div class="text-xs text-yellow-700 dark:text-yellow-300">
                                        <i class="fas fa-star mr-1 text-yellow-500"></i>
                                        <span><strong>FREE</strong> - Normal price $20/month</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Compact Agreement -->
                            <div class="flex items-start space-x-1">
                                <input type="checkbox" id="trialAgreement" class="mt-1" required>
                                <label for="trialAgreement" class="text-xs text-gray-600 dark:text-gray-400">
                                    I agree to terms and understand this is a fully operational AI platform.
                                </label>
                            </div>
                            
                            <div class="flex space-x-2 pt-2">
                                <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 px-3 py-2 text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-sm font-semibold transition-colors">
                                    <i class="fas fa-times mr-1"></i>Later
                                </button>
                                <button type="submit" class="flex-1 px-3 py-2 bg-gradient-to-r from-purple-500 to-cyan-500 hover:from-purple-600 hover:to-cyan-600 text-white rounded text-sm font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg">
                                    <i class="fas fa-rocket mr-1"></i>Request Access
                                </button>
                            </div>
                            
                            <!-- Compact Contact -->
                            <div class="mt-2 p-2 bg-gray-50 dark:bg-gray-700 rounded text-center">
                                <div class="text-xs text-gray-700 dark:text-gray-300">
                                    <div class="font-semibold">📧 Questions?</div>
                                    <div class="font-mono text-blue-600 dark:text-blue-400 select-all">hadi.karkaba@gmail.com</div>
                                    <div class="opacity-75">Response: 2-4 hours</div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up form handler
            document.getElementById('freeTrialForm').addEventListener('submit', handleFreeTrialRequest);
            
            // Focus on name field
            setTimeout(() => {
                document.getElementById('trialName').focus();
            }, 100);
            
            // Auto close when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function handleFreeTrialRequest(event) {
            event.preventDefault();
            
            const name = document.getElementById('trialName').value.trim();
            const email = document.getElementById('trialEmail').value.trim();
            const phone = document.getElementById('trialPhone').value.trim();
            const organization = document.getElementById('trialOrganization').value.trim();
            const useCase = document.getElementById('trialUseCase').value;
            const needs = document.getElementById('trialNeeds').value.trim();
            const agreement = document.getElementById('trialAgreement').checked;
            
            // Validation
            if (!name || !email || !phone || !organization || !useCase) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            if (!agreement) {
                showNotification('Please accept the terms to continue', 'error');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showNotification('Please enter a valid email address', 'error');
                return;
            }
            
            // Phone validation
            const phoneRegex = /^[\+]?[\d\s\-\(\)]{10,}$/;
            if (!phoneRegex.test(phone)) {
                showNotification('Please enter a valid phone number', 'error');
                return;
            }
            
            // Create beta access request email
            const subject = encodeURIComponent('🚀 HK AI LAB Pro - Beta Access Request from ' + name);
            const body = encodeURIComponent(`BETA ACCESS REQUEST - HK AI LAB PRO
================================================

🚀 NEW BETA ACCESS REQUEST

Client Information:
═══════════════════
• Name: ${name}
• Email: ${email}  
• Phone: ${phone}
• Organization/Role: ${organization}

Platform Details:
═════════════════
• Primary Use Case: ${useCase}
• Specific Needs: ${needs || 'Not specified'}
• Request Date: ${new Date().toLocaleString()}
• Source: HK AI LAB Pro Login Platform

Beta Access Request:
═══════════════════
This user is requesting 1-month FREE beta access to HK AI LAB Pro platform including:

✅ Full platform access (30 days)
✅ All AI modules (Medical, Research, Finance, Calculator)  
✅ Live AI Chat with specialists
✅ Export & sharing capabilities
✅ Priority support & onboarding
✅ Early access to new features

RECOMMENDED ACTION:
1. Review client information
2. Create beta user account with 30-day access
3. Send welcome email with credentials
4. Schedule onboarding call if enterprise client
5. Add to beta feedback program

VALUE ASSESSMENT:
• Use Case: ${useCase}
• Organization: ${organization}
• Potential: ${organization.toLowerCase().includes('hospital') || organization.toLowerCase().includes('research') || organization.toLowerCase().includes('university') ? 'HIGH - Healthcare/Research' : organization.toLowerCase().includes('enterprise') || organization.toLowerCase().includes('company') ? 'MEDIUM - Business' : 'STANDARD'}

FOLLOW-UP:
Send beta access credentials to: ${email}
Schedule intro call if high-value prospect.

This is an automated beta request from HK AI LAB Pro platform.
Response SLA: Within 4 hours for beta requests.`);
            
            const mailtoLink = `mailto:hadi.karkaba@gmail.com?subject=${subject}&body=${body}`;
            window.open(mailtoLink, '_blank');
            
            // Close modal
            document.querySelector('.fixed.inset-0').remove();
            
            // Show success message with futuristic design
            showFreeTrialSuccessModal(name, email, useCase);
        }
        
        function showFreeTrialSuccessModal(name, email, useCase) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-green-200 dark:border-green-700 relative overflow-hidden">
                    <!-- Animated success background -->
                    <div class="absolute inset-0 bg-gradient-to-br from-green-900/10 via-blue-900/10 to-purple-900/10 pointer-events-none"></div>
                    
                    <!-- Floating particles -->
                    <div class="absolute inset-0 pointer-events-none overflow-hidden">
                        <div class="absolute top-4 left-4 w-2 h-2 bg-green-400 rounded-full animate-ping opacity-60"></div>
                        <div class="absolute top-8 right-8 w-1.5 h-1.5 bg-blue-400 rounded-full animate-pulse opacity-40"></div>
                        <div class="absolute bottom-6 left-6 w-1 h-1 bg-purple-400 rounded-full animate-bounce opacity-50"></div>
                        <div class="absolute bottom-4 right-4 w-2 h-2 bg-cyan-400 rounded-full animate-ping opacity-30"></div>
                    </div>
                    
                    <div class="relative p-8">
                        <div class="text-center mb-6">
                            <!-- Success animation -->
                            <div class="relative mx-auto mb-6">
                                <!-- Orbital success rings -->
                                <div class="absolute inset-0 w-20 h-20 border-2 border-green-300 rounded-full animate-spin opacity-30" style="animation-duration: 4s;"></div>
                                <div class="absolute inset-2 w-16 h-16 border-2 border-blue-300 rounded-full animate-spin opacity-40" style="animation-duration: 3s; animation-direction: reverse;"></div>
                                
                                <!-- Central check icon -->
                                <div class="relative w-20 h-20 mx-auto bg-gradient-to-br from-green-500 via-blue-500 to-purple-500 rounded-xl flex items-center justify-center shadow-lg shadow-green-500/50">
                                    <i class="fas fa-check-circle text-4xl text-white animate-bounce"></i>
                                </div>
                                
                                <!-- Success particles -->
                                <div class="absolute -top-2 -right-2 w-3 h-3 bg-yellow-400 rounded-full animate-ping"></div>
                                <div class="absolute -bottom-2 -left-2 w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            </div>
                            
                            <h3 class="text-2xl font-bold bg-gradient-to-r from-green-600 via-blue-600 to-purple-600 bg-clip-text text-transparent mb-3">
                                🎉 Request Submitted Successfully!
                            </h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-4">
                                Your beta access request has been sent to our team
                            </p>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg border border-green-200 dark:border-green-700">
                                <div class="text-sm text-green-700 dark:text-green-300">
                                    <div class="font-semibold mb-2">✅ Request Details:</div>
                                    <div>• Name: ${name}</div>
                                    <div>• Email: ${email}</div>
                                    <div>• Interest: ${useCase}</div>
                                    <div>• Submitted: ${new Date().toLocaleString()}</div>
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
                                <div class="text-sm text-blue-700 dark:text-blue-300">
                                    <div class="font-semibold mb-2">🚀 What happens next:</div>
                                    <ol class="text-xs space-y-1 list-decimal list-inside">
                                        <li>Our team reviews your request (usually 2-4 hours)</li>
                                        <li>You'll receive beta access credentials via email</li>
                                        <li>Enjoy 30 days of full platform access</li>
                                        <li>Optional onboarding call for enterprise users</li>
                                        <li>Share feedback to help us improve</li>
                                    </ol>
                                </div>
                            </div>
                            
                            <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
                                <div class="text-sm text-purple-700 dark:text-purple-300">
                                    <div class="font-semibold mb-2">💎 Beta Access Value:</div>
                                    <div class="text-xs space-y-1">
                                        <div>• Regular Price: $299/month</div>
                                        <div>• Your Beta Access: <strong>FREE for 30 days</strong></div>
                                        <div>• Total Value: <strong>$299 saved!</strong></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 dark:bg-yellow-900 p-3 rounded-lg border border-yellow-200 dark:border-yellow-700">
                                <div class="text-sm text-yellow-700 dark:text-yellow-300 text-center">
                                    <div class="font-semibold mb-1">📧 Direct Contact:</div>
                                    <div class="font-mono text-yellow-800 dark:text-yellow-200 select-all">hadi.karkaba@gmail.com</div>
                                    <div class="text-xs mt-1 opacity-75">Questions? Email us directly!</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 mt-6">
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 bg-gradient-to-r from-green-500 via-blue-500 to-purple-500 hover:from-green-600 hover:via-blue-600 hover:to-purple-600 text-white rounded-lg font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg">
                                <i class="fas fa-thumbs-up mr-2"></i>Awesome, Thanks!
                            </button>
                            <button onclick="tryDemoMode(); this.closest('.fixed').remove();" class="flex-1 px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">
                                <i class="fas fa-play mr-2"></i>Try Demo Now
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            showNotification('🎉 Beta access request sent! Check your email for updates.', 'success');
        }
        
        function tryDemoMode() {
            // Close any open modals
            document.querySelectorAll('.modal-overlay').forEach(modal => modal.remove());
            
            // Fill demo credentials
            document.getElementById('username').value = 'demo';
            document.getElementById('password').value = 'Demo123';
            
            showNotification('🚀 Demo credentials loaded! Click "Access AI Platform" to explore.', 'info');
        }

        // Export functions for global access
        window.HKAILab = {
            showModule,
            showNotification,
            showContactModal,
            showFreeTrialModal,
            isAIAvailable: isAIAvailable(),
            version: '2.0.0-pro'
        };

    </script>



</body></html>